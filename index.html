<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Qube</title>
    <link rel="icon" href="icons.png" sizes="any">
    <link rel="apple-touch-icon" href="icon.png">
    
    <!-- PWA settings -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Qube">
    <meta name="theme-color" content="#f0f9ff">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;</script>

    <style>
        * {
          box-sizing: border-box;
             }
        /* --- Base Variables from Qube --- */
        :root {
            --bg-primary: #f0f9ff;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e0f2fe;
            --bg-welcome: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent-primary: #0ea5e9;
            --accent-primary-hover: #0284c7;
            --accent-primary-shadow: rgba(14, 165, 233, 0.3);
            --border-color: #cbd5e1;
            --modal-bg: rgba(0, 0, 0, 0.5);
            
            /* --- Integrated Variables from BEI --- */
            --button-bg-default: #f1f5f9;
            --button-text-default: #334155;
            --button-border-default: #cbd5e1;
            --progress-bar-bg: var(--accent-primary);
            --feedback-bg: #f8fafc;
            --feedback-border: #e2e8f0;
            --correct-feedback-text: #15803d;
            --correct-feedback-border: #22c55e;
            --incorrect-feedback-text: #b91c1c;
            --incorrect-feedback-border: #ef4444;
            --correct-option-bg: #dcfce7;
            --incorrect-option-bg: #fee2e2;
            --score-color: #0c4a6e;
            --score-comment-color: #0369a1;
            --themed-text-color: #0c4a6e;
            --ai-tutor-user-bg: #e0f2fe;
            --ai-tutor-ai-bg: #f1f5f9;

            /* Safe Area Insets */
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 1rem);
        }

        body.dark-mode {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #0c4a6e;
            --bg-welcome: #1e293b;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --accent-primary: #38bdf8;
            --accent-primary-hover: #0ea5e9;
            --accent-primary-shadow: rgba(56, 189, 248, 0.3);
            --border-color: #475569;
            --modal-bg: rgba(0, 0, 0, 0.7);

            /* --- Integrated Dark Variables from BEI --- */
            --button-bg-default: #334155;
            --button-text-default: #e2e8f0;
            --button-border-default: #475569;
            --progress-bar-bg: var(--accent-primary);
            --feedback-bg: #334155;
            --feedback-border: #475569;
            --correct-feedback-text: #a7f3d0;
            --correct-feedback-border: #4ade80;
            --incorrect-feedback-text: #fecaca;
            --incorrect-feedback-border: #f87171;
            --correct-option-bg: #14532d;
            --incorrect-option-bg: #7f1d1d;
            --score-color: #e0f2fe;
            --score-comment-color: #7dd3fc;
            --themed-text-color: #e0f2fe;
            --ai-tutor-user-bg: #0c4a6e;
            --ai-tutor-ai-bg: #334155;
        }
        
        body {
            margin: 0;
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow: hidden; /* Prevent body scroll */
        }

        /* Splash Screen */
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.95); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-primary);
            display: grid;
            place-items: center;
            z-index: 9999;
            transition: opacity 0.9s ease-out;
            will-change: opacity;
        }
        .splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .splash-logo-container {
            position: relative;
            width: 228px;
            height: 228px;
        }
        .splash-logo-container img, .splash-logo-container h1 {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            margin: 0;
            opacity: 0;
            animation: fadeIn 0.6s 0.2s ease-out forwards;
        }
        .splash-logo-container img {
            width: 100%;
            height: 100%;
        }
        .splash-logo-container h1 {
            display: none;
        }
        .splash-logo-container img:not([src]) + h1,
        .splash-logo-container img[src=""] + h1 {
            display: block;
        }

        /* --- Qube Base Layout --- */
        .main-container { display: flex; height: 100vh; width: 100%; }
        #sidebar { width: 280px; background-color: var(--bg-secondary); border-right: 1px solid var(--border-color); padding: 20px; display: flex; flex-direction: column; transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease; transform: translateX(-100%); position: fixed; top: 0; left: 0; height: 100%; z-index: 1000; padding-top: var(--safe-area-inset-top); }
        #sidebar.open { transform: translateX(0); box-shadow: 0 0 40px rgba(0,0,0,0.2); }
        
        #mainContent { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; transition: margin-left 0.3s ease; }
        body.sidebar-open-desktop #mainContent { margin-left: 280px; }
        
        #mainContent > header { 
            position: relative; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 20px; 
            padding-top: calc(20px + var(--safe-area-inset-top)); 
            min-height: 80px;
            gap: 1rem;
        }
        #headerLeft, #headerRight {
        flex-shrink: 0; /* ãƒœã‚¿ãƒ³ã®ã‚ã‚‹å·¦å³ã®é ˜åŸŸã¯ç¸®ã¾ãªã„ã‚ˆã†ã«å›ºå®š */
        display: flex;
        align-items: center;
        gap: 0.5rem;
        }
    
        #headerCenter {
            flex-grow: 1; /* ä¸­å¤®ã®é ˜åŸŸã¯åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒšãƒ¼ã‚¹ã„ã£ã±ã„ã«åºƒãŒã‚‹ */
            text-align: center;
        
            /* æœ€ã‚‚é‡è¦ãªè¨­å®šï¼šã“ã‚Œã«ã‚ˆã‚Šflexã‚¢ã‚¤ãƒ†ãƒ ãŒã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¹…ã‚ˆã‚Šå°ã•ããªã‚‹ã“ã¨ã‚’è¨±å¯ */
            min-width: 0;
        }
        #projectTitle {
            font-weight: 700;
            font-size: 1.875rem;
            line-height: 1.25;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            max-width: 100%;
            vertical-align: middle;
        }
        
        #screenContainer { flex-grow: 1; overflow-y: auto; padding: 20px; padding-bottom: calc(20px + var(--safe-area-inset-bottom)); display: flex; flex-direction: column; }

        @media (max-width: 767px) { 
            body.sidebar-open-desktop #mainContent { margin-left: 0; }
            #projectTitle { font-size: 1.25rem; }
        }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
        .sidebar-overlay.active { display: block; }

        .screen { 
            display: none; 
            flex-direction: column; 
            width: 100%; 
        }
        .screen.active { 
            display: flex;
            flex-grow: 1;
        }

        #projectStartScreen.active {
            justify-content: center;
        }

        .project-item { position: relative; display: flex; align-items: center; justify-content: space-between; padding: 8px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        .project-item:hover { background-color: var(--bg-tertiary); }
        .project-item.active { background-color: var(--bg-tertiary); font-weight: bold; }
        .project-item.dragging { opacity: 0.7; background-color: var(--accent-primary); color: white; box-shadow: 0 8px 20px rgba(0,0,0,0.2); z-index: 10; }
        .project-name { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .project-menu-btn { padding: 4px; border-radius: 50%; flex-shrink: 0; }
        .project-menu-btn:hover { background-color: rgba(0,0,0,0.1); }
        .project-menu { position: absolute; top: 100%; right: 5px; background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 1100; display: none; min-width: 120px; margin-top: 4px;}
        .project-menu.show { display: block; }
        .project-menu-item { padding: 8px 16px; cursor: pointer; display: flex; align-items: center;}
        .project-menu-item:hover { background-color: var(--bg-tertiary); }
        .project-menu-item.delete { color: #ef4444; }

        .btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; border: none; }
        .btn-primary { background-color: var(--accent-primary); color: white; box-shadow: 0 4px 12px var(--accent-primary-shadow); }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-primary-hover); transform: translateY(-2px); }
        .btn-lg { padding: 15px 30px; font-size: 1.1rem; }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .btn-sm { padding: 4px 12px; font-size: 0.875rem; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; }
        .form-group textarea { min-height: 120px; resize: vertical; }
        #fillInBlankInput {
            width: 100%;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1.2rem;
            text-align: center;
        }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-bg); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--bg-secondary); padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); max-width: 400px; width: 90%; transform: translateY(-20px) scale(0.95); transition: transform 0.3s ease, background-color 0.3s ease; }
        .modal.show .modal-content { transform: translateY(0) scale(1); }
        .modal-title { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 20px; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
        .modal-button { padding: 10px 25px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; border: none; }
        .modal-button.create, .modal-button.save { background-color: var(--accent-primary); color: white; }
        .modal-button.create:hover, .modal-button.save:hover { background-color: var(--accent-primary-hover); }
        .modal-button.delete, .modal-button.reset { background-color: #ef4444; color: white; }
        .modal-button.delete:hover, .modal-button.reset:hover { background-color: #dc2626; }
        .modal-button.cancel { background-color: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); }
        .modal-button.cancel:hover { background-color: var(--border-color); }

        #tosModal .modal-content { max-width: 500px; }
        #tosContent { max-height: 30vh; overflow-y: auto; background-color: var(--bg-primary); padding: 1rem; border-radius: 8px; font-size: 0.9rem; color: var(--text-secondary); border: 1px solid var(--border-color); }

        #addToHomeScreenPopup {
            display: none;
            position: fixed;
            bottom: calc(20px + var(--safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 4000;
            width: 90%;
            max-width: 400px;
        }
        #addToHomeScreenPopup::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid var(--bg-secondary);
        }
        #closeAddToHomeScreen {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 24px;
        }

        #welcomeScreen, #projectStartScreen .start-screen-container {
            background-color: var(--bg-welcome);
            transition: background-color 0.3s ease;
        }
        .start-screen-container { 
            max-width: 600px; 
            text-align: center; 
            margin: auto;
            padding: 3rem;
            border-radius: 1rem;
        }
        .start-screen-container h2 { color: var(--themed-text-color); }
        .start-screen-container .form-group select {
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2020%2020%22%20fill%3D%22%2364748b%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20d%3D%22M5.293%207.293a1%201%200%20011.414%200L10%2010.586l3.293-3.293a1%201%200%20111.414%201.414l-4%204a1%201%200%2001-1.414%200l-4-4a1%201%200%20010-1.414z%22%20clip-rule%3D%22evenodd%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2em;
        }
        #fileDropArea { border-color: var(--border-color); }
        #fileDropArea.dragover { border-color: var(--accent-primary); background-color: var(--bg-tertiary); }
        #filePreviewContainer { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 1rem; }
        .file-preview-item { position: relative; display: flex; flex-direction: column; align-items: center; }
        .file-preview-item img, .file-preview-item canvas { max-height: 100px; border-radius: 8px; }
        .file-preview-item .file-name { font-size: 0.8rem; color: var(--text-secondary); max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .remove-file-btn { position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; border: 2px solid var(--bg-secondary); }
        .divider { text-align: center; margin: 1.5rem 0; color: var(--text-secondary); display: flex; align-items: center; gap: 1rem; }
        .divider::before, .divider::after { content: ''; height: 1px; background-color: var(--border-color); flex-grow: 1; }

        .quiz-container { max-width: 800px; margin-left: auto; margin-right: auto; width: 100%; }
        #quizHeader { display: flex; flex-direction: column; gap: 1rem; }
        #quizTitleArea { display: flex; justify-content: center; align-items: center; min-height: 40px; }
        #quizTitle { font-size: 1.5rem; font-weight: 700; color: var(--themed-text-color); text-align: center; line-height: 1.3; }
        .progress-container { width: 100%; background-color: #e2e8f0; border-radius: 10px; height: 15px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        .progress-bar { height: 100%; width: 0%; background-color: var(--progress-bar-bg); border-radius: 10px; transition: width 0.4s ease-in-out; }
        .progress-text { font-size: 1rem; font-weight: 600; color: var(--text-primary); transition: color 0.3s ease; text-align: center; }
        .question-area { min-height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: background-color 0.3s ease; text-align: left; margin-top: 1.5rem;}
        #questionImage { max-height: 200px; border-radius: 8px; margin-top: 1rem; }
        .question-text { font-size: 1.25rem; font-weight: 500; color: var(--themed-text-color); margin-bottom: 10px; transition: color 0.3s ease; width: 100%; text-align:center; }
        #longContentBox { display: none; width: 100%; max-height: 250px; overflow-y: auto; background-color: var(--button-bg-default); border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; white-space: pre-wrap; font-family: inherit; font-size: 1rem; }
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 15px; }
        .options-grid.options-grid-full-width { grid-template-columns: 1fr; }
        .option-button { background-color: var(--button-bg-default); color: var(--button-text-default); padding: 14px 20px; border-radius: 12px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; border: 2px solid var(--button-border-default); text-align: left; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08); line-height: 1.5; }
        .option-button:hover:not(:disabled) { background-color: var(--border-color); transform: translateY(-3px) scale(1.01); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.12); }
        .option-button.correct { background-color: var(--correct-option-bg); border-color: var(--correct-feedback-border); color: var(--correct-feedback-text); }
        .option-button.incorrect { background-color: var(--incorrect-option-bg); border-color: var(--incorrect-feedback-border); color: var(--incorrect-feedback-text); }
        .option-button.selected { border-color: var(--accent-primary); background-color: var(--bg-tertiary); }
        .option-button:disabled { cursor: not-allowed; }
        .sorting-item.dragging { opacity: 0.5; }
        .sorting-container { display: flex; flex-direction: column; gap: 1rem; }
        .sorting-box { display: flex; flex-wrap: wrap; gap: 10px; padding: 1rem; border-radius: 12px; border: 2px dashed var(--border-color); min-height: 70px; }
        .feedback-message { margin-top: 1.5rem; font-size: 1rem; text-align: left; padding: 1rem 1.5rem; border-radius: 12px; background-color: var(--feedback-bg); border: 1px solid var(--feedback-border); box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); line-height: 1.5; }
        .feedback-message.correct-feedback { color: var(--correct-feedback-text); border-color: var(--correct-feedback-border); }
        .feedback-message.incorrect-feedback { color: var(--incorrect-feedback-text); border-color: var(--incorrect-feedback-border); }
        .feedback-header { display: flex; justify-content: space-between; align-items: center; gap: 15px; min-height: 24px; flex-wrap: wrap; }
        #feedbackResult { flex-grow: 1; }
        .feedback-result strong { font-size: 1.1rem; }
        .explanation-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding-top 0.4s ease-out, margin-top 0.4s ease-out; padding-top: 0; margin-top: 0; }
        .explanation-content.show { max-height: 200px; padding-top: 10px; margin-top: 10px; border-top: 1px solid var(--border-color); }
        .explanation-text { font-weight: 400; font-size: 0.95rem; }
        .toggle-explanation-button { background-color: var(--accent-primary); color: white; padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease; flex-shrink: 0; border: none; }
        .navigation-buttons { display: flex; justify-content: flex-end; margin-top: 20px; flex-wrap: wrap; gap: 10px; }
        
        .result-container { text-align: center; max-width: 600px; margin: 2rem auto; }
        .score-area { font-size: 1.8rem; font-weight: 800; color: var(--score-color); margin-top: 25px; }
        .score-comment { font-size: 1.3rem; font-weight: 700; color: var(--score-comment-color); margin-top: 10px; }
        .confetti-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; pointer-events: none; z-index: 0; }
        .confetti { position: absolute; width: 10px; height: 10px; background-color: #f06; opacity: 1; }

        #settingsScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #settingsScreen.active {
            opacity: 1;
            visibility: visible;
        }
        #settingsScreen .settings-container, #editQuizzesModal .modal-content {
            background-color: var(--bg-secondary);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 700px;
            width: 90%;
            transform: translateY(-20px) scale(0.95);
            transition: transform 0.3s ease, background-color 0.3s ease;
            max-height: 85vh;
            overflow-y: auto;
        }
        #settingsScreen.active .settings-container, #editQuizzesModal.show .modal-content {
            transform: translateY(0) scale(1);
        }
        .settings-option { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--border-color); flex-wrap: nowrap; gap: 1rem;}
        .settings-option:last-child { border-bottom: none; }
        .settings-option-label { display: flex; flex-direction: column; align-items: flex-start; flex-grow: 1; min-width: 0; }
        .settings-option-label label { font-size: 1.1rem; color: var(--text-primary); font-weight: 600; }
        .settings-option-label p { font-size: 0.85rem; color: var(--text-secondary); margin: 4px 0 0 0; text-align: left; }
        .theme-colors { display: flex; gap: 10px; }
        .color-circle { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s ease; }
        .color-circle.selected { border-color: var(--accent-primary); }
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; flex-shrink: 0; margin-left: auto; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-primary); }
        input:checked + .slider:before { transform: translateX(26px); }
        
        #settingsScreen select, #soundVolumeSlider {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        #soundVolumeSlider {
            -webkit-appearance: none;
            appearance: none;
            width: 128px;
            height: 8px;
            background: var(--border-color);
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        #soundVolumeSlider:hover { opacity: 1; }
        #soundVolumeSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent-primary);
            cursor: pointer;
            border-radius: 50%;
        }
        #soundVolumeSlider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--accent-primary);
            cursor: pointer;
            border-radius: 50%;
        }

        #editQuizzesModal .modal-content { max-width: 600px; }
        #editQuizList .project-item { padding-left: 0; }
        .drag-handle { touch-action: none; cursor: move; padding: 8px; }
        #editQuizList .project-item.dragging {
            opacity: 0.7;
            background: var(--bg-tertiary);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .tab-button {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            font-weight: 600;
        }
        .tab-button.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }
        #importProjectContainer {
            display: none;
        }

        /* â˜…â˜…â˜… å¤‰æ›´ç®‡æ‰€ START â˜…â˜…â˜… */
        /* --- AI Tutor Styles (MODIFIED FOR STICKY INPUT) --- */
        #aiTutorScreen .quiz-container {
            max-width: 800px;
            display: flex;
            flex-direction: column;
            height: 100%; /* è¦ªè¦ç´ ã®é«˜ã•ã„ã£ã±ã„ã«åºƒã’ã‚‹ */
        }
        

        .ai-tutor-problem-statement {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            text-align: left;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }
        body.dark-mode .ai-tutor-problem-statement {
             box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .ai-tutor-problem-statement p {
            color: var(--text-primary);
            font-size: 1rem;
            line-height: 1.6;
        }
        .ai-tutor-problem-statement .correct-answer {
            font-weight: 700;
            color: var(--correct-feedback-text);
            background-color: var(--correct-option-bg);
            padding: 2px 6px;
            border-radius: 6px;
        }
        #toggleOtherOptionsButton {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            margin-top: 10px;
            background: none;
            border: none;
            padding: 0;
        }
        #otherOptionsContainer {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--button-border-default);
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        #aiTutorChatLog {
            flex-grow: 1; /* åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒšãƒ¼ã‚¹ã‚’ã™ã¹ã¦åŸ‹ã‚ã‚‹ */
            overflow-y: auto; /* å†…å®¹ãŒå¤šã‘ã‚Œã°ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã‚‹ */
            border: 1px solid var(--button-border-default);
            border-radius: 12px;
            padding: 15px;
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background-color: var(--bg-primary);
            margin-bottom: 15px; /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã¨ã®é–“ã«ä½™ç™½ã‚’è¿½åŠ  */
        }
        .chat-message {
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 85%;
            line-height: 1.6;
            color: var(--text-primary);
            word-wrap: break-word;
        }
        .chat-message.user {
            background-color: var(--ai-tutor-user-bg);
            align-self: flex-end;
            border-bottom-right-radius: 3px;
        }
        .chat-message.ai {
            background-color: var(--ai-tutor-ai-bg);
            align-self: flex-start;
            border-bottom-left-radius: 3px;
        }
        .chat-message.loading {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .dot-flashing {
            position: relative;
            width: 5px; height: 5px;
            border-radius: 5px;
            background-color: var(--text-secondary);
            color: var(--text-secondary);
            animation: dotFlashing 1s infinite linear alternate;
            animation-delay: .5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: ''; display: inline-block; position: absolute; top: 0;
        }
        .dot-flashing::before {
            left: -10px; width: 5px; height: 5px; border-radius: 5px;
            background-color: var(--text-secondary); color: var(--text-secondary);
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 0s;
        }
        .dot-flashing::after {
            left: 10px; width: 5px; height: 5px; border-radius: 5px;
            background-color: var(--text-secondary); color: var(--text-secondary);
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 1s;
        }
        @keyframes dotFlashing {
            0% { background-color: var(--text-secondary); }
            50%, 100% { background-color: rgba(156, 163, 175, 0.2); }
        }
        #aiTutorInputForm {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            flex-shrink: 0; /* ã‚³ãƒ³ãƒ†ãƒŠãŒç¸®ã‚“ã§ã‚‚è‡ªèº«ã®ã‚µã‚¤ã‚ºã‚’ç¶­æŒ */
        }
        #aiTutorInput {
            flex-grow: 1; min-width: 150px; padding: 12px; border-radius: 8px;
            border: 1px solid var(--border-color); font-size: 1rem;
            background-color: var(--bg-secondary); color: var(--text-primary);
        }
        #voiceInputButton {
            flex-shrink: 0; width: 48px; height: 48px; border-radius: 8px;
            background-color: var(--button-bg-default); border: 1px solid var(--border-color);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: all 0.2s ease;
        }
        #voiceInputButton:hover { background-color: var(--border-color); }
        #voiceInputButton.recording { background-color: #f87171; border-color: #ef4444; }
        #voiceInputButton.recording svg { color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        #aiTutorSubmitButton { flex-shrink: 0; height: 48px; }


        @media (min-width: 640px) { 
            .options-grid { grid-template-columns: 1fr 1fr; }
            #sidebar > div:first-child {
                margin-top: 20px;
            }
        }
        body {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      #questionText, 
      #longContentBox, 
      #aiTutorQuestionText, 
      #aiTutorChatLog .chat-message,
      .feedback-message,
      .start-screen-container p {
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
      }
        img {
        pointer-events: none;
      }
        .loader {
  border: 5px solid var(--bg-tertiary);
  border-top: 5px solid var(--accent-primary);
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: 20px auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
    </style>
</head>
<body>
    <script>
        try {
            const savedData = localStorage.getItem('qube_app_data');
            if (savedData) {
                const settings = JSON.parse(savedData).settings;
                if (settings && settings.darkMode) {
                    document.body.classList.add('dark-mode');
                }
            }
        } catch (e) {
            console.error('Failed to apply dark mode setting on initial load:', e);
        }
    </script>

    <!-- Splash Screen -->
    <div id="splashScreen" class="splash-screen">
        <div class="splash-logo-container">
            <img src="iconsp.png" alt="Qube Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <h1 class="text-5xl font-bold" style="color: var(--accent-primary);">Qube</h1>
        </div>
    </div>

    <div id="confettiContainer" class="confetti-container"></div>
    <div class="main-container">
        <!-- Sidebar -->
        <aside id="sidebar">
            <div class="flex items-center mb-6 h-10">
                <img src="iconp.png" alt="Qube Logo" class="h-11 w-28" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <h2 class="text-2xl font-bold ml-2" style="color: var(--accent-primary); display: none;">Qube</h2>
            </div>
            <button id="newProjectButton" class="btn btn-primary w-full mb-6">æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ</button>
            <h3 class="text-lg font-semibold mb-3 text-gray-500">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§</h3>
            <div id="projectList" class="flex-grow overflow-y-auto space-y-1 pr-2">
                <p class="text-gray-400">ã¾ã ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            </div>
        </aside>
        <div id="sidebarOverlay" class="sidebar-overlay"></div>

        <!-- Main Content -->
        <main id="mainContent">
            <header>
                <div id="headerLeft">
                    <button id="hamburgerButton" class="p-2 rounded-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                    </button>
                </div>
                <div id="headerCenter">
                    <h1 id="projectTitle"></h1>
                </div>
                <div id="headerRight">
                     <button id="interruptButton" class="btn btn-sm btn-danger hidden">ä¸­æ–­</button>
                     <button id="projectSettingsButton" class="p-2 rounded-md invisible">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                     </button>
                </div>
            </header>
            
            <div id="screenContainer">
                <div id="welcomeScreen" class="screen active flex-col justify-center items-center text-center p-8 rounded-lg">
                    <img src="iconsp.png" alt="Qube ãƒ­ã‚´" class="h-25 mb-6 mx-auto">
                    <p class="text-xl mb-8" style="color: var(--text-secondary);">AIã®åŠ›ã§ã€ã‚ãªãŸã®å­¦ç¿’ã‚’æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¸ã€‚</p>
                    <button id="getStartedButton" class="btn btn-primary text-lg px-8 py-3">ã•ã£ããå§‹ã‚ã‚‹</button>
                </div>

                <div id="projectStartScreen" class="screen">
                    <div class="start-screen-container">
                        <h2 class="text-3xl font-bold mb-6">å­¦ç¿’ã‚’é–‹å§‹</h2>
                        <div class="form-group">
                            <label for="quizSelect" class="text-left">ä½œæˆæ¸ˆã¿ã‚¯ã‚¤ã‚ºã‹ã‚‰é¸ã¶</label>
                            <select id="quizSelect"></select>
                        </div>
                        <button id="startSelectedQuizButton" class="btn btn-primary btn-lg w-full">é¸æŠã—ãŸã‚¯ã‚¤ã‚ºã‚’é–‹å§‹</button>
                        <button id="aiTutorButton" class="btn btn-lg w-full mt-4" style="background-color: #10b981; color: white;">ğŸ¤– AIãƒãƒ¥ãƒ¼ã‚¿ãƒ¼ã¨è©±ã™</button>
                        <div class="divider">ã¾ãŸã¯</div>
                        <button id="generateNewQuizBtn" class="btn btn-lg w-full" style="background-color: var(--button-bg-default); color: var(--button-text-default); border: 1px solid var(--border-color);">æ–°ã—ã„ã‚¯ã‚¤ã‚ºã‚’AIã§ç”Ÿæˆ</button>
                    </div>
                </div>
                
                <div id="generationScreen" class="screen">
                    <div class="max-w-3xl mx-auto w-full mb-16">
                        <div class="flex border-b border-gray-200 dark:border-gray-700 mb-6">
                            <button id="generateTabButton" class="tab-button active">æ–°ã—ãç”Ÿæˆã™ã‚‹</button>
                            <button id="importTabButton" class="tab-button">å¤–éƒ¨ã‹ã‚‰èª­ã¿è¾¼ã‚€</button>
                        </div>
                        <div id="generateProjectContainer">
                             <div class="form-group">
                                <label>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
                                <div id="fileDropArea" class="w-full p-8 border-2 border-dashed rounded-lg text-center cursor-pointer hover:border-sky-500">
                                    <p class="text-gray-500">ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—<br>ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                                    <input type="file" class="hidden" id="fileUpload" multiple>
                                </div>
                                <div id="filePreviewContainer"></div>
                            </div>
                            <div class="divider">ã¾ãŸã¯</div>
                            <div class="form-group">
                                <label id="promptLabel" for="promptText">ã‚¯ã‚¤ã‚ºã«ã—ãŸã„å†…å®¹ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰</label>
                                <textarea id="promptText" placeholder="ä¾‹:ã€Œè‹±èªã®é•·æ–‡å•é¡Œã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚ä¸­å­¦ãƒ¬ãƒ™ãƒ«ã§ã€ãƒã‚¹ã‚¿ãƒ¼ã‹ã‚‰å†…å®¹ã‚’èª­ã¿å–ã‚‹å•é¡Œã«ã—ã¦ãã ã•ã„ã€‚ã€ã€€ã¾ãŸã¯ã€€ã€Œæ—¥æœ¬ã®é¦–éƒ½ã¯æ±äº¬ã§ã™ã€‚å¾³å·å®¶åº·ã¯æ±Ÿæˆ¸å¹•åºœã‚’é–‹ãã¾ã—ãŸ...ã€"></textarea>
                            </div>
                            <div class="grid md:grid-cols-2 gap-4 mt-8">
                                <div class="form-group">
                                    <label for="genQuestionCount">å•é¡Œæ•°</label>
                                    <select id="genQuestionCount">
                                        <option value="5">5å•</option>
                                        <option value="10">10å•</option>
                                        <option value="15">15å•</option>
ã€€Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="20">20å•</option>
                                        <option value="25">25å•</option>
ã€€Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="30">30å•</option>
                                        <option value="all">å…¨ã¦</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="questionType">å•é¡Œå½¢å¼</label>
                                    <select id="questionType">
                                        <option value="auto_select">é©åˆ‡ãªã‚‚ã®ã‚’é¸ã¶</option>
                                        <option value="multiple_choice">é¸æŠè‚¢</option>
                                        <option value="fill_in_the_blank">è¨˜è¿°å¼</option>
                                        <option value="sorting">ä¸¦ã³æ›¿ãˆ</option>
                                        <option value="multiple_select">è¤‡æ•°é¸æŠ</option>
                                    </select>
                                </div>
                            </div>
                             <div class="mt-4">
                                <label class="flex items-center gap-2 cursor-pointer flex-nowrap">
                                    <input type="checkbox" id="autoGenreCheckbox" class="w-4 h-4 accent-sky-500 flex-shrink-0">
                                    <span class="select-none">AIã«ã‚ˆã‚‹è‡ªå‹•ã‚¸ãƒ£ãƒ³ãƒ«åˆ†ã‘</span>
                                </label>
                            </div>
                            <button id="generateQuizButton" class="btn btn-primary w-full mt-4 py-3 text-lg flex items-center justify-center">
                                <span class="button-text">ã‚¯ã‚¤ã‚ºã‚’ç”Ÿæˆã™ã‚‹</span>
                                <svg class="spinner hidden animate-spin ml-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            </button>
                            <p id="generationWarning" class="text-red-500 text-sm mt-2 text-center hidden"></p>
                            <p id="generationError" class="text-red-500 text-sm mt-2 text-center hidden"></p>
                            <button id="backToProjectStartBtn" class="btn w-full mt-4" style="background-color: var(--button-bg-default); color: var(--button-text-default); border: 1px solid var(--border-color);">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«æˆ»ã‚‹</button>
                        </div>
                        <div id="importProjectContainer">
                            <div class="form-group">
                                <label for="importFileInput">å…±æœ‰ãƒ•ã‚¡ã‚¤ãƒ« (.txt) ã‚’é¸æŠ</label>
                                <input type="file" id="importFileInput" accept=".txt, text/plain" class="w-full p-2 border rounded-lg">
                            </div>
                            <div class="mt-4">
                               <label class="flex items-center gap-2 cursor-pointer flex-nowrap">
                                   <input type="checkbox" id="importMasteryCheckbox" class="w-4 h-4 accent-sky-500 flex-shrink-0" checked>
                                   <span class="select-none">å…±æœ‰å…ƒã®å­¦ç¿’çŠ¶æ³ï¼ˆç¿’ç†Ÿåº¦ï¼‰ã‚’åæ˜ ã™ã‚‹</span>
                               </label>
                           </div>
                            <button id="importProjectButton" class="btn btn-primary w-full mt-4 py-3 text-lg">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’èª­ã¿è¾¼ã‚€</button>
                            <p id="importStatusMessage" class="text-sm mt-2 text-center"></p>
                        </div>
                    </div>
                </div>

                <div id="quizScreen" class="screen">
                    <div class="quiz-container">
                        <div id="quizHeader">
                            <div id="quizTitleArea">
                                <h1 id="quizTitle">ã‚¯ã‚¤ã‚º</h1>
                            </div>
                            <div class="progress-container">
                                <div id="progressBar" class="progress-bar"></div>
                            </div>
                            <div id="progressText" class="progress-text"></div>
                        </div>
                        <div class="question-area">
                            <div id="questionText" class="question-text"></div>
                            <img id="questionImage" class="hidden"/>
                            <div id="longContentBox"></div>
                        </div>
                        <div id="optionsGrid" class="options-grid"></div>
                        <div id="submissionArea" class="mt-4 text-right"></div>
                        <div id="feedbackMessage" class="feedback-message" style="visibility: hidden;">
                            <div class="feedback-header">
                                <div id="feedbackResult"></div>
                                <button id="toggleExplanationButton" class="toggle-explanation-button hidden">è§£èª¬â–¼</button>
                            </div>
                            <div id="explanationContent" class="explanation-content">
                                <div class="explanation-text"></div>
                            </div>
                        </div>
                        <div class="navigation-buttons">
                            <button id="nextButton" class="btn btn-primary">æ¬¡ã®å•é¡Œ</button>
                        </div>
                    </div>
                </div>

                <div id="aiTutorScreen" class="screen">
                    <div class="quiz-container">
                        <div id="aiTutorActionsContainer" class="mb-4 text-right hidden"></div>
                        <div class="ai-tutor-problem-statement">
                            <p id="aiTutorQuestionText"></p>
                            <button id="toggleOtherOptionsButton">ä»–ã®é¸æŠè‚¢ã‚’è¦‹ã‚‹â–¼</button>
                            <div id="otherOptionsContainer" style="display: none;"></div>
                        </div>
                        <div id="aiTutorChatLog"></div>
                        <form id="aiTutorInputForm">
                            <input type="text" id="aiTutorInput" placeholder="ãªãœã“ã®ç­”ãˆã«ãªã‚‹ã‹èª¬æ˜ã—ã¦ã¿ã‚ˆã†ï¼" autocomplete="off">
                            <button type="button" id="voiceInputButton">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--text-secondary);">
                                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                    <line x1="12" y1="19" x2="12" y2="23"></line>
                                </svg>
                            </button>
                            <button type="submit" id="aiTutorSubmitButton" class="btn btn-primary">é€ä¿¡</button>
                        </form>
                    </div>
                </div>

                <div id="resultScreen" class="screen">
                    <div class="result-container">
                        <h2 class="text-2xl font-bold mb-4" style="color: var(--score-color);">ã‚¯ã‚¤ã‚ºçµæœ</h2>
                        <div id="finalScore" class="score-area"></div>
                        <div id="scoreComment" class="score-comment"></div>
                        <div class="mt-6 flex flex-col items-center gap-3">
                            <button id="restartQuizButton" class="btn btn-primary w-full max-w-xs">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>
                            <button id="backToProjectButton" class="btn w-full max-w-xs" style="background-color: var(--button-bg-default); color: var(--button-text-default); border: 1px solid var(--border-color);">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«æˆ»ã‚‹</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Settings Screen (Modal) -->
    <div id="settingsScreen" class="screen">
        <div class="settings-container">
            <h2 class="text-2xl font-bold mb-4 text-center">è¨­å®š</h2>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label for="darkModeToggle">ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</label>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label>ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼</label>
                </div>
                <div class="theme-colors">
                    <div class="color-circle" data-theme="default" style="background-color: #0ea5e9;"></div>
                    <div class="color-circle" data-theme="red" style="background-color: #ef4444;"></div>
                    <div class="color-circle" data-theme="green" style="background-color: #10b981;"></div>
                    <div class="color-circle" data-theme="indigo" style="background-color: #6366f1;"></div>
                </div>
            </div>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label for="soundVolumeSlider">åŠ¹æœéŸ³</label>
                </div>
                <div class="flex items-center gap-2">
                    <span id="volumeStatus" class="text-sm text-gray-500 w-8 text-right"></span>
                    <input type="range" id="soundVolumeSlider" min="0" max="100">
                </div>
            </div>
             <div class="settings-option">
                <div class="settings-option-label">
                    <label for="questionCountSelect">å•é¡Œæ•°</label>
                </div>
                <select id="questionCountSelect" class="w-24 p-2 border rounded">
                    <option value="5">5å•</option>
                    <option value="10">10å•</option>
                    <option value="15">15å•</option>
                    <option value="20">20å•</option>
                    <option value="25">25å•</option>
                    <option value="30">30å•</option>
                    <option value="99">å…¨ã¦</option>
                </select>
            </div>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label for="shuffleQuestionsToggle">ã‚·ãƒ£ãƒƒãƒ•ãƒ«å‡ºé¡Œ</label>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="shuffleQuestionsToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label for="showProgressToggle">é€²æ—çŠ¶æ³ã‚’è¡¨ç¤º</label>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="showProgressToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label for="masteryModeToggle">ç‰¹è¨“ãƒ¢ãƒ¼ãƒ‰</label>
                    <p>2å›é€£ç¶šã§æ­£è§£ã™ã‚‹ã¾ã§ã€Œç¿’å¾—æ¸ˆã¿ã€ã«ãªã‚Šã¾ã›ã‚“ã€‚</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="masteryModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å…±æœ‰</label>
                    <p>ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ›¸ãå‡ºã—ã¦å…±æœ‰ã—ã¾ã™ã€‚</p>
                </div>
                <button id="exportProjectButton" class="btn">æ›¸ãå‡ºã™</button>
            </div>
             <div class="settings-option">
                <button id="editQuizzesButton" class="btn w-full">ä½œæˆæ¸ˆã¿ã‚¯ã‚¤ã‚ºã‚’ç·¨é›†ã™ã‚‹</button>
            </div>
            <button id="backToProjectFromSettings" class="btn btn-primary mt-8 w-full">é–‰ã˜ã‚‹</button>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="newProjectModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ</h2>
            <div class="form-group">
                <label for="newProjectNameInput">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</label>
                <input type="text" id="newProjectNameInput" placeholder="ä¾‹: æ­´å²ã‚¯ã‚¤ã‚º">
            </div>
            <div class="modal-buttons">
                <button id="modalCancelProjectButton" class="modal-button cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="modalCreateProjectButton" class="modal-button create">ä½œæˆ</button>
            </div>
        </div>
    </div>
    <div id="renameProjectModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å¤‰æ›´</h2>
            <div class="form-group">
                <label for="renameProjectNameInput">æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</label>
                <input type="text" id="renameProjectNameInput">
            </div>
            <div class="modal-buttons">
                <button id="modalCancelRenameButton" class="modal-button cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="modalSaveRenameButton" class="modal-button save">ä¿å­˜</button>
            </div>
        </div>
    </div>
    <div id="nameQuizModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">ã‚¯ã‚¤ã‚ºã«åå‰ã‚’ä»˜ã‘ã‚‹</h2>
            <div class="form-group">
                <label for="newQuizNameInput">ã‚¯ã‚¤ã‚ºå</label>
                <input type="text" id="newQuizNameInput" placeholder="ä¾‹: æ±Ÿæˆ¸æ™‚ä»£ã‚¯ã‚¤ã‚º">
            </div>
            <div class="modal-buttons">
                <button id="modalCancelQuizButton" class="modal-button cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="modalCreateQuizButton" class="modal-button create">ä¿å­˜</button>
            </div>
        </div>
    </div>
     <div id="interruptModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">ã‚¯ã‚¤ã‚ºã‚’ä¸­æ–­</h2>
            <p>æœ¬å½“ã«ã‚¯ã‚¤ã‚ºã‚’ä¸­æ–­ã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®é€²æ—ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚</p>
            <div class="modal-buttons">
                <button id="modalCancelInterrupt" class="modal-button cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="modalConfirmInterrupt" class="modal-button delete">ä¸­æ–­ã™ã‚‹</button>
            </div>
        </div>
    </div>
    <div id="deleteProjectModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤</h2>
            <p>æœ¬å½“ã«ã€Œ<span id="deleteProjectName"></span>ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚</p>
            <div class="modal-buttons">
                <button id="modalCancelDelete" class="modal-button cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="modalConfirmDelete" class="modal-button delete">å‰Šé™¤ã™ã‚‹</button>
            </div>
        </div>
    </div>
    
    <div id="editQuizzesModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">ã‚¯ã‚¤ã‚ºã®ç·¨é›†</h2>
            <div id="editQuizList" class="space-y-2">
            </div>
            <div class="modal-buttons">
                <button id="closeEditQuizModalButton" class="modal-button cancel">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
    <div id="renameQuizInstanceModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">ã‚¯ã‚¤ã‚ºåã‚’å¤‰æ›´</h2>
            <div class="form-group">
                <label for="renameQuizNameInstanceInput">æ–°ã—ã„ã‚¯ã‚¤ã‚ºå</label>
                <input type="text" id="renameQuizNameInstanceInput">
            </div>
            <div class="modal-buttons">
                <button class="modal-button cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="modal-button save">ä¿å­˜</button>
            </div>
        </div>
    </div>
    <div id="deleteQuizInstanceModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">ã‚¯ã‚¤ã‚ºã‚’å‰Šé™¤</h2>
            <p>æœ¬å½“ã«ã€Œ<span id="deleteQuizNameInstance"></span>ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚</p>
            <div class="modal-buttons">
                <button class="modal-button cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="modal-button delete">å‰Šé™¤ã™ã‚‹</button>
            </div>
        </div>
    </div>
    <div id="resetMasteryModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">å­¦ç¿’å®Œäº†ï¼</h2>
            <p>ã“ã®ã‚¯ã‚¤ã‚ºã®ã™ã¹ã¦ã®å•é¡Œã‚’ç¿’å¾—ã—ã¾ã—ãŸã€‚é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã€ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã¾ã™ã‹ï¼Ÿ</p>
            <div class="modal-buttons">
                <button class="modal-button cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="modal-button reset">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>
    </div>
    
    <div id="nextQuestionModal" class="modal">
    Â  Â  Â  Â  <div class="modal-content">
    Â  Â  Â  Â  Â  Â  <h2 class="modal-title">ç´ æ™´ã‚‰ã—ã„ï¼</h2>
    Â  Â  Â  Â  Â  Â  <p>ç†è§£ãŒæ·±ã¾ã£ãŸã‚ˆã†ã§ã™ã­ï¼æ¬¡ã®å•é¡Œã«é€²ã¿ã¾ã™ã‹ï¼Ÿ</p>
    Â  Â  Â  Â  Â  Â  <div class="modal-buttons">
    Â  Â  Â  Â  Â  Â  Â  Â  <button id="modalCancelNextQuestion" class="modal-button cancel">ã¾ã ç¶šã‘ã‚‹</button>
    Â  Â  Â  Â  Â  Â  Â  Â  <button id="modalConfirmNextQuestion" class="modal-button create">æ¬¡ã®å•é¡Œã¸</button>
    Â  Â  Â  Â  Â  Â  </div>
    Â  Â  Â  Â  </div>
    Â  Â  </div>
    
    <div id="tosModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">åˆ©ç”¨è¦ç´„</h2>
            <div id="tosContent">
                <p class="mb-2">ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã¯AIï¼ˆäººå·¥çŸ¥èƒ½ï¼‰ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚</p>
                <p class="mb-2">Googleç¤¾ã®Gemini APIã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚</p>
                <p class="mb-2">AIã«ã‚ˆã‚‹å›ç­”çµæœã«ã¯ã€èª¤ã£ãŸæƒ…å ±ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€ãã®æ­£ç¢ºæ€§ã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                <p>å½“ã‚µãƒ¼ãƒ“ã‚¹ã®ã”åˆ©ç”¨ã«ã‚ˆã‚Šç”Ÿã˜ãŸã€ã„ã‹ãªã‚‹æå®³ã«ã¤ã„ã¦ã‚‚ã€å½“æ–¹ã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚</p>
            </div>
            <div class="modal-buttons">
                <button id="tosAgreeButton" class="modal-button create">åŒæ„ã—ã¦åˆ©ç”¨ã‚’é–‹å§‹</button>
            </div>
        </div>
    </div>

    <div id="addToHomeScreenPopup" class="text-sm">
        <button id="closeAddToHomeScreen">&times;</button>
        <p class="font-bold mb-2">ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã‚¢ãƒ—ãƒªã¨ã—ã¦ä½¿ãŠã†ï¼</p>
        <p>ãƒ–ãƒ©ã‚¦ã‚¶ã®å…±æœ‰ãƒœã‚¿ãƒ³ <span id="iosShareIconContainer" class="inline-block align-middle h-5 w-5 -mt-1"></span> ã‹ã‚‰ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
        <p class="text-xs mt-2 text-gray-500">ã‚¢ãƒ—ãƒªç‰ˆã¨ãƒ–ãƒ©ã‚¦ã‚¶ç‰ˆã§ç”Ÿæˆã—ãŸã‚¯ã‚¤ã‚ºãŒåŒæœŸã—ãªã„ãŸã‚ã€ç”Ÿæˆã™ã‚‹å‰ã«ã‚¢ãƒ—ãƒªç‰ˆã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚</p>
    </div>
    
    <div id="loadingModal" class="modal">
    <div class="modal-content" style="max-width: 300px; text-align: center; background-color: var(--bg-secondary);">
        <div class="loader"></div>
        <p class="mt-4 text-lg font-semibold">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ä¸­...</p>
        <p id="loadingStatus" class="text-sm" style="color: var(--text-secondary); min-height: 1.25rem;"></p>
    </div>
</div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('sidebar');
            const hamburgerButton = document.getElementById('hamburgerButton');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const newProjectButton = document.getElementById('newProjectButton');
            const getStartedButton = document.getElementById('getStartedButton');
            const projectTitle = document.getElementById('projectTitle');
            const projectSettingsButton = document.getElementById('projectSettingsButton');
            const projectListEl = document.getElementById('projectList');
            
            const screens = {
                welcome: document.getElementById('welcomeScreen'),
                projectStart: document.getElementById('projectStartScreen'),
                generate: document.getElementById('generationScreen'),
                quiz: document.getElementById('quizScreen'),
                result: document.getElementById('resultScreen'),
                aiTutor: document.getElementById('aiTutorScreen'),
            };
            const settingsScreen = document.getElementById('settingsScreen');

            const generateQuizButton = document.getElementById('generateQuizButton');
            const generateNewQuizBtn = document.getElementById('generateNewQuizBtn');
            const backToProjectStartBtn = document.getElementById('backToProjectStartBtn');
            const promptText = document.getElementById('promptText');
            const promptLabel = document.getElementById('promptLabel');
            const questionType = document.getElementById('questionType');
            const genQuestionCount = document.getElementById('genQuestionCount');
            const autoGenreCheckbox = document.getElementById('autoGenreCheckbox');
            const generationError = document.getElementById('generationError');
            const generationWarning = document.getElementById('generationWarning');
            const quizSelect = document.getElementById('quizSelect');
            const startSelectedQuizButton = document.getElementById('startSelectedQuizButton');
            const fileDropArea = document.getElementById('fileDropArea');
            const fileUpload = document.getElementById('fileUpload');
            const filePreviewContainer = document.getElementById('filePreviewContainer');

            const generateTabButton = document.getElementById('generateTabButton');
            const importTabButton = document.getElementById('importTabButton');
            const generateProjectContainer = document.getElementById('generateProjectContainer');
            const importProjectContainer = document.getElementById('importProjectContainer');
            const importFileInput = document.getElementById('importFileInput');
            const importProjectButton = document.getElementById('importProjectButton');
            const importStatusMessage = document.getElementById('importStatusMessage');
            const importMasteryCheckbox = document.getElementById('importMasteryCheckbox');
            const exportProjectButton = document.getElementById('exportProjectButton');


            const newProjectModal = document.getElementById('newProjectModal');
            const newProjectNameInput = document.getElementById('newProjectNameInput');
            const modalCreateProjectButton = document.getElementById('modalCreateProjectButton');
            const modalCancelProjectButton = document.getElementById('modalCancelProjectButton');

            const renameProjectModal = document.getElementById('renameProjectModal');
            const renameProjectNameInput = document.getElementById('renameProjectNameInput');
            const modalSaveRenameButton = document.getElementById('modalSaveRenameButton');
            const modalCancelRenameButton = document.getElementById('modalCancelRenameButton');
            
            const nameQuizModal = document.getElementById('nameQuizModal');
            const newQuizNameInput = document.getElementById('newQuizNameInput');
            const modalCreateQuizButton = document.getElementById('modalCreateQuizButton');
            const modalCancelQuizButton = document.getElementById('modalCancelQuizButton');

            const interruptModal = document.getElementById('interruptModal');
            const modalConfirmInterrupt = document.getElementById('modalConfirmInterrupt');
            const modalCancelInterrupt = document.getElementById('modalCancelInterrupt');

            const deleteProjectModal = document.getElementById('deleteProjectModal');
            const deleteProjectName = document.getElementById('deleteProjectName');
            const modalConfirmDelete = document.getElementById('modalConfirmDelete');
            const modalCancelDelete = document.getElementById('modalCancelDelete');

            let questionTextElement = document.getElementById('questionText');
            let optionsGridElement = document.getElementById('optionsGrid');
            const quizTitleEl = document.getElementById('quizTitle');
            const questionImage = document.getElementById('questionImage');
            const longContentBox = document.getElementById('longContentBox');
            const submissionArea = document.getElementById('submissionArea');
            const feedbackMessageElement = document.getElementById('feedbackMessage');
            const feedbackResultElement = document.getElementById('feedbackResult');
            const explanationContentElement = document.getElementById('explanationContent');
            const explanationTextElement = explanationContentElement.querySelector('.explanation-text');
            const toggleExplanationButton = document.getElementById('toggleExplanationButton');
            const nextButton = document.getElementById('nextButton');
            
            const interruptButton = document.getElementById('interruptButton');

            const progressBarContainer = document.querySelector('.progress-container');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const finalScore = document.getElementById('finalScore');
            const scoreComment = document.getElementById('scoreComment');
            const confettiContainer = document.getElementById('confettiContainer');
            const restartQuizButton = document.getElementById('restartQuizButton');
            const backToProjectButton = document.getElementById('backToProjectButton');
            
            const darkModeToggle = document.getElementById('darkModeToggle');
            const themeColorCircles = document.querySelectorAll('.color-circle');
            const soundVolumeSlider = document.getElementById('soundVolumeSlider');
            const volumeStatus = document.getElementById('volumeStatus');
            const questionCountSelect = document.getElementById('questionCountSelect');
            const shuffleQuestionsToggle = document.getElementById('shuffleQuestionsToggle');
            const showProgressToggle = document.getElementById('showProgressToggle');
            const masteryModeToggle = document.getElementById('masteryModeToggle');
            const backToProjectFromSettings = document.getElementById('backToProjectFromSettings');
            const editQuizzesButton = document.getElementById('editQuizzesButton');

            const editQuizzesModal = document.getElementById('editQuizzesModal');
            const editQuizList = document.getElementById('editQuizList');
            const closeEditQuizModalButton = document.getElementById('closeEditQuizModalButton');
            
            const renameQuizInstanceModal = document.getElementById('renameQuizInstanceModal');
            const renameQuizNameInstanceInput = document.getElementById('renameQuizNameInstanceInput');

            const deleteQuizInstanceModal = document.getElementById('deleteQuizInstanceModal');
            const deleteQuizNameInstance = document.getElementById('deleteQuizNameInstance');
            const resetMasteryModal = document.getElementById('resetMasteryModal');
            const nextQuestionModal = document.getElementById('nextQuestionModal');
            const modalConfirmNextQuestion = document.getElementById('modalConfirmNextQuestion');
            const modalCancelNextQuestion = document.getElementById('modalCancelNextQuestion');

            const tosModal = document.getElementById('tosModal');
            const tosAgreeButton = document.getElementById('tosAgreeButton');
            const addToHomeScreenPopup = document.getElementById('addToHomeScreenPopup');
            const closeAddToHomeScreen = document.getElementById('closeAddToHomeScreen');

            const aiTutorButton = document.getElementById('aiTutorButton');
            const aiTutorActionsContainer = document.getElementById('aiTutorActionsContainer');
            const aiTutorQuestionText = document.getElementById('aiTutorQuestionText');
            const aiTutorChatLog = document.getElementById('aiTutorChatLog');
            const aiTutorInputForm = document.getElementById('aiTutorInputForm');
            const aiTutorInput = document.getElementById('aiTutorInput');
            const aiTutorSubmitButton = document.getElementById('aiTutorSubmitButton');
            const voiceInputButton = document.getElementById('voiceInputButton');
            const toggleOtherOptionsButton = document.getElementById('toggleOtherOptionsButton');
            const otherOptionsContainer = document.getElementById('otherOptionsContainer');

            let appState = {
                projects: [],
                settings: {
                    darkMode: false,
                    themeColor: 'default',
                    soundVolume: 75,
                    questionCount: 5,
                    shuffleQuestions: true,
                    showProgress: true,
                    masteryMode: false,
                }
            };
            let activeProjectId = null;
            let currentQuiz = null; 
            let confettiAnimationId;
            let tempGeneratedQuestions = null;
            let tempGeneratedImages = [];
            let uploadedFiles = [];
            let projectToEditId = null;
            let quizToEditId = null;
            let aiChatHistory = [];
            let speechRecognition;
            let isRecording = false;
            let aiTutorInteractionCount = 0;
            
            const sounds = {
                correct: new Tone.Synth({ volume: -2, oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination(),
                incorrect: new Tone.FMSynth({ volume: 4, harmonicity: 1.5, modulationIndex: 10, oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.01, release: 0.1 } }).toDestination(),
                click: new Tone.Synth({ volume: -5, oscillator: { type: 'triangle' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.1 } }).toDestination(),
                fanfare: new Tone.PolySynth(Tone.Synth, { volume: 0 }).toDestination(),
                micOn: new Tone.Synth({ volume: -15, oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.1, release: 0.1 } }).toDestination(),
                micOff: new Tone.Synth({ volume: -15, oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.2, release: 0.2 } }).toDestination(),
            };
            
            // â˜…â˜…â˜… å¤‰æ›´ç®‡æ‰€ â˜…â˜…â˜… START - å…¨ã¦ã®é–¢æ•°ã‚’é–¢æ•°å®£è¨€ã«çµ±ä¸€
            function updateVolume(level) {
                const numberLevel = Number(level);
                let db;
                if (numberLevel === 0) {
                    db = -Infinity;
                    volumeStatus.textContent = 'ã‚ªãƒ•';
                } else {
                    db = (numberLevel / 100) * 30 - 25;
                    volumeStatus.textContent = '';
                }
                
                sounds.correct.volume.value = db;
                sounds.click.volume.value = db - 4;
                sounds.fanfare.volume.value = db;
                sounds.incorrect.volume.value = db + 6;
                sounds.micOn.volume.value = db - 5;
                sounds.micOff.volume.value = db - 5;
                
                appState.settings.soundVolume = numberLevel;
            };

            async function playSound(type) {
                if (appState.settings.soundVolume === 0) return;
                if (Tone.context.state !== 'running') await Tone.start();
                const now = Tone.now();
                try {
                    switch (type) {
                        case 'correct': sounds.correct.triggerAttackRelease("C5", "8n", now); break;
                        case 'incorrect': sounds.incorrect.triggerAttackRelease("A2", "8n", now); break;
                        case 'click': sounds.click.triggerAttackRelease("C6", "16n", now); break;
                        case 'fanfare':
                            ["C5", "E5", "G5", "C6"].forEach((note, i) => {
                                sounds.fanfare.triggerAttackRelease(note, "8n", now + i * 0.15);
                            });
                            break;
                        case 'micOn': sounds.micOn.triggerAttackRelease("E5", "16n", now); break;
                        case 'micOff': sounds.micOff.triggerAttackRelease("C5", "16n", now); break;
                    }
                } catch (error) { console.error("Sound playback failed:", error); }
            }
            
            function saveState() {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // é€šå¸¸ã®ä¿å­˜å‡¦ç†ã‚’è©¦ã¿ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dataToSave = JSON.stringify(appState);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('qube_app_data', dataToSave);

Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ä¿å­˜ã«å¤±æ•—ã—ãŸå ´åˆã®å‡¦ç†
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Failed to save state:", e);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // iOSã§ã‚ˆãç™ºç”Ÿã™ã‚‹å®¹é‡è¶…éã‚¨ãƒ©ãƒ¼ã‹ã©ã†ã‹ã‚’åˆ¤å®š
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (e.name === 'QuotaExceededError') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ†ã‹ã‚Šã‚„ã™ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§é€šçŸ¥
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n' +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'ä»¥ä¸‹ã®åŸå› ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ï¼š\n' +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'ãƒ»SafariãŒãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¸ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã«ãªã£ã¦ã„ã‚‹\n' +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'ãƒ»ç«¯æœ«ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç©ºãå®¹é‡ãŒä¸è¶³ã—ã¦ã„ã‚‹\n' +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã‚‹\n\n' +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¸ãƒ³ã‚°ã‚’ã‚ªãƒ•ã«ã—ã¦ã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ãã®ä»–ã®äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
            function loadState() {
                const savedData = localStorage.getItem('qube_app_data');
                if (savedData) {
                    const loadedState = JSON.parse(savedData);
                    appState.settings = { ...appState.settings, ...loadedState.settings };
                    appState.projects = loadedState.projects || [];

                    if (appState.projects) {
                        appState.projects.forEach(p => {
                            if (!p.mastery) p.mastery = {};
                            if (p.isPinned === undefined) p.isPinned = false;
                        });
                    }
                }
            };

            function adjustTitleFontSize(element, text) {
                 if (!element) return;
                
                 const defaultSize = window.innerWidth < 768 ? 1.25 : 1.875;
                 element.innerHTML = '';
                
                 if (!text || text === 'Qube') {
                     const img = document.createElement('img');
                     img.src = "iconsp.png";
                     img.alt = "Qube Logo";
                     img.className = "h-10 w-16 mx-auto";
                     img.onerror = function() {
                         this.style.display='none';
                         const span = document.createElement('span');
                         span.textContent = 'Qube';
                         element.appendChild(span);
                     };
                     element.appendChild(img);
                 } else {
                     element.textContent = text;
                     element.style.fontSize = `${defaultSize}rem`;
                 }
            };
            
            function updateProjectTitle(text) {
                if (screens.welcome.classList.contains('active')) {
                    adjustTitleFontSize(projectTitle, 'å­¦ç¿’ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼');
                } else if (screens.aiTutor.classList.contains('active')) {
                    adjustTitleFontSize(projectTitle, 'ğŸ¤– AIãƒãƒ¥ãƒ¼ã‚¿ãƒ¼');
                } else {
                    adjustTitleFontSize(projectTitle, text || 'Qube');
                }
            };

            function switchScreen(screenName) {
                Object.values(screens).forEach(s => s.classList.remove('active'));
                if (screens[screenName]) screens[screenName].classList.add('active');
                
                const isQuizOrTutor = screenName === 'quiz' || screenName === 'aiTutor';
                hamburgerButton.classList.toggle('hidden', isQuizOrTutor);
                projectSettingsButton.classList.toggle('invisible', isQuizOrTutor || screenName === 'welcome' || screenName === 'generate');
                interruptButton.classList.toggle('hidden', !isQuizOrTutor);
                if(isQuizOrTutor) {
                    interruptButton.textContent = screenName === 'aiTutor' ? 'çµ‚äº†' : 'ä¸­æ–­';
                }
                
                if (screenName === 'quiz') {
                    adjustTitleFontSize(quizTitleEl, currentQuiz?.name || "ã‚¯ã‚¤ã‚º");
                } else {
                    const project = appState.projects.find(p => p.id === activeProjectId);
                    updateProjectTitle(project?.name || 'Qube');
                }
            };

            function toggleSidebar() {
                const isOpen = sidebar.classList.toggle('open');
                if (window.innerWidth < 768) {
                    sidebarOverlay.classList.toggle('active', isOpen);
                } else {
                    document.body.classList.toggle('sidebar-open-desktop', isOpen);
                }
            };
            
            function showNewProjectModal() {
                newProjectNameInput.value = `ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ${appState.projects.length + 1}`;
                newProjectModal.classList.add('show');
                newProjectNameInput.focus();
                newProjectNameInput.select();
            };

            function closeNewProjectModal() {
                newProjectModal.classList.remove('show');
            }
            
            function handleCreateProject() {
                const projectName = newProjectNameInput.value.trim();
                if (!projectName) {
                    newProjectNameInput.focus();
                    return;
                }
                const newProject = { 
                    id: `proj_${Date.now()}`, 
                    name: projectName, 
                    quizzes: [],
                    mastery: {},
                    lastPlayedQuizId: null,
                    isPinned: false
                };
                appState.projects.unshift(newProject);
                saveState();
                renderProjectList();
                setActiveProject(newProject.id);
                closeNewProjectModal();
                if(window.innerWidth < 768 && sidebar.classList.contains('open')) toggleSidebar();
            };

            function renderProjectList() {
                projectListEl.innerHTML = '';
                if (appState.projects.length === 0) {
                    projectListEl.innerHTML = '<p class="text-gray-400 p-2">ã¾ã ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                    return;
                }
                
                const sortedProjects = [...appState.projects].sort((a, b) => (b.isPinned ? 1 : 0) - (a.isPinned ? 1 : 0));

                sortedProjects.forEach(p => {
                    const projectEl = document.createElement('div');
                    projectEl.className = `project-item ${p.id === activeProjectId ? 'active' : ''}`;
                    projectEl.dataset.projectId = p.id;
                    projectEl.draggable = true;

                    let pinIcon = '';
                    if (p.isPinned) {
                        pinIcon = `<span class="mr-2 flex-shrink-0">ğŸ“Œ</span>`;
                    }

                    const nameEl = document.createElement('div');
                    nameEl.innerHTML = pinIcon + `<span class="flex-grow">${p.name}</span>`;
                    nameEl.className = 'project-name flex items-center';
                    
                    const menuBtn = document.createElement('button');
                    menuBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" /></svg>`;
                    menuBtn.className = 'project-menu-btn';
                    
                    projectEl.appendChild(nameEl);
                    projectEl.appendChild(menuBtn);
                    projectListEl.appendChild(projectEl);

                    nameEl.addEventListener('click', () => {
                        setActiveProject(p.id);
                        if(window.innerWidth < 768) toggleSidebar();
                    });

                    menuBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showProjectMenu(p.id, e.currentTarget.parentElement);
                    });
                });
                addProjectDragDropListeners();
            };
            
            function showProjectMenu(projectId, projectItemElement) {
                document.querySelectorAll('.project-menu').forEach(m => m.remove());
                const project = appState.projects.find(p => p.id === projectId);
                if (!project) return;

                const pinActionText = project.isPinned ? 'ãƒ”ãƒ³ã‚’å¤–ã™' : 'ãƒ”ãƒ³ç•™ã‚ã™ã‚‹';

                const menu = document.createElement('div');
                menu.className = 'project-menu';
                menu.innerHTML = `
                    <div class="project-menu-item" data-action="pin" data-project-id="${projectId}">${pinActionText}</div>
                    <div class="project-menu-item" data-action="rename" data-project-id="${projectId}">åå‰ã‚’å¤‰æ›´</div>
                    <div class="project-menu-item" data-action="export" data-project-id="${projectId}">æ›¸ãå‡ºã™</div>
                    <div class="project-menu-item delete" data-action="delete" data-project-id="${projectId}">å‰Šé™¤</div>
                `;
                projectItemElement.appendChild(menu);
                
                menu.classList.add('show');
                
                const closeMenu = (e) => {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.body.removeEventListener('click', closeMenu, true);
                    }
                };

                menu.addEventListener('click', (e) => {
                    const action = e.target.closest('.project-menu-item')?.dataset.action;
                    if (action === 'rename') showRenameProjectModal(projectId);
                    else if (action === 'delete') showDeleteProjectModal(projectId);
                    else if (action === 'pin') toggleProjectPin(projectId);
                    else if (action === 'export') handleExportProject(projectId);
                    menu.remove();
                    document.body.removeEventListener('click', closeMenu, true);
                });

                setTimeout(() => document.body.addEventListener('click', closeMenu, true), 0);
            };

            function toggleProjectPin(projectId) {
                const project = appState.projects.find(p => p.id === projectId);
                if (project) {
                    project.isPinned = !project.isPinned;
                    saveState();
                    renderProjectList();
                }
            };

            function showRenameProjectModal(projectId) {
                projectToEditId = projectId;
                const project = appState.projects.find(p => p.id === projectId);
                if (project) {
                    renameProjectNameInput.value = project.name;
                    renameProjectModal.classList.add('show');
                    renameProjectNameInput.focus();
                    renameProjectNameInput.select();
                }
            };

            function closeRenameProjectModal() {
                renameProjectModal.classList.remove('show');
                projectToEditId = null;
            };

            function handleRenameProject() {
                const newName = renameProjectNameInput.value.trim();
                if (!newName || !projectToEditId) return;
                const project = appState.projects.find(p => p.id === projectToEditId);
                if (project) {
                    project.name = newName;
                    saveState();
                    renderProjectList();
                    if (activeProjectId === projectToEditId) updateProjectTitle(newName);
                }
                closeRenameProjectModal();
            };

            function showDeleteProjectModal(projectId) {
                projectToEditId = projectId;
                const project = appState.projects.find(p => p.id === projectId);
                if(project) {
                    deleteProjectName.textContent = project.name;
                    deleteProjectModal.classList.add('show');
                }
            };
            
            function closeDeleteProjectModal() {
                deleteProjectModal.classList.remove('show');
                projectToEditId = null;
            };

            function handleDeleteProject() {
                if(!projectToEditId) return;
                appState.projects = appState.projects.filter(p => p.id !== projectToEditId);
                if(activeProjectId === projectToEditId) {
                    activeProjectId = null;
                    localStorage.removeItem('qube_lastActiveProjectId');
                    updateProjectTitle('Qube');
                    switchScreen('welcome');
                }
                saveState();
                renderProjectList();
                closeDeleteProjectModal();
            };

            function addProjectDragDropListeners() {
                let draggedItem = null;
                projectListEl.querySelectorAll('.project-item').forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        draggedItem = item;
                        setTimeout(() => item.classList.add('dragging'), 0);
                    });
                    item.addEventListener('dragend', () => {
                        setTimeout(() => {
                            if (draggedItem) draggedItem.classList.remove('dragging');
                            draggedItem = null;
                        }, 0);
                    });
                });
                projectListEl.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(projectListEl, e.clientY);
                    if (draggedItem) {
                        if (afterElement == null) projectListEl.appendChild(draggedItem);
                        else projectListEl.insertBefore(draggedItem, afterElement);
                    }
                });
                projectListEl.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const newOrderIds = Array.from(projectListEl.querySelectorAll('.project-item')).map(item => item.dataset.projectId);
                    appState.projects.sort((a, b) => newOrderIds.indexOf(a.id) - newOrderIds.indexOf(b.id));
                    saveState();
                    renderProjectList();
                });
            };

            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.project-item:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                    else return closest;
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            };

            function setActiveProject(projectId) {
                activeProjectId = projectId;
                localStorage.setItem('qube_lastActiveProjectId', projectId);
                resetUploadUI();
                promptText.value = '';
                const project = appState.projects.find(p => p.id === projectId);
                if (project) {
                    updateProjectTitle(project.name);
                    if (project.quizzes.length === 0) {
                        switchScreen('generate'); 
                        backToProjectStartBtn.style.display = 'none';
                    } else {
                        populateQuizSelect(project);
                        switchScreen('projectStart');
                    }
                }
                renderProjectList();
            };

            function populateQuizSelect(project) {
                quizSelect.innerHTML = '';
                if (project.quizzes.length === 0) {
                    const option = document.createElement('option');
                    option.textContent = 'åˆ©ç”¨å¯èƒ½ãªã‚¯ã‚¤ã‚ºãŒã‚ã‚Šã¾ã›ã‚“';
                    option.disabled = true;
                    quizSelect.appendChild(option);
                    startSelectedQuizButton.disabled = true;
                    aiTutorButton.disabled = true;
                } else {
                    const requiredMasteryCount = appState.settings.masteryMode ? 2 : 1;
                    project.quizzes.forEach(quiz => {
                        const masteryData = (project.mastery && project.mastery[quiz.id]) ? project.mastery[quiz.id] : {};
                        const masteredCount = Object.values(masteryData).filter(count => count >= requiredMasteryCount).length;
                        const isFullyMastered = masteredCount === quiz.questions.length && quiz.questions.length > 0;
                        
                        const option = document.createElement('option');
                        option.value = quiz.id;
                        option.textContent = (isFullyMastered ? 'âœ… ' : '') + quiz.name;
                        quizSelect.appendChild(option);
                    });
                    startSelectedQuizButton.disabled = false;
                    aiTutorButton.disabled = false;
                    if (project.lastPlayedQuizId) {
                        quizSelect.value = project.lastPlayedQuizId;
                    }
                }
            };

            function shuffleArray(array) {
                const newArr = [...array];
                for (let i = newArr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
                }
                return newArr;
            };
            
            async function handleGenerateQuiz() {
                const buttonText = generateQuizButton.querySelector('.button-text');
                const spinner = generateQuizButton.querySelector('.spinner');
                generationError.classList.add('hidden');
                generationWarning.classList.add('hidden');
            
                if (promptText.value.trim() === '' && uploadedFiles.length === 0) {
                    generationError.textContent = 'ã‚¯ã‚¤ã‚ºã®å…ƒã«ãªã‚‹å†…å®¹ã‚’å…¥åŠ›ã¾ãŸã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚';
                    generationError.classList.remove('hidden');
                    return;
                }
            
                const warningTimeout = setTimeout(() => {
                    generationWarning.textContent = 'ç”Ÿæˆã«æ™‚é–“ãŒã‹ã‹ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™...';
                    generationWarning.classList.remove('hidden');
                }, 15000);
            
                buttonText.textContent = 'ç”Ÿæˆæº–å‚™ä¸­...';
                spinner.classList.remove('hidden');
                generateQuizButton.disabled = true;
                
                let payload;
            
                try {
                    // --- START: ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›å‡¦ç† ---
                    const processedFiles = [];
                    if (uploadedFiles.length > 0) {
                        const loadingModal = document.getElementById('loadingModal');
                        const loadingStatus = document.getElementById('loadingStatus');
                        loadingModal.classList.add('show');
                        
                        for (const file of uploadedFiles) {
                            if (file.isPdf) {
                                loadingStatus.textContent = `PDFã‚’ç”»åƒã«å¤‰æ›ä¸­: ${file.name}`;
                                const pdf = await pdfjsLib.getDocument({ data: file.pdfData }).promise;
                                for (let i = 1; i <= pdf.numPages; i++) {
                                    loadingStatus.textContent = `PDFã‚’ç”»åƒã«å¤‰æ›ä¸­... (${i}/${pdf.numPages}ãƒšãƒ¼ã‚¸)`;
                                    const page = await pdf.getPage(i);
                                    const viewport = page.getViewport({ scale: 1.5 });
                                    const canvas = document.createElement('canvas');
                                    canvas.height = viewport.height;
                                    canvas.width = viewport.width;
                                    await page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise;
                                    processedFiles.push({
                                        mimeType: 'image/jpeg',
                                        content: canvas.toDataURL('image/jpeg', 0.8)
                                    });
                                }
                            } else {
                                processedFiles.push(file);
                            }
                        }
                        loadingModal.classList.remove('show');
                    }
                    // --- END: ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›å‡¦ç† ---
            
                    // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‰ã«ã€å‡¦ç†æ¸ˆã¿ã®ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚å¤‰æ•°ã«ä¿å­˜ã—ã¾ã™ã€‚
                    tempGeneratedImages = processedFiles.filter(f => f.mimeType && f.mimeType.startsWith('image/'));
            
                    buttonText.textContent = 'ç”Ÿæˆä¸­...';
            
                    const apiKey = "AIzaSyDBics-IMwGjNoh-2Rqj979DrinKEnyO1A";
                    const isAutoGenre = autoGenreCheckbox.checked;
                    const selectedType = questionType.value;
                    const numQuestions = genQuestionCount.value === 'all' ? 'å¯èƒ½ãªé™ã‚Šå¤šã' : `${genQuestionCount.value}å•`;
                    
                    let basePrompt = `ã‚ãªãŸã¯å„ªç§€ãªã‚¯ã‚¤ã‚ºç”ŸæˆAIã§ã™ã€‚æä¾›ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚„ç”»åƒã‚’åˆ†æã—ã€ä»¥ä¸‹ã®æŒ‡ç¤ºã«å¾“ã£ã¦è³ªã®é«˜ã„ã‚¯ã‚¤ã‚ºã‚’${numQuestions}ä½œæˆã—ã¦ãã ã•ã„ã€‚
                
                    # æŒ‡ç¤ºåˆ†æ
                    - ã‚‚ã—æä¾›ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆãŒã€Œã€‡ã€‡ã«ã¤ã„ã¦ã®å•é¡Œã‚’ä½œã£ã¦ã€ã®ã‚ˆã†ãªæŒ‡ç¤ºå½¢å¼ã§ã‚ã‚Œã°ã€ãã®æŒ‡ç¤ºã«å¾“ã£ã¦ã‚¯ã‚¤ã‚ºã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
                    - ã‚‚ã—æä¾›ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆãŒã€Œæ—¥æœ¬ã®é¦–éƒ½ã¯æ±äº¬ã§ã™ã€ã®ã‚ˆã†ãªäº‹å®Ÿã‚„æ–‡ç« ã§ã‚ã‚Œã°ã€ãã®å†…å®¹ã«åŸºã¥ã„ã¦ã‚¯ã‚¤ã‚ºã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
                    - æŒ‡ç¤ºè‡ªä½“ã‚’å•é¡Œæ–‡ã«ã™ã‚‹ã®ã§ã¯ãªãã€æŒ‡ç¤ºå†…å®¹ã«æ²¿ã£ãŸå•é¡Œã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
                    
                    # åŸºæœ¬ãƒ«ãƒ¼ãƒ«
                    ç”»åƒç¾¤ãŒPDFã®é€£ç¶šã—ãŸãƒšãƒ¼ã‚¸ã§ã‚ã‚‹å¯èƒ½æ€§ã‚‚è€ƒæ…®ã—ã€å…¨ä½“ã®æ–‡è„ˆã‚’ç†è§£ã—ã¦å•é¡Œã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚`;
            
                    if (isAutoGenre) {
                        basePrompt += `å†…å®¹ã‚’è¤‡æ•°ã®è¤‡æ•°ã®ã‚¸ãƒ£ãƒ³ãƒ«ã«åˆ†ã‘ã€å„ã‚¸ãƒ£ãƒ³ãƒ«ã”ã¨ã«å•é¡Œã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚`;
                    }
                    
                    basePrompt += `å„å•é¡Œã«ã¯ã€å†…å®¹ã«æœ€é©ãªå½¢å¼("multiple_choice", "multiple_select", "fill_in_the_blank", "sorting")ã‚’AIãŒåˆ¤æ–­ã—ã¦æŒ‡å®šã—ã€å¿…ãšè©³ç´°ãªè§£èª¬ã‚’æ—¥æœ¬èªã§ä»˜ã‘ã¦ãã ã•ã„ã€‚
            
                    # æ–‡ç« ã¨è¨­å•ã®åˆ†é›¢ãƒ«ãƒ¼ãƒ« (é‡è¦)
                    - å•é¡Œã®å‰æã¨ãªã‚‹é•·æ–‡ã€å¯¾è©±æ–‡ã€ã‚ã‚‹ã„ã¯ä¾‹æ–‡ãªã©ãŒã‚ã‚‹å ´åˆã¯ã€ãã®æ–‡ç« ã‚’ long_content ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«æ ¼ç´ã—ã¦ãã ã•ã„ã€‚
                    - question ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã¯ã€ã€Œç©ºæ¬„ã«æœ€ã‚‚é©åˆ‡ãªèªå¥ã‚’é¸ã³ãªã•ã„ã€ã‚„ã€Œã“ã®æ–‡ç« ã®è¦ç‚¹ã¯ä½•ã§ã™ã‹ï¼Ÿã€ã¨ã„ã£ãŸã€ãã®æ–‡ç« ã«å¯¾ã™ã‚‹è¨­å•ãã®ã‚‚ã®ã‚’æ ¼ç´ã—ã¦ãã ã•ã„ã€‚
                    - ã“ã®ãƒ«ãƒ¼ãƒ«ã¯ç‰¹ã«ã€è‹±æ–‡ã®ç©ºæ¬„è£œå……å•é¡Œã‚„èª­è§£å•é¡Œã§å³å¯†ã«å®ˆã£ã¦ãã ã•ã„ã€‚
            
                    # JSONå½¢å¼ã®å³å®ˆ
                    - "answer"ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã¯ã€å¿…ãš"options"ã‚„"items"é…åˆ—ã«å«ã¾ã‚Œã‚‹é¸æŠè‚¢ã®**ãƒ†ã‚­ã‚¹ãƒˆãã®ã‚‚ã®**ã‚’ã€é…åˆ—å½¢å¼ã§æ­£ç¢ºã«æ ¼ç´ã—ã¦ãã ã•ã„ã€‚ä¾‹: ["æ±äº¬éƒ½"]
                    - "options"ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã¯ã€è§£ç­”ã®é¸æŠè‚¢ã¨ãªã‚‹æ–‡å­—åˆ—ã®é…åˆ—ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚é¸æŠè‚¢ã®å‰ã«ã€ŒA:ã€ã®ã‚ˆã†ãªè¨˜å·ã¯ä¸è¦ã§ã™ã€‚`;
                    
                    if (selectedType !== 'auto_select') {
                        basePrompt += `\n# å•é¡Œå½¢å¼ã®å³å®ˆ\nå…¨ã¦ã®ã‚¯ã‚¤ã‚ºã®å•é¡Œå½¢å¼(JSONã®typeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰)ã¯ã€å¿…ãšã€Œ${selectedType}ã€ã«çµ±ä¸€ã—ã¦ãã ã•ã„ã€‚ä»–ã®å½¢å¼ã¯çµ¶å¯¾ã«ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚`;
                    }
                    
                    basePrompt += `ç”Ÿæˆã•ã‚Œã‚‹å•é¡Œã¯ã€æä¾›ã•ã‚ŒãŸæƒ…å ±æºã¨å®Œå…¨ã«ä¸€è‡´ã—ã€äº‹å®Ÿã¨ã—ã¦æ­£ç¢ºã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚`;
                    
                    payload = {
                        contents: [{ role: "user", parts: [] }],
                        generationConfig: { responseMimeType: "application/json" }
                    };
                    
                    const parts = [{ text: basePrompt }];
                    if (promptText.value.trim()) {
                        parts.push({ text: `\n\n--- ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ ---\n${promptText.value}` });
                    }
                    
                    processedFiles.forEach(file => {
                        parts.push({
                            inlineData: {
                                mimeType: file.mimeType,
                                data: file.content.split(',')[1]
                            }
                        });
                    });
                    payload.contents[0].parts = parts;
                    
                    let itemSchema = {
                        type: "OBJECT",
                        properties: {
                            question: { type: "STRING" },
                            type: { type: "STRING" },
                            options: { type: "ARRAY", items: { type: "STRING" } },
                            items: { type: "ARRAY", items: { type: "STRING" } },
                            answer: { type: "ARRAY", items: { type: "STRING" } },
                            explanation: { type: "STRING" },
                            long_content: { type: "STRING" },
                            image_source: { type: "BOOLEAN" }
                        },
                        required: ["question", "type", "answer", "explanation"]
                    };
            
                    if (isAutoGenre) {
                        payload.generationConfig.responseSchema = {
                            type: "OBJECT",
                            properties: {
                                "genres": {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            "genre_name": { type: "STRING" },
                                            "quizzes": { type: "ARRAY", items: itemSchema }
                                        },
                                        required: ["genre_name", "quizzes"]
                                    }
                                }
                            }
                        };
                    } else {
                        payload.generationConfig.responseSchema = {
                            type: "OBJECT",
                            properties: { "quizzes": { "type": "ARRAY", "items": itemSchema } }
                        };
                    }
                    
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
            
                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error("API Error Response:", errorBody);
                        throw new Error(`APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status})`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const generatedData = JSON.parse(result.candidates[0].content.parts[0].text);
                        
                        const processQuestions = (questions) => {
                            return questions.map(q => {
                                let processed = {...q};
                                if (!Array.isArray(processed.answer)) {
                                    processed.answer = [String(processed.answer)];
                                }
                                return processed;
                            });
                        };
            
                        if (isAutoGenre && generatedData.genres) {
                            const processedGenres = generatedData.genres.map(genre => ({
                                ...genre,
                                quizzes: processQuestions(genre.quizzes || [])
                            }));
                            handleAutoGenreResponse(processedGenres); 
                        } else if (generatedData.quizzes) {
                            tempGeneratedQuestions = processQuestions(generatedData.quizzes);
                            showNameQuizModal();
                        } else {
                            throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒæœŸå¾…ã•ã‚ŒãŸå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
                        }
                    } else {
                        console.error("Invalid API response structure:", result);
                        throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒç„¡åŠ¹ã€ã¾ãŸã¯ç©ºã§ã™ã€‚");
                    }
                } catch (error) {
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã«ã‚‚ä¸€æ™‚å¤‰æ•°ã‚’ç¢ºå®Ÿã«ã‚¯ãƒªã‚¢ã—ã¾ã™
                    tempGeneratedImages = [];
                    tempGeneratedQuestions = null;
                    console.error("Quiz generation failed:", error);
                    if(payload) {
                         console.error("Failed Payload:", JSON.stringify(payload, null, 2));
                    }
                    generationError.textContent = `ã‚¯ã‚¤ã‚ºã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
                    generationError.classList.remove('hidden');
                } finally {
                    clearTimeout(warningTimeout);
                    generationWarning.classList.add('hidden');
                    buttonText.textContent = 'ã‚¯ã‚¤ã‚ºã‚’ç”Ÿæˆã™ã‚‹';
                    spinner.classList.add('hidden');
                    generateQuizButton.disabled = false;
                }
            }

            function handleAutoGenreResponse(genres) {
                const project = appState.projects.find(p => p.id === activeProjectId);
                if (!project || !genres) return;
            
                genres.forEach(genre => {
                    if (genre.quizzes && genre.quizzes.length > 0) {
                        const newQuiz = {
                            id: `quiz_${Date.now()}_${Math.random()}`,
                            name: genre.genre_name,
                            createdAt: new Date().toISOString(),
                            questions: genre.quizzes,
                            // â˜…â˜…â˜… ä¿®æ­£ç‚¹: uploadedFiles ã‚’è¦‹ã‚‹ã®ã§ã¯ãªãã€å‡¦ç†æ¸ˆã¿ã® tempGeneratedImages ã‚’ä½¿ã† â˜…â˜…â˜…
                            images: tempGeneratedImages 
                        };
                        project.quizzes.push(newQuiz);
                        project.mastery[newQuiz.id] = {};
                    }
                });
            
                // â˜…â˜…â˜… è¿½åŠ : å‡¦ç†å®Œäº†å¾Œã«ä¸€æ™‚å¤‰æ•°ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ â˜…â˜…â˜…
                tempGeneratedImages = [];
                tempGeneratedQuestions = null; // å¿µã®ãŸã‚ã“ã¡ã‚‰ã‚‚ã‚¯ãƒªã‚¢
            
                saveState();
                setActiveProject(activeProjectId);
            };

            function showNameQuizModal() {
                const project = appState.projects.find(p => p.id === activeProjectId);
                if (!project) return;
                newQuizNameInput.value = `ã‚¯ã‚¤ã‚º ${project.quizzes.length + 1}`;
                nameQuizModal.classList.add('show');
                newQuizNameInput.focus();
                newQuizNameInput.select();
            };
            
            function closeNameQuizModal() {
                nameQuizModal.classList.remove('show');
                tempGeneratedQuestions = null;
                tempGeneratedImages = [];
            }

            function handleCreateQuiz() {
                const quizName = newQuizNameInput.value.trim();
                if (!quizName) {
                    newQuizNameInput.focus();
                    return;
                }
                const project = appState.projects.find(p => p.id === activeProjectId);

                if (project && tempGeneratedQuestions) {
                    const newQuiz = {
                        id: `quiz_${Date.now()}`,
                        name: quizName,
                        createdAt: new Date().toISOString(),
                        questions: tempGeneratedQuestions,
                        images: tempGeneratedImages
                    };
                    project.quizzes.push(newQuiz);
                    project.mastery[newQuiz.id] = {};
                    saveState();
                    tempGeneratedQuestions = null;
                    closeNameQuizModal();
                    setActiveProject(activeProjectId);
                } else {
                    alert("ã‚¯ã‚¤ã‚ºã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚AIã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãå–å¾—ã§ãã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
                    console.error("Quiz save failed: tempGeneratedQuestions is null or project not found.");
                }
            };

            function startQuiz(quiz) {
                if (sidebar.classList.contains('open')) {
                    toggleSidebar();
                }
                document.querySelectorAll('.project-menu').forEach(m => m.remove());
                if (!quiz || !quiz.questions || quiz.questions.length === 0) return;

                const project = appState.projects.find(p => p.id === activeProjectId);
                project.lastPlayedQuizId = quiz.id;
                saveState();
                
                const requiredMasteryCount = appState.settings.masteryMode ? 2 : 1;
                const masteryData = (project.mastery && project.mastery[quiz.id]) ? project.mastery[quiz.id] : {};
                
                let unmasteredIndices = quiz.questions
                    .map((_, index) => index)
                    .filter(index => (masteryData[index] || 0) < requiredMasteryCount);

                if (unmasteredIndices.length === 0) {
                     resetMasteryModal.classList.add('show');
                     resetMasteryModal.querySelector('.reset').onclick = () => {
                         project.mastery[quiz.id] = {};
                         saveState();
                         resetMasteryModal.classList.remove('show');
                         startQuiz(quiz);
                     };
                     resetMasteryModal.querySelector('.cancel').onclick = () => {
                         resetMasteryModal.classList.remove('show');
                     };
                     return;
                }
                
                const finalIndices = appState.settings.shuffleQuestions 
                    ? shuffleArray([...unmasteredIndices]) 
                    : unmasteredIndices;

                const questionLimit = appState.settings.questionCount;
                const questionsToAskIndices = finalIndices.slice(0, questionLimit);

                const questionsToAsk = questionsToAskIndices.map(index => quiz.questions[index]);
                
                currentQuiz = { 
                    ...quiz, 
                    questions: questionsToAsk,
                    originalIndices: questionsToAskIndices,
                    currentIndex: 0, 
                    score: 0, 
                    answeredQuestions: new Set() 
                };

                switchScreen('quiz');
                loadQuestion();
            };

            function loadQuestion() {
                feedbackMessageElement.style.visibility = 'hidden';
                feedbackMessageElement.classList.remove('correct-feedback', 'incorrect-feedback');
                feedbackResultElement.innerHTML = '';

                if (currentQuiz.currentIndex >= currentQuiz.questions.length) {
                    showQuizResult();
                    return;
                }

                const parent = optionsGridElement.parentNode;
                const newGrid = optionsGridElement.cloneNode(false);
                parent.replaceChild(newGrid, optionsGridElement);
                optionsGridElement = newGrid;

                const question = currentQuiz.questions[currentQuiz.currentIndex];
                questionTextElement.innerHTML = question.question;
                submissionArea.innerHTML = '';
                questionImage.classList.add('hidden');
                longContentBox.style.display = 'none';
                
                explanationContentElement.classList.remove('show');
                toggleExplanationButton.classList.add('hidden');
                toggleExplanationButton.textContent = 'è§£èª¬â–¼';


                if(question.image_source && currentQuiz.images && currentQuiz.images.length > 0) {
                    const imageForQuestion = currentQuiz.images.find(img => question.question.includes(img.name.split('.')[0]));
                    if(imageForQuestion) {
                        questionImage.src = imageForQuestion.content;
                        questionImage.classList.remove('hidden');
                    }
                }

                if (question.long_content) {
                    longContentBox.textContent = question.long_content;
                    longContentBox.style.display = 'block';
                }

                switch(question.type) {
                    case 'multiple_choice':
                        (appState.settings.shuffleQuestions ? shuffleArray([...question.options]) : [...question.options]).forEach(option => {
                            const button = document.createElement('button');
                            button.innerHTML = option;
                            button.classList.add('option-button');
                            button.dataset.option = option;
                            button.addEventListener('click', () => submitAnswer([option]));
                            optionsGridElement.appendChild(button);
                        });
                        break;
                    case 'multiple_select':
                        (appState.settings.shuffleQuestions ? shuffleArray([...question.options]) : [...question.options]).forEach(option => {
                            const button = document.createElement('button');
                            button.innerHTML = option;
                            button.classList.add('option-button');
                            button.dataset.option = option;
                            button.addEventListener('click', () => button.classList.toggle('selected'));
                            optionsGridElement.appendChild(button);
                        });
                        createSubmitButton();
                        break;
                    case 'fill_in_the_blank':
                        optionsGridElement.innerHTML = `<input type="text" id="fillInBlankInput" placeholder="ç­”ãˆã‚’å…¥åŠ›...">`;
                        createSubmitButton();
                        break;
                    case 'sorting':
                        optionsGridElement.classList.add('options-grid-full-width');
                        optionsGridElement.innerHTML = `
                            <div class="sorting-container">
                                <div>
                                    <h4 class="font-semibold mb-2 text-center">è§£ç­”æ¬„</h4>
                                    <div id="sortingTarget" class="sorting-box"></div>
                                </div>
                                <div>
                                    <h4 class="font-semibold mb-2 text-center">é¸æŠè‚¢</h4>
                                    <div id="sortingSource" class="sorting-box"></div>
                                </div>
                            </div>`;
                        const sourceContainer = document.getElementById('sortingSource');
                        const shuffledItems = shuffleArray([...question.items]);
                        shuffledItems.forEach(itemText => {
                            const div = document.createElement('div');
                            div.innerHTML = itemText;
                            div.classList.add('option-button', 'sorting-item');
                            div.draggable = true;
                            sourceContainer.appendChild(div);
                        });
                        setupSortingInteractions();
                        createSubmitButton();
                        break;
                    default: 
                         optionsGridElement.innerHTML = `<p class="text-red-500">ä¸æ˜ãªå•é¡Œå½¢å¼ã§ã™ã€‚</p>`;
                         currentQuiz.answeredQuestions.add(question.question);
                        break;
                }
                if(question.type !== 'sorting') {
                    optionsGridElement.classList.remove('options-grid-full-width');
                }

                updateProgressBar();
                updateNavigationButtons();
            };
            
            function createSubmitButton() {
                const submitBtn = document.createElement('button');
                submitBtn.textContent = 'å›ç­”';
                submitBtn.classList.add('btn', 'btn-primary');
                submitBtn.addEventListener('click', () => {
                    const question = currentQuiz.questions[currentQuiz.currentIndex];
                    let answer;
                    switch(question.type) {
                        case 'multiple_select':
                            answer = Array.from(optionsGridElement.querySelectorAll('.option-button.selected')).map(btn => btn.dataset.option);
                            break;
                        case 'fill_in_the_blank':
                            answer = [document.getElementById('fillInBlankInput').value];
                            break;
                        case 'sorting':
                             answer = Array.from(document.getElementById('sortingTarget').querySelectorAll('.sorting-item')).map(item => item.textContent);
                             break;
                    }
                    submitAnswer(answer);
                });
                submissionArea.appendChild(submitBtn);
            }

            function submitAnswer(userAnswer) {
                const question = currentQuiz.questions[currentQuiz.currentIndex];
                if (currentQuiz.answeredQuestions.has(question.question)) return;

                let isCorrect = false;

                switch(question.type) {
                    case 'multiple_choice':
                    case 'fill_in_the_blank':
                        isCorrect = userAnswer[0].toLowerCase().trim() === question.answer[0].toLowerCase().trim();
                        break;
                    case 'multiple_select':
                        const sortedUserAnswer = [...userAnswer].sort();
                        const sortedCorrectAnswer = [...question.answer].sort();
                        isCorrect = JSON.stringify(sortedUserAnswer) === JSON.stringify(sortedCorrectAnswer);
                        break;
                    case 'sorting':
                        isCorrect = JSON.stringify(userAnswer) === JSON.stringify(question.items);
                        break;
                }
                
                showFeedback(isCorrect, question, userAnswer);
            };

            function showFeedback(isCorrect, question, userAnswer) {
                optionsGridElement.querySelectorAll('button, input, .sorting-item').forEach(el => {
                    el.disabled = true;
                });
                submissionArea.innerHTML = '';
                feedbackMessageElement.style.visibility = 'visible';
                const project = appState.projects.find(p => p.id === activeProjectId);
                const originalIndex = currentQuiz.originalIndices[currentQuiz.currentIndex];
                if (!project.mastery[currentQuiz.id]) {
                    project.mastery[currentQuiz.id] = {};
                }
                const currentMasteryCount = project.mastery[currentQuiz.id][originalIndex] || 0;


                if (isCorrect) {
                    playSound('correct');
                    feedbackResultElement.innerHTML = `<strong>æ­£è§£ï¼</strong>`;
                    feedbackMessageElement.classList.add('correct-feedback');
                    currentQuiz.score++;
                    project.mastery[currentQuiz.id][originalIndex] = currentMasteryCount + 1;

                } else {
                    playSound('incorrect');
                    let correctAnswerText;
                    if (question.type === 'sorting') {
                        correctAnswerText = question.items.join(' â†’ ');
                    } else {
                        correctAnswerText = Array.isArray(question.answer) ? question.answer.join(', ') : question.answer;
                    }
                    feedbackResultElement.innerHTML = `<strong>ä¸æ­£è§£...</strong> æ­£è§£ã¯ã€Œ${correctAnswerText}ã€ã§ã—ãŸã€‚`;
                    feedbackMessageElement.classList.add('incorrect-feedback');
                    project.mastery[currentQuiz.id][originalIndex] = 0;
                }
                saveState();
                
                currentQuiz.answeredQuestions.add(question.question);

                if (question.type === 'multiple_choice') {
                    optionsGridElement.querySelectorAll('.option-button').forEach(button => {
                        if (button.dataset.option === question.answer[0]) {
                            button.classList.add('correct');
                        } else if (button.dataset.option === userAnswer[0]) {
                            button.classList.add('incorrect');
                        }
                    });
                } else if (question.type === 'multiple_select') {
                    optionsGridElement.querySelectorAll('.option-button').forEach(button => {
                        const isCorrectAnswer = question.answer.includes(button.dataset.option);
                        const wasSelected = userAnswer.includes(button.dataset.option);
                        if (isCorrectAnswer) {
                            button.classList.add('correct');
                        } else if (wasSelected && !isCorrectAnswer) {
                            button.classList.add('incorrect');
                        }
                    });
                } else if(question.type === 'fill_in_the_blank') {
                    document.getElementById('fillInBlankInput').classList.add(isCorrect ? 'correct' : 'incorrect');
                }

                if (question.explanation) {
                    explanationTextElement.textContent = question.explanation;
                    toggleExplanationButton.classList.remove('hidden');
                }
                updateNavigationButtons();
            };
            
            function setupSortingInteractions() {
                const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
                const sourceContainer = document.getElementById('sortingSource');
                const targetContainer = document.getElementById('sortingTarget');

                const moveItem = (item) => {
                    if (item.parentElement === sourceContainer) {
                        targetContainer.appendChild(item);
                    } else {
                        sourceContainer.appendChild(item);
                    }
                };
                
                if (isTouchDevice) {
                    optionsGridElement.addEventListener('click', (e) => {
                        if (e.target.classList.contains('sorting-item')) {
                            moveItem(e.target);
                        }
                    });
                } else {
                    let draggedItem = null;
                    optionsGridElement.addEventListener('dragstart', (e) => {
                        if (e.target.classList.contains('sorting-item')) {
                            draggedItem = e.target;
                            setTimeout(() => e.target.classList.add('dragging'), 0);
                        }
                    });
                    optionsGridElement.addEventListener('dragend', (e) => {
                        if (draggedItem) {
                            draggedItem.classList.remove('dragging');
                            draggedItem = null;
                        }
                    });
                    [sourceContainer, targetContainer].forEach(container => {
                        container.addEventListener('dragover', e => {
                            e.preventDefault();
                            const afterElement = getDragAfterElement(container, e.clientY);
                            if (draggedItem) {
                                if (afterElement == null) {
                                    container.appendChild(draggedItem);
                                } else {
                                    container.insertBefore(draggedItem, afterElement);
                                }
                            }
                        });
                    });
                }
            };


            function updateNavigationButtons() {
                const question = currentQuiz.questions[currentQuiz.currentIndex];
                if (!question) {
                    nextButton.style.display = 'none';
                    return;
                }
                const isAnswered = currentQuiz.answeredQuestions.has(question.question);
                nextButton.style.display = isAnswered ? 'block' : 'none';
                nextButton.textContent = (currentQuiz.currentIndex === currentQuiz.questions.length - 1) ? 'çµæœã‚’è¦‹ã‚‹' : 'æ¬¡ã®å•é¡Œ';
            };

            function updateProgressBar() {
                if (!appState.settings.showProgress) {
                    progressBarContainer.style.display = 'none';
                    progressText.style.display = 'none';
                    return;
                }
                progressBarContainer.style.display = 'block';
                progressText.style.display = 'block';
                const total = currentQuiz.questions.length;
                const current = currentQuiz.currentIndex + 1;
                const progress = total > 0 ? current / total : 0;
                progressBar.style.width = `${progress * 100}%`;
                progressText.textContent = `${Math.min(current, total)} / ${total} å•ç›®`;
            };

            function showQuizResult() {
                switchScreen('result');
                const total = currentQuiz.questions.length;
                finalScore.textContent = `ã‚ãªãŸã®ã‚¹ã‚³ã‚¢: ${currentQuiz.score} / ${total}`;
                const percentage = total === 0 ? 0 : (currentQuiz.score / total) * 100;
                let comment = '';
                if (currentQuiz.score === total && total > 0) {
                    comment = 'ç´ æ™´ã‚‰ã—ã„ï¼å…¨å•æ­£è§£ã§ã™ï¼ğŸ‰';
                    playSound('fanfare');
                    setTimeout(launchConfetti, 100);
                } else if (percentage >= 80) {
                    comment = 'ã‚ˆãã§ãã¾ã—ãŸï¼ã“ã®èª¿å­ã§é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼âœ¨';
                } else if (percentage >= 50) {
                    comment = 'ã‚‚ã†å°‘ã—ã§ã™ï¼å¾©ç¿’ã—ã¦ã€ã•ã‚‰ã«ä¸Šã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ï¼ğŸ‘';
                } else {
                    comment = 'é ‘å¼µã‚ã†ï¼åŸºç¤ã‚’ã—ã£ã‹ã‚Šå›ºã‚ã¦ã„ãã¾ã—ã‚‡ã†ï¼ğŸ’ª';
                }
                scoreComment.textContent = comment;
            };

            function launchConfetti() {
                if (confettiAnimationId) cancelAnimationFrame(confettiAnimationId);
                confettiContainer.innerHTML = '';
                const confettiPieces = [];
                const numConfetti = 100;
                const colors = ['#f43f5e', '#38bdf8', '#fbbf24', '#34d399', '#8b5cf6'];
                for (let i = 0; i < numConfetti; i++) {
                    const confetti = document.createElement('div');
                    confetti.classList.add('confetti');
                    confetti.style.backgroundColor = colors[i % colors.length];
                    confettiContainer.appendChild(confetti);
                    const piece = { element: confetti, x: confettiContainer.clientWidth / 2, y: confettiContainer.clientHeight, vx: (Math.random() - 0.5) * 10, vy: -Math.random() * 15 - 5, rotation: Math.random() * 360, rotationSpeed: (Math.random() - 0.5) * 20 };
                    confettiPieces.push(piece);
                }
                let startTime = null;
                function animate(timestamp) {
                    if (!startTime) startTime = timestamp;
                    let allOffScreen = true;
                    confettiPieces.forEach(p => {
                        p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.vx *= 0.99; p.rotation += p.rotationSpeed;
                        if (p.y < confettiContainer.clientHeight + 20) allOffScreen = false;
                        p.element.style.transform = `translate(${p.x}px, ${p.y}px) rotate(${p.rotation}deg)`;
                    });
                    if (allOffScreen && (timestamp - startTime) > 1000) {
                        cancelAnimationFrame(confettiAnimationId);
                    } else {
                        confettiAnimationId = requestAnimationFrame(animate);
                    }
                }
                confettiAnimationId = requestAnimationFrame(animate);
            };
            
            function hexToRgb(hex) {
                let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            }

            function applyColors(themeName, isDark) {
                const root = document.documentElement;
                const themes = {
                     'default': { base: '#0ea5e9', hover: '#0284c7', darkBase: '#38bdf8', darkHover: '#0ea5e9' },
                     'red': { base: '#ef4444', hover: '#dc2626', darkBase: '#f87171', darkHover: '#ef4444' },
                     'green': { base: '#10b981', hover: '#059669', darkBase: '#4ade80', darkHover: '#10b981' },
                     'indigo': { base: '#6366f1', hover: '#4f46e5', darkBase: '#818cf8', darkHover: '#6366f1' }
                };
                const theme = themes[themeName] || themes.default;
                const accentColor = isDark ? theme.darkBase : theme.base;
                const accentHover = isDark ? theme.darkHover : theme.hover;
                const rgb = hexToRgb(accentColor);

                root.style.setProperty('--accent-primary', accentColor);
                root.style.setProperty('--accent-primary-hover', accentHover);
                root.style.setProperty('--accent-primary-shadow', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.3)`);
                root.style.setProperty('--progress-bar-bg', accentColor);
                
                if (isDark) {
                    root.style.setProperty('--themed-text-color', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.9)`);
                    root.style.setProperty('--bg-tertiary', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.2)`);
                    root.style.setProperty('--bg-welcome', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.15)`);
                } else {
                    root.style.setProperty('--themed-text-color', theme.hover);
                    root.style.setProperty('--bg-tertiary', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.1)`);
                    root.style.setProperty('--bg-welcome', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.05)`);
                }
            };
            
            function setDarkMode(isDark) {
                appState.settings.darkMode = isDark;
                document.body.classList.toggle('dark-mode', isDark);
                applyColors(appState.settings.themeColor, isDark);
                document.querySelector('meta[name="theme-color"]').content = isDark ? '#0f172a' : '#f0f9ff';
                saveState();
            };

            function setThemeColor(themeName) {
                appState.settings.themeColor = themeName;
                applyColors(themeName, appState.settings.darkMode);
                saveState();
            };

            // æ—¢å­˜ã®handleFileSelecté–¢æ•°ã‚’ã€ä»¥ä¸‹ã®å†…å®¹ã§ã¾ã‚‹ã”ã¨ç½®ãæ›ãˆã¦ãã ã•ã„
async function handleFileSelect(files) {
    fileUpload.disabled = true;
    generationError.classList.add('hidden');

    // --- NEW: å‡¦ç†ä¸­ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º ---
    const loadingModal = document.getElementById('loadingModal');
    const loadingStatus = document.getElementById('loadingStatus');
    loadingStatus.textContent = '';
    loadingModal.classList.add('show');
    
    const filePromises = Array.from(files).map(file => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            
            if (file.type === 'application/pdf') {
                loadingStatus.textContent = `PDFã‚’è§£æä¸­: ${file.name}`;
                reader.onload = async (e) => {
                    try {
                        const pdfData = new Uint8Array(e.target.result);
                        const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                        const numPages = pdf.numPages;

                        // --- MODIFIED: æœ€åˆã®1ãƒšãƒ¼ã‚¸ã ã‘ã‚’å…ˆã«ç”»åƒåŒ– ---
                        const page = await pdf.getPage(1);
                        const viewport = page.getViewport({ scale: 1.5 });
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        await page.render({ canvasContext: context, viewport: viewport }).promise;
                        
                        const firstPageDataUrl = canvas.toDataURL('image/jpeg', 0.8);

                        // --- MODIFIED: PDFå°‚ç”¨ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦è¿”ã™ ---
                        const pdfResult = {
                            id: `file_${Date.now()}_${Math.random()}`,
                            isPdf: true,
                            name: file.name,
                            numPages: numPages,
                            firstPageDataUrl: firstPageDataUrl,
                            pdfData: pdfData // æ®‹ã‚Šã®ãƒšãƒ¼ã‚¸ã‚’å¾Œã§å‡¦ç†ã™ã‚‹ãŸã‚ã«ç”Ÿã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
                        };
                        resolve([pdfResult]);

                    } catch (pdfError) {
                        reject(pdfError);
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                // PDFä»¥å¤–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç† (ç”»åƒãªã©)
                reader.onload = (e) => resolve([{ 
                    id: `file_${Date.now()}_${Math.random()}`,
                    isPdf: false,
                    name: file.name, 
                    content: e.target.result,
                    mimeType: file.type 
                }]);
                reader.onerror = (err) => reject(err);
                reader.readAsDataURL(file);
            }
        });
    });

    try {
        const results = await Promise.all(filePromises);
        const flattenedResults = results.flat(); 
        uploadedFiles.push(...flattenedResults);
        await updateUIAfterFileUpload(); 
    } catch (err) {
        console.error("File processing error:", err);
        generationError.textContent = `ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`;
        generationError.classList.remove('hidden');
    } finally {
        fileUpload.value = '';
        fileUpload.disabled = false;
        // --- NEW: å‡¦ç†ä¸­ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º ---
        loadingModal.classList.remove('show');
    }
};

            // æ—¢å­˜ã®updateUIAfterFileUploadé–¢æ•°ã‚’ã€ä»¥ä¸‹ã®å†…å®¹ã§ã¾ã‚‹ã”ã¨ç½®ãæ›ãˆã¦ãã ã•ã„
async function updateUIAfterFileUpload() {
    filePreviewContainer.innerHTML = '';
    for (const file of uploadedFiles) {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'file-preview-item';
        itemDiv.dataset.fileId = file.id; // --- MODIFIED: ãƒ¦ãƒ‹ãƒ¼ã‚¯IDã‚’ä»˜ä¸ ---

        // --- NEW: PDFã®å ´åˆã®ç‰¹åˆ¥ãªãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‡¦ç† ---
        if (file.isPdf) {
            itemDiv.style.alignItems = 'stretch'; // ã‚³ãƒ³ãƒ†ãƒŠã®å¹…ã‚’å­è¦ç´ ã«åˆã‚ã›ã‚‹
            
            const pdfContainer = document.createElement('div');
            pdfContainer.style.display = 'flex';
            pdfContainer.style.flexDirection = 'column';
            pdfContainer.style.alignItems = 'center';

            const img = document.createElement('img');
            img.src = file.firstPageDataUrl;
            pdfContainer.appendChild(img);
            
            if (file.numPages > 1) {
                const summaryDiv = document.createElement('div');
                summaryDiv.style.textAlign = 'center';
                summaryDiv.style.marginTop = '8px';

                const summaryText = document.createElement('p');
                summaryText.className = 'text-gray-500 dark:text-gray-400 text-sm';
                summaryText.textContent = `...ãã®ä»– ${file.numPages - 1} ãƒšãƒ¼ã‚¸`;

                const viewAllBtn = document.createElement('button');
                viewAllBtn.textContent = 'ã™ã¹ã¦è¦‹ã‚‹';
                viewAllBtn.className = 'text-sm font-bold cursor-pointer';
                viewAllBtn.style.color = 'var(--accent-primary)';
                viewAllBtn.style.marginTop = '4px';
                viewAllBtn.style.background = 'none';
                viewAllBtn.style.border = 'none';
                viewAllBtn.style.padding = '0';

                summaryDiv.appendChild(summaryText);
                summaryDiv.appendChild(viewAllBtn);
                pdfContainer.appendChild(summaryDiv);
                
                // ã€Œã™ã¹ã¦è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                viewAllBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    summaryDiv.innerHTML = '<p class="text-sm">ç”»åƒã‚’ç”Ÿæˆä¸­...</p>';
                    
                    try {
                        const pdf = await pdfjsLib.getDocument({ data: file.pdfData }).promise;
                        for (let i = 2; i <= file.numPages; i++) { // 2ãƒšãƒ¼ã‚¸ç›®ã‹ã‚‰å‡¦ç†
                            const page = await pdf.getPage(i);
                            const viewport = page.getViewport({ scale: 1.5 });
                            const canvas = document.createElement('canvas');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            await page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise;
                            
                            const newImg = document.createElement('img');
                            newImg.src = canvas.toDataURL('image/jpeg', 0.8);
                            newImg.style.marginTop = '8px';
                            pdfContainer.appendChild(newImg);
                        }
                        summaryDiv.remove(); // å‡¦ç†ãŒçµ‚ã‚ã£ãŸã‚‰ã‚µãƒãƒªãƒ¼ã‚’æ¶ˆã™
                    } catch (err) {
                        summaryDiv.innerHTML = '<p class="text-sm text-red-500">ã‚¨ãƒ©ãƒ¼</p>';
                        console.error("Error rendering PDF pages:", err);
                    }
                });
            }
            itemDiv.appendChild(pdfContainer);

        } else if (file.mimeType.startsWith('image/')) {
            const img = document.createElement('img');
            img.src = file.content;
            itemDiv.appendChild(img);
        } else {
            const icon = document.createElement('div');
            icon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>`;
            itemDiv.appendChild(icon);
        }

        const p = document.createElement('p');
        p.className = 'file-name';
        p.textContent = file.name;
        itemDiv.appendChild(p);
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-file-btn';
        removeBtn.innerHTML = '&times;';
        removeBtn.onclick = (e) => {
            e.stopPropagation();
            // --- MODIFIED: ãƒ¦ãƒ‹ãƒ¼ã‚¯IDã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ã—ã¦å‰Šé™¤ ---
            const fileIdToRemove = itemDiv.dataset.fileId; 
            const fileIndex = uploadedFiles.findIndex(f => f.id === fileIdToRemove);
            if(fileIndex > -1){
                uploadedFiles.splice(fileIndex, 1);
            }
            updateUIAfterFileUpload();
        };
        itemDiv.appendChild(removeBtn);
        filePreviewContainer.appendChild(itemDiv);
    }

    if (uploadedFiles.length > 0) {
        promptLabel.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®è¿½åŠ æŒ‡ç¤º (ä»»æ„)';
        promptText.placeholder = 'ä¾‹: ã“ã®å†…å®¹ã«ã¤ã„ã¦5å•ä½œæˆã—ã¦ãã ã•ã„ã€‚';
    } else {
        resetUploadUI();
    }
};

            function resetUploadUI() {
                uploadedFiles = [];
                filePreviewContainer.innerHTML = '';
                fileUpload.value = ''; 
                promptLabel.textContent = 'ã‚¯ã‚¤ã‚ºã«ã—ãŸã„å†…å®¹ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰';
                promptText.placeholder = 'ä¾‹:ã€Œè‹±èªã®é•·æ–‡å•é¡Œã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚ä¸­å­¦ãƒ¬ãƒ™ãƒ«ã§ã€ãƒã‚¹ã‚¿ãƒ¼ã‹ã‚‰å†…å®¹ã‚’â€¦ã€ã€€ã¾ãŸã¯ã€€ã€Œæ—¥æœ¬ã®é¦–éƒ½ã¯æ±äº¬ã§ã™ã€‚æµ·ãªã—çœŒã¯â€¦ã€';
            };
            
            async function handleExportProject(projectId) {
                const projectToExport = appState.projects.find(p => p.id === projectId);
                if (!projectToExport) {
                    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯¾è±¡ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                    return;
                }

                const exportableProject = JSON.parse(JSON.stringify(projectToExport));
                delete exportableProject.isPinned;
                delete exportableProject.lastPlayedQuizId;

                const projectJson = JSON.stringify(exportableProject);
                const blob = new Blob([projectJson], { type: 'text/plain' });
                const fileName = `${projectToExport.name}.txt`;
                const file = new File([blob], fileName, { type: 'text/plain' });

                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            title: projectToExport.name,
                            text: `ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Qubeã§èª­ã¿è¾¼ã‚“ã§ã€å‹é”ãŒä½œã£ãŸã€Œ${projectToExport.name}ã€ã«æŒ‘æˆ¦ã—ã¦ã¿ã‚ˆã†ï¼`,
                            files: [file],
                        });
                    } catch (error) {
                        console.log('å…±æœ‰ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‹ã€å¤±æ•—ã—ã¾ã—ãŸ:', error);
                    }
                } else {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            };

            function handleImportProject() {
Â  Â  Â  Â  Â  Â  Â  Â  const file = importFileInput.files[0];
Â  Â  Â  Â  Â  Â  Â  Â  importStatusMessage.textContent = '';

Â  Â  Â  Â  Â  Â  Â  Â  if (!file) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  importStatusMessage.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  importStatusMessage.style.color = 'red';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const reader = new FileReader();

Â  Â  Â  Â  Â  Â  Â  Â  reader.onload = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const importedText = e.target.result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!importedText) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã‹ã€èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const importedProjectData = JSON.parse(importedText);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (typeof importedProjectData.name !== 'string' || !Array.isArray(importedProjectData.quizzes) || typeof importedProjectData.mastery !== 'object') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('Qubeã®æœ‰åŠ¹ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const activeProject = appState.projects.find(p => p.id === activeProjectId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!activeProject) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("èª­ã¿è¾¼ã¿å…ˆã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (activeProject.quizzes.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // æ—¢å­˜ã‚¯ã‚¤ã‚ºã‚ã‚Šï¼šãƒãƒ¼ã‚¸
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activeProject.quizzes.push(...(importedProjectData.quizzes || []));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (importMasteryCheckbox.checked) {
                                  Object.assign(activeProject.mastery, importedProjectData.mastery || {});
                               }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (importedProjectData.images) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activeProject.images = [...(activeProject.images || []), ...importedProjectData.images];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  importStatusMessage.textContent = `ã€Œ${activeProject.name}ã€ã«ã‚¯ã‚¤ã‚ºã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  importStatusMessage.style.color = 'green';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // æ—¢å­˜ã‚¯ã‚¤ã‚ºãªã—ï¼šç½®ãæ›ãˆ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activeProject.name = importedProjectData.name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activeProject.quizzes = importedProjectData.quizzes || [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (importMasteryCheckbox.checked) {
                                   activeProject.mastery = importedProjectData.mastery || {};
                               } else {
                                   activeProject.mastery = {};
                               }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activeProject.images = importedProjectData.images || [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  importStatusMessage.style.color = 'green';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveState();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderProjectList();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // å¯¾ç­–â‘¡ï¼šãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã¨ãƒªã‚¹ãƒˆã®æç”»ãŒå®Œäº†ã—ãŸã€Œå¾Œã€ã«ç”»é¢é·ç§»ã‚’å®Ÿè¡Œ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setActiveProject(activeProject.id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 0);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Import failed:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  importStatusMessage.textContent = `èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  importStatusMessage.style.color = 'red';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // â˜…â˜…â˜… å¯¾ç­–â‘ ï¼šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ãŒå…¨ã¦å®Œäº†ã—ã¦ã‹ã‚‰ãƒªã‚»ãƒƒãƒˆ â˜…â˜…â˜…
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ã“ã‚Œã§2å›ç›®ä»¥é™ã®ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚‚å¯èƒ½ã«ãªã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  importFileInput.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  reader.onerror = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  importStatusMessage.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  importStatusMessage.style.color = 'red';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ã‚¨ãƒ©ãƒ¼æ™‚ã«ã‚‚ãƒªã‚»ãƒƒãƒˆã‚’è©¦ã¿ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  importFileInput.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  // èª­ã¿è¾¼ã¿å‡¦ç†ã‚’é–‹å§‹
Â  Â  Â  Â  Â  Â  Â  Â  reader.readAsText(file);
Â  Â  Â  Â  Â  Â  };
            function showEditQuizzesModal() {
                const project = appState.projects.find(p => p.id === activeProjectId);
                if (!project) return;

                editQuizList.innerHTML = '';
                if (project.quizzes.length === 0) {
                    editQuizList.innerHTML = '<p class="text-gray-400 p-2">ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ã¾ã ã‚¯ã‚¤ã‚ºãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                } else {
                    project.quizzes.forEach(quiz => {
                        const quizEl = document.createElement('div');
                        quizEl.className = 'project-item';
                        quizEl.draggable = true;
                        quizEl.dataset.quizId = quiz.id;
                        quizEl.innerHTML = `
                            <span class="drag-handle">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                            </span>
                            <div class="project-name">${quiz.name}</div>
                            <button class="project-menu-btn" data-action="rename" data-quiz-id="${quiz.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-11.212 11.212-3.536.354.354-3.536L13.586 3.586z" /></svg>
                            </button>
                            <button class="project-menu-btn text-red-500" data-action="delete" data-quiz-id="${quiz.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                        `;
                        editQuizList.appendChild(quizEl);
                    });
                    addQuizDragDropListeners();
                }
                editQuizzesModal.classList.add('show');
            };

            function updateQuizOrder() {
                const project = appState.projects.find(p => p.id === activeProjectId);
                if (!project) return;
                const newOrderIds = Array.from(editQuizList.querySelectorAll('.project-item')).map(item => item.dataset.quizId);
                project.quizzes.sort((a, b) => newOrderIds.indexOf(a.id) - newOrderIds.indexOf(b.id));
                saveState();
                populateQuizSelect(project);
            };

            function addQuizDragDropListeners() {
                let draggedItem = null;

                editQuizList.querySelectorAll('.project-item').forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        draggedItem = item;
                        setTimeout(() => item.classList.add('dragging'), 0);
                    });
                    item.addEventListener('dragend', () => {
                        if (draggedItem) draggedItem.classList.remove('dragging');
                        draggedItem = null;
                    });
                });
                editQuizList.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(editQuizList, e.clientY);
                    if (draggedItem) {
                        if (afterElement == null) editQuizList.appendChild(draggedItem);
                        else editQuizList.insertBefore(draggedItem, afterElement);
                    }
                });
                editQuizList.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (!draggedItem) return;
                    updateQuizOrder();
                });

                let touchDraggedItem = null;
                const touchStart = (e) => {
                    const handle = e.target.closest('.drag-handle');
                    if (!handle) return;
                    e.preventDefault();
                    touchDraggedItem = handle.closest('.project-item');
                    touchDraggedItem.classList.add('dragging');
                    document.addEventListener('touchmove', touchMove, { passive: false });
                    document.addEventListener('touchend', touchEnd, { once: true });
                };
                const touchMove = (e) => {
                    if (!touchDraggedItem) return;
                    e.preventDefault();
                    const y = e.touches[0].clientY;
                    const afterElement = getDragAfterElement(editQuizList, y);
                    if (afterElement == null) editQuizList.appendChild(touchDraggedItem);
                    else editQuizList.insertBefore(touchDraggedItem, afterElement);
                };
                const touchEnd = () => {
                    if (!touchDraggedItem) return;
                    touchDraggedItem.classList.remove('dragging');
                    touchDraggedItem = null;
                    updateQuizOrder();
                    document.removeEventListener('touchmove', touchMove);
                };
                
                editQuizList.removeEventListener('touchstart', touchStart);
                editQuizList.addEventListener('touchstart', touchStart, { passive: false });
            };

            function handleQuizEditActions(e) {
                const button = e.target.closest('button');
                if (!button) return;
                
                const action = button.dataset.action;
                const id = button.dataset.quizId;
                if (!action || !id) return;

                quizToEditId = id;
                const project = appState.projects.find(p => p.id === activeProjectId);
                const quiz = project?.quizzes.find(q => q.id === quizToEditId);
                if (!quiz) return;

                if (action === 'rename') {
                    renameQuizNameInstanceInput.value = quiz.name;
                    renameQuizInstanceModal.classList.add('show');
                    renameQuizNameInstanceInput.focus();
                    renameQuizNameInstanceInput.select();
                } else if (action === 'delete') {
                    deleteQuizNameInstance.textContent = quiz.name;
                    deleteQuizInstanceModal.classList.add('show');
                }
            };

            function handleRenameQuiz() {
                const newName = renameQuizNameInstanceInput.value.trim();
                const project = appState.projects.find(p => p.id === activeProjectId);
                const quiz = project?.quizzes.find(q => q.id === quizToEditId);
                if (newName && quiz) {
                    quiz.name = newName;
                    saveState();
                    showEditQuizzesModal();
                    populateQuizSelect(project);
                }
                renameQuizInstanceModal.classList.remove('show');
                quizToEditId = null;
            };

            function handleDeleteQuiz() {
                const project = appState.projects.find(p => p.id === activeProjectId);
                if (project && quizToEditId) {
                    project.quizzes = project.quizzes.filter(q => q.id !== quizToEditId);
                    delete project.mastery[quizToEditId];
                    saveState();
                    
                    if (project.quizzes.length === 0) {
                        editQuizzesModal.classList.remove('show');
                        setActiveProject(project.id);
                    } else {
                        showEditQuizzesModal();
                        populateQuizSelect(project);
                    }
                }
                deleteQuizInstanceModal.classList.remove('show');
                quizToEditId = null;
            };

            async function startAiTutorMode() {
                if (Tone.context.state !== 'running') await Tone.start();
                playSound('click');

                const project = appState.projects.find(p => p.id === activeProjectId);
                const selectedQuizId = quizSelect.value;
                const quiz = project?.quizzes.find(q => q.id === selectedQuizId);

                if (!quiz || quiz.questions.length === 0) {
                    alert("AIãƒãƒ¥ãƒ¼ã‚¿ãƒ¼ã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã€å•é¡Œã‚’å«ã‚€ã‚¯ã‚¤ã‚ºã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                    return;
                }

                const question = quiz.questions[Math.floor(Math.random() * quiz.questions.length)];
                
                switchScreen('aiTutor');
                aiTutorChatLog.innerHTML = '';
                aiTutorInput.value = '';
                aiTutorSubmitButton.disabled = false;
                
                aiTutorInteractionCount = 0;
                aiTutorActionsContainer.innerHTML = '';
                aiTutorActionsContainer.classList.add('hidden');

                aiTutorQuestionText.innerHTML = `
                    <b>å•é¡Œ:</b> ${question.question}<br>
                    <b>æ­£è§£:</b> <span class="correct-answer">${question.answer.join(', ')}</span>
                `;
                
                const otherOptions = (question.options || question.items || []).filter(opt => !question.answer.includes(opt));
                otherOptionsContainer.innerHTML = `ä¸æ­£è§£ã®é¸æŠè‚¢: ${otherOptions.join(', ')}`;
                otherOptionsContainer.style.display = 'none';
                toggleOtherOptionsButton.textContent = 'ä»–ã®é¸æŠè‚¢ã‚’è¦‹ã‚‹â–¼';

                const initialPrompt = `ã‚ãªãŸã¯ã€è¦ªã—ã¿ã‚„ã™ãã€å¸¸ã«åŠ±ã¾ã—ã¦ãã‚Œã‚‹å„ªç§€ã§ãƒ—ãƒ­ã®å­¦ç¿’ã®ãƒãƒ¥ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚ã‹ã¤ã€ã‚ãªãŸã¯å¸¸ã«æ­£ã—ã„äº‹å®Ÿã«åŸºã¥ãã€é–“é•ã£ãŸã“ã¨ã‚’æ•™ãˆãªã„ã“ã¨ã‚’æ„è­˜ã—ã¦ãã ã•ã„ã€‚
                    ç”Ÿå¾’ãŒãªãœãã®ç­”ãˆãŒæ­£ã—ã„ã®ã‹ã‚’è‡ªåˆ†ã®è¨€è‘‰ã§èª¬æ˜ã™ã‚‹ã®ã‚’æ‰‹ä¼ã£ã¦ãã ã•ã„ã€‚
                    æ±ºã—ã¦ç­”ãˆã‚’ç›´æ¥æ•™ãˆãšã€ã‚½ã‚¯ãƒ©ãƒ†ã‚¹å¼å•ç­”æ³•ã®ã‚ˆã†ã«ã€ç”Ÿå¾’ã®æ€è€ƒã‚’ä¿ƒã™è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚
                    ç”Ÿå¾’ã®å›ç­”ã‚’åˆ†æã—ã€è¤’ã‚ãªãŒã‚‰ã€ã•ã‚‰ã«æ·±ã„ç†è§£ã¸ã¨å°ããŸã‚ã®è¿½åŠ ã®è³ªå•ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
                    ç”Ÿå¾’ã®èª¬æ˜ãŒé–“é•ã£ã¦ã„ã‚‹å ´åˆã¯ã€æ±ºã—ã¦ãã®é–“é•ã„ã‚’è‚¯å®šã—ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚ã¾ãšã€Œæƒœã—ã„ï¼ã¨ã¦ã‚‚è‰¯ã„è¦–ç‚¹ã§ã™ãŒã€å°‘ã—ã ã‘é•ã†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€ã®ã‚ˆã†ã«ã€ä¸€åº¦å—ã‘æ­¢ã‚ã¦ã‹ã‚‰å„ªã—ãé–“é•ã„ã§ã‚ã‚‹ã“ã¨ã‚’ä¼ãˆã¦ãã ã•ã„ã€‚ãã®å¾Œã€ã©ã“ãŒé•ã†ã®ã‹ã‚’è€ƒãˆã•ã›ã‚‹ã‚ˆã†ãªè³ªå•ã‚’ã—ã¦ã€æ­£ã—ã„ç†è§£ã«å°ã„ã¦ã‚ã’ã¦ãã ã•ã„ã€‚
                    å¿œç­”ã¯å¸¸ã«çŸ­ãã€å…¨ä½“ã§5ã€œ10æ–‡ç¨‹åº¦ã®ç°¡æ½”ãªæ–‡ç« ã«ã—ã¦ã€ä¸€åº¦ã«å¤šãã®ã“ã¨ã‚’èª¬æ˜ã™ã‚‹ã®ã§ã¯ãªãã€ä¸€ã¤ãšã¤æ®µéšçš„ã«é€²ã‚ã¦ãã ã•ã„ã€‚
                    é‡è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ã€Œ**å¤ªå­—**ã€ã§å¼·èª¿ã—ã€å¿…è¦ã«å¿œã˜ã¦ç®‡æ¡æ›¸ãï¼ˆãƒªã‚¹ãƒˆï¼‰ã‚’ä½¿ã„ã€æƒ…å ±ã‚’æ•´ç†ã—ã¦è¦‹ã‚„ã™ãã—ã¦ãã ã•ã„ã€‚
                    æ–‡è„ˆã«åˆã£ãŸãƒã‚¸ãƒ†ã‚£ãƒ–ãªçµµæ–‡å­—ï¼ˆä¾‹: âœ¨, ğŸ‘, ğŸ‰, ğŸ’¡ï¼‰ã‚’æ–‡æœ«ã«æ·»ãˆã¦ãã ã•ã„ã€‚æ€è€ƒã‚’ä¿ƒã™è³ªå•ã¨è§£èª¬ã®ã‚ˆã†ã«ã€è©±ã®åŒºåˆ‡ã‚Šã§ã¯æ”¹è¡Œã‚’é©åˆ‡ã«å…¥ã‚Œã¦ãã ã•ã„ã€‚
                    ç”Ÿå¾’ãŒå®Œå…¨ã«è¡Œãè©°ã¾ã£ãŸå ´åˆã«ã®ã¿ã€å°‘ã—ã ã‘ãƒ’ãƒ³ãƒˆã‚’ä¸ãˆã¦ãã ã•ã„ã€‚
                    å¸¸ã«æ—¥æœ¬èªã§å¿œç­”ã—ã¦ãã ã•ã„ã€‚
                    ç”Ÿå¾’ã®ç†è§£ãŒååˆ†ã«æ·±ã¾ã£ãŸã¨åˆ¤æ–­ã—ãŸå ´åˆã€æœ€å¾Œã«ã€Œã ã„ã¶ç†è§£ãŒæ·±ã¾ã£ãŸã­ï¼ã»ã‹ã®å•é¡Œã«ã¤ã„ã¦ã‚‚è€ƒãˆã¦ã¿ã‚ˆã†ï¼ã€ã®ã‚ˆã†ãªã¾ã¨ã‚ã®è¨€è‘‰ã‚’ã‹ã‘ã¦ãã ã•ã„ã€‚ãã®ã¾ã¨ã‚ã®è¨€è‘‰ã®ç›´å¾Œã«ã€å¿…ãšç‰¹åˆ¥ãªåˆå›³ã¨ã—ã¦ \`[NEXT_QUESTION_TRIGGER]\` ã¨ã„ã†æ–‡å­—åˆ—ã‚’å¿œç­”ã«å«ã‚ã¦ãã ã•ã„ã€‚
                    
                    ã€å•é¡Œã€‘: ${question.question}
                    ã€é¸æŠè‚¢ã€‘: ${(question.options || question.items).join(', ')}
                    ã€æ­£è§£ã€‘: ${question.answer.join(', ')}
                    ---
                    ã•ã‚ã€å§‹ã‚ã¾ã—ã‚‡ã†ï¼ã“ã®å•é¡Œã®æ­£è§£ãŒã€Œ${question.answer.join(', ')}ã€ã«ãªã‚‹ç†ç”±ã‚’ã€ã‚ãªãŸã®è¨€è‘‰ã§èª¬æ˜ã—ã¦ã¿ã¦ãã ã•ã„ã€‚`;
                
                aiChatHistory = [{ role: "user", parts: [{ text: initialPrompt }] }];
                
                appendMessageToChat(`ã“ã‚“ã«ã¡ã¯ï¼AIãƒãƒ¥ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚ä¸€ç·’ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼ğŸ’ª<br>ã“ã®å•é¡Œã®æ­£è§£ãŒã€Œ${question.answer.join(', ')}ã€ã«ãªã‚‹ç†ç”±ã‚’ã€ã‚ãªãŸã®è¨€è‘‰ã§èª¬æ˜ã—ã¦ã¿ã¦ãã ã•ã„ã€‚`, 'ai');
            };

            function appendMessageToChat(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('chat-message', sender);
                const formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                messageDiv.innerHTML = formattedText;
                aiTutorChatLog.appendChild(messageDiv);
                aiTutorChatLog.scrollTop = aiTutorChatLog.scrollHeight;
            };

            async function handleAiTutorSubmit(event) {
                event.preventDefault();
                const userInput = aiTutorInput.value.trim();
                if (!userInput) return;

                appendMessageToChat(userInput, 'user');
                aiTutorInput.value = '';
                aiTutorSubmitButton.disabled = true;

                const loadingIndicator = document.createElement('div');
                loadingIndicator.classList.add('chat-message', 'ai', 'loading');
                loadingIndicator.innerHTML = '<div class="dot-flashing"></div>';
                aiTutorChatLog.appendChild(loadingIndicator);
                aiTutorChatLog.scrollTop = aiTutorChatLog.scrollHeight;

                try {
                    aiChatHistory.push({ role: "user", parts: [{ text: userInput }] });
                    
                    const payload = { contents: aiChatHistory };
                    
                    // â˜…â˜…â˜… å¤‰æ›´ç®‡æ‰€ 1/2: ã“ã“ã«ã‚ãªãŸã®APIã‚­ãƒ¼ã‚’è¨­å®š â˜…â˜…â˜…
                    const apiKey = "AIzaSyDBics-IMwGjNoh-2Rqj979DrinKEnyO1A";

                    if (!apiKey || apiKey === "ã“ã“ã«ã‚ãªãŸã®Google AI APIã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘") {
                        throw new Error("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                    }
                    
                    // â˜…â˜…â˜… å¤‰æ›´ç®‡æ‰€ 2/2: ãƒ¢ãƒ‡ãƒ«åã‚’APIã‚­ãƒ¼å¿…é ˆã®ã‚‚ã®ã«æˆ»ã™ â˜…â˜…â˜…
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                         const errorBody = await response.json();
                         throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${errorBody.error.message}`);
                    }

                    const result = await response.json();
                    
                    aiTutorChatLog.removeChild(loadingIndicator);

                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const aiResponse = result.candidates[0].content.parts[0].text;
                         if (aiResponse.includes('[NEXT_QUESTION_TRIGGER]')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aiResponse = aiResponse.replace('[NEXT_QUESTION_TRIGGER]', '').trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nextQuestionModal = document.getElementById('nextQuestionModal');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nextQuestionModal.classList.add('show');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
                        appendMessageToChat(aiResponse.replace(/\n/g, '<br>'), 'ai');
                        aiChatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                        
                        aiTutorInteractionCount++;
                        if (aiTutorInteractionCount >= 2) {
                            const changeQuestionBtn = document.createElement('button');
                            changeQuestionBtn.textContent = 'å•é¡Œã‚’å¤‰ãˆã‚‹';
                            changeQuestionBtn.className = 'btn btn-sm';
                            changeQuestionBtn.style.backgroundColor = 'var(--button-bg-default)';
                            changeQuestionBtn.style.color = 'var(--button-text-default)';
                            changeQuestionBtn.style.border = '1px solid var(--border-color)';
                            changeQuestionBtn.onclick = () => startAiTutorMode();

                            aiTutorActionsContainer.innerHTML = '';
                            aiTutorActionsContainer.appendChild(changeQuestionBtn);
                            aiTutorActionsContainer.classList.remove('hidden');
                        }

                    } else {
                        // AIã‹ã‚‰ã®å¿œç­”ãŒç©ºã€ã¾ãŸã¯å½¢å¼ãŒä¸æ­£ãªå ´åˆ
                        throw new Error("AIã‹ã‚‰æœ‰åŠ¹ãªå¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
                    }
                } catch (error) {
                    console.error("AI Tutor Error:", error);
                    aiTutorChatLog.removeChild(loadingIndicator);
                    appendMessageToChat(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'ai');
                } finally {
                    aiTutorSubmitButton.disabled = false;
                    aiTutorInput.focus();
                }
            };
            modalConfirmNextQuestion.addEventListener('click', () => {
                nextQuestionModal.classList.remove('show');
                startAiTutorMode(); 
            });

            modalCancelNextQuestion.addEventListener('click', () => {
                nextQuestionModal.classList.remove('show');
            });
            
            function setupSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    speechRecognition = new SpeechRecognition();
                    speechRecognition.lang = 'ja-JP';
                    speechRecognition.interimResults = false;
                    speechRecognition.maxAlternatives = 1;

                    speechRecognition.onstart = () => {
                        isRecording = true;
                        voiceInputButton.classList.add('recording');
                        playSound('micOn');
                    };

                    speechRecognition.onend = () => {
                        isRecording = false;
                        voiceInputButton.classList.remove('recording');
                        playSound('micOff');
                    };

                    speechRecognition.onresult = (event) => {
                        const speechResult = event.results[0][0].transcript;
                        aiTutorInput.value = speechResult;
                        aiTutorInputForm.dispatchEvent(new Event('submit'));
                    };

                    speechRecognition.onerror = (event) => {
                        console.error('Speech recognition error', event.error);
                        isRecording = false;
                        voiceInputButton.classList.remove('recording');
                    };
                } else {
                    voiceInputButton.style.display = 'none';
                }
            };

            function init() {
                const splashScreen = document.getElementById('splashScreen');
                
                loadState();
                
                const { settings } = appState;
                setDarkMode(settings.darkMode);
                darkModeToggle.checked = settings.darkMode;
                
                themeColorCircles.forEach(c => c.classList.remove('selected'));
                document.querySelector(`.color-circle[data-theme="${settings.themeColor}"]`)?.classList.add('selected');
                
                soundVolumeSlider.value = settings.soundVolume;
                updateVolume(settings.soundVolume);

                questionCountSelect.value = settings.questionCount;
                shuffleQuestionsToggle.checked = settings.shuffleQuestions;
                showProgressToggle.checked = settings.showProgress;
                masteryModeToggle.checked = settings.masteryMode;

                const lastActiveProjectId = localStorage.getItem('qube_lastActiveProjectId');
                const projectExists = appState.projects.some(p => p.id === lastActiveProjectId);
                if (lastActiveProjectId && projectExists) {
                    setActiveProject(lastActiveProjectId);
                } else if (appState.projects.length > 0) {
                    setActiveProject(appState.projects[0].id);
                }
                else {
                    switchScreen('welcome');
                }
                renderProjectList();
                setupSpeechRecognition();
                
                setTimeout(() => {
                    splashScreen.classList.add('hidden');
                    splashScreen.addEventListener('transitionend', () => {
                        splashScreen.style.display = 'none';
                    }, { once: true });
                }, 1500);

                if (!localStorage.getItem('qube_tos_agreed')) {
                    tosModal.classList.add('show');
                }
                
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                const isInStandaloneMode = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

                if (isIOS && !isInStandaloneMode && !localStorage.getItem('qube_add_to_home_screen_dismissed')) {
                    const iosShareIconContainer = document.getElementById('iosShareIconContainer');
                    iosShareIconContainer.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>`;
                    setTimeout(() => {
                        addToHomeScreenPopup.style.display = 'block';
                    }, 5000);
                }
                
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('/sw.js').then(registration => {
                            console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        }).catch(error => {
                            console.log('ServiceWorker registration failed: ', error);
                        });
                    });
                }
            };
            // â˜…â˜…â˜… å¤‰æ›´ç®‡æ‰€ â˜…â˜…â˜… END

            // --- Event Listeners ---
            hamburgerButton.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);
            newProjectButton.addEventListener('click', showNewProjectModal);
            getStartedButton.addEventListener('click', showNewProjectModal);
            modalCreateProjectButton.addEventListener('click', handleCreateProject);
            modalCancelProjectButton.addEventListener('click', closeNewProjectModal);
            newProjectModal.addEventListener('click', (e) => { if (e.target === newProjectModal) closeNewProjectModal(); });
            newProjectNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleCreateProject(); });

            modalSaveRenameButton.addEventListener('click', handleRenameProject);
            modalCancelRenameButton.addEventListener('click', closeRenameProjectModal);
            renameProjectModal.addEventListener('click', (e) => { if (e.target === renameProjectModal) closeRenameProjectModal(); });
            renameProjectNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleRenameProject(); });
            
            generateNewQuizBtn.addEventListener('click', () => {
                const project = appState.projects.find(p => p.id === activeProjectId);
                if (project && project.quizzes.length === 0) {
                    backToProjectStartBtn.style.display = 'none';
                } else {
                    backToProjectStartBtn.style.display = 'block';
                }
                resetUploadUI();
                promptText.value = '';
                switchScreen('generate');
            });
            backToProjectStartBtn.addEventListener('click', () => setActiveProject(activeProjectId));
            generateQuizButton.addEventListener('click', handleGenerateQuiz);

            startSelectedQuizButton.addEventListener('click', () => {
                const selectedQuizId = quizSelect.value;
                const project = appState.projects.find(p => p.id === activeProjectId);
                if (project) {
                    const quizToStart = project.quizzes.find(q => q.id === selectedQuizId);
                    if (quizToStart) startQuiz(quizToStart);
                }
            });

            fileDropArea.addEventListener('click', () => fileUpload.click());
            fileUpload.addEventListener('change', (e) => handleFileSelect(e.target.files));
            fileDropArea.addEventListener('dragover', (e) => { e.preventDefault(); fileDropArea.classList.add('dragover'); });
            fileDropArea.addEventListener('dragleave', () => fileDropArea.classList.remove('dragover'));
            fileDropArea.addEventListener('drop', (e) => { e.preventDefault(); fileDropArea.classList.remove('dragover'); handleFileSelect(e.dataTransfer.files); });

            modalCreateQuizButton.addEventListener('click', handleCreateQuiz);
            modalCancelQuizButton.addEventListener('click', closeNameQuizModal);
            newQuizNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleCreateQuiz(); });

            interruptButton.addEventListener('click', () => {
                const isTutor = screens.aiTutor.classList.contains('active');
                const title = isTutor ? 'AIãƒãƒ¥ãƒ¼ã‚¿ãƒ¼ã‚’çµ‚äº†' : 'ã‚¯ã‚¤ã‚ºã‚’ä¸­æ–­';
                const message = isTutor ? 'ã“ã®å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ' : 'æœ¬å½“ã«ã‚¯ã‚¤ã‚ºã‚’ä¸­æ–­ã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®é€²æ—ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚';
                interruptModal.querySelector('.modal-title').textContent = title;
                interruptModal.querySelector('p').textContent = message;
                interruptModal.querySelector('.delete').textContent = isTutor ? 'çµ‚äº†ã™ã‚‹' : 'ä¸­æ–­ã™ã‚‹';
                interruptModal.classList.add('show');
            });
            modalCancelInterrupt.addEventListener('click', () => interruptModal.classList.remove('show'));
            modalConfirmInterrupt.addEventListener('click', () => {
                interruptModal.classList.remove('show');
                setActiveProject(activeProjectId);
            });

            modalConfirmDelete.addEventListener('click', handleDeleteProject);
            modalCancelDelete.addEventListener('click', closeDeleteProjectModal);

            nextButton.addEventListener('click', () => { playSound('click'); currentQuiz.currentIndex++; loadQuestion(); });
            toggleExplanationButton.addEventListener('click', () => { 
                explanationContentElement.classList.toggle('show'); 
                toggleExplanationButton.textContent = explanationContentElement.classList.contains('show') ? 'è§£èª¬â–²' : 'è§£èª¬â–¼'; 
            });
            
            restartQuizButton.addEventListener('click', () => {
                const project = appState.projects.find(p => p.id === activeProjectId);
                if (project && currentQuiz) {
                    const originalQuiz = project.quizzes.find(q => q.id === currentQuiz.id);
                    if (originalQuiz) {
                        startQuiz(originalQuiz);
                    }
                }
            });

            backToProjectButton.addEventListener('click', () => setActiveProject(activeProjectId));
            
            projectSettingsButton.addEventListener('click', () => settingsScreen.classList.add('active'));
            backToProjectFromSettings.addEventListener('click', () => settingsScreen.classList.remove('active'));
            settingsScreen.addEventListener('click', (e) => {
                if (e.target === settingsScreen) {
                    settingsScreen.classList.remove('active');
                }
            });
            
            darkModeToggle.addEventListener('change', (e) => setDarkMode(e.target.checked));
            
            themeColorCircles.forEach(circle => {
                circle.addEventListener('click', () => {
                    themeColorCircles.forEach(c => c.classList.remove('selected'));
                    circle.classList.add('selected');
                    setThemeColor(circle.dataset.theme);
                });
            });
            
            soundVolumeSlider.addEventListener('input', (e) => updateVolume(e.target.value));
            soundVolumeSlider.addEventListener('change', saveState);
            
            questionCountSelect.addEventListener('change', (e) => {
                appState.settings.questionCount = parseInt(e.target.value, 10);
                saveState();
            });

            shuffleQuestionsToggle.addEventListener('change', (e) => {
                appState.settings.shuffleQuestions = e.target.checked;
                saveState();
            });

            showProgressToggle.addEventListener('change', (e) => {
                appState.settings.showProgress = e.target.checked;
                saveState();
            });

            masteryModeToggle.addEventListener('change', (e) => {
                appState.settings.masteryMode = e.target.checked;
                saveState();
            });

            editQuizzesButton.addEventListener('click', () => {
                settingsScreen.classList.remove('active');
                showEditQuizzesModal();
            });
            closeEditQuizModalButton.addEventListener('click', () => editQuizzesModal.classList.remove('show'));
            editQuizList.addEventListener('click', handleQuizEditActions);

            renameQuizInstanceModal.querySelector('.save').addEventListener('click', handleRenameQuiz);
            renameQuizInstanceModal.querySelector('.cancel').addEventListener('click', () => renameQuizInstanceModal.classList.remove('show'));
            renameQuizNameInstanceInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleRenameQuiz(); });

            deleteQuizInstanceModal.querySelector('.delete').addEventListener('click', handleDeleteQuiz);
            deleteQuizInstanceModal.querySelector('.cancel').addEventListener('click', () => deleteQuizInstanceModal.classList.remove('show'));

            tosAgreeButton.addEventListener('click', () => {
                localStorage.setItem('qube_tos_agreed', 'true');
                tosModal.classList.remove('show');
            });

            closeAddToHomeScreen.addEventListener('click', () => {
                localStorage.setItem('qube_add_to_home_screen_dismissed', 'true');
                addToHomeScreenPopup.style.display = 'none';
            });
            
            generateTabButton.addEventListener('click', () => {
                generateTabButton.classList.add('active');
                importTabButton.classList.remove('active');
                generateProjectContainer.style.display = 'block';
                importProjectContainer.style.display = 'none';
            });

            importTabButton.addEventListener('click', () => {
                importTabButton.classList.add('active');
                generateTabButton.classList.remove('active');
                importProjectContainer.style.display = 'block';
                generateProjectContainer.style.display = 'none';
            });

            importProjectButton.addEventListener('click', () => {
    handleImportProject();
    importFileInput.value = '';
});

            exportProjectButton.addEventListener('click', () => {
                if(activeProjectId) {
                    handleExportProject(activeProjectId);
                } else {
                    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„ã€‚');
                }
            });

            aiTutorButton.addEventListener('click', startAiTutorMode);
            aiTutorInputForm.addEventListener('submit', handleAiTutorSubmit);
            voiceInputButton.addEventListener('click', () => {
                if (!speechRecognition) return;
                if (isRecording) {
                    speechRecognition.stop();
                } else {
                    speechRecognition.start();
                }
            });
            toggleOtherOptionsButton.addEventListener('click', () => {
                const isHidden = otherOptionsContainer.style.display === 'none';
                otherOptionsContainer.style.display = isHidden ? 'block' : 'none';
                toggleOtherOptionsButton.textContent = isHidden ? 'ä»–ã®é¸æŠè‚¢ã‚’éš ã™â–²' : 'ä»–ã®é¸æŠè‚¢ã‚’è¦‹ã‚‹â–¼';
            });

            window.addEventListener('resize', () => {
                const project = appState.projects.find(p => p.id === activeProjectId);
                updateProjectTitle(project?.name || 'Qube');
            });

            init();
        });
    </script>
</body>
</html>
