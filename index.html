<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qube - AI Quiz Generator</title>
    <!-- PWA settings -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Qube">
    <meta name="theme-color" content="#f0f9ff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        :root {
            --bg-primary: #f0f9ff;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e0f2fe;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent-primary: #0ea5e9;
            --accent-primary-hover: #0284c7;
            --accent-primary-shadow: rgba(14, 165, 233, 0.3);
            --border-color: #cbd5e1;
            --modal-bg: rgba(0, 0, 0, 0.5);
            --correct-bg: #dcfce7;
            --correct-border: #22c55e;
            --incorrect-bg: #fee2e2;
            --incorrect-border: #ef4444;
        }

        body.dark-mode {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #0c4a6e;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --accent-primary: #38bdf8;
            --accent-primary-hover: #0ea5e9;
            --accent-primary-shadow: rgba(56, 189, 248, 0.3);
            --border-color: #475569;
            --modal-bg: rgba(0, 0, 0, 0.7);
            --correct-bg: #166534;
            --correct-border: #4ade80;
            --incorrect-bg: #991b1b;
            --incorrect-border: #f87171;
        }

        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .main-container { display: flex; height: 100vh; width: 100%; overflow: hidden; }
        #sidebar { width: 280px; background-color: var(--bg-secondary); border-right: 1px solid var(--border-color); padding: 20px; display: flex; flex-direction: column; transition: transform 0.3s ease, box-shadow 0.3s ease; transform: translateX(-100%); position: fixed; top: 0; left: 0; height: 100%; z-index: 1000; }
        #sidebar.open { transform: translateX(0); box-shadow: 0 0 40px rgba(0,0,0,0.2); }
        #mainContent { flex-grow: 1; padding: 20px; overflow-y: auto; transition: margin-left 0.3s ease; }
        @media (min-width: 768px) { #sidebar { position: static; transform: translateX(0); box-shadow: none; } #mainContent { margin-left: 0; } #hamburgerButton { display: none; } }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
        .sidebar-overlay.active { display: block; }
        .screen { display: none; }
        .screen.active { display: block; }
        .btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; border: none; }
        .btn-primary { background-color: var(--accent-primary); color: white; box-shadow: 0 4px 12px var(--accent-primary-shadow); }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-primary-hover); transform: translateY(-2px); }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; }
        .form-group textarea { min-height: 150px; resize: vertical; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-bg); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--bg-secondary); padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); max-width: 400px; width: 90%; transform: translateY(-20px) scale(0.95); transition: transform 0.3s ease, background-color 0.3s ease; }
        .modal.show .modal-content { transform: translateY(0) scale(1); }
        .modal-title { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 20px; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
        .modal-button { padding: 10px 25px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; border: none; }
        .modal-button.create { background-color: var(--accent-primary); color: white; }
        .modal-button.create:hover { background-color: var(--accent-primary-hover); }
        .modal-button.cancel { background-color: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); }
        .modal-button.cancel:hover { background-color: var(--border-color); }

        /* Quiz Screen Styles */
        .quiz-option {
            display: block; width: 100%; text-align: left;
            padding: 1rem; margin-bottom: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 0.75rem;
            transition: all 0.2s ease;
        }
        .quiz-option:hover:not(:disabled) {
            border-color: var(--accent-primary);
            background-color: var(--bg-tertiary);
        }
        .quiz-option.correct { background-color: var(--correct-bg); border-color: var(--correct-border); }
        .quiz-option.incorrect { background-color: var(--incorrect-bg); border-color: var(--incorrect-border); }
        .quiz-option:disabled { cursor: not-allowed; }

    </style>
</head>
<body>

    <div class="main-container">
        <!-- Sidebar -->
        <aside id="sidebar">
            <h2 class="text-2xl font-bold mb-6" style="color: var(--accent-primary);">Qube</h2>
            <button id="newProjectButton" class="btn btn-primary w-full mb-6">新しいプロジェクトを作成</button>
            <h3 class="text-lg font-semibold mb-3 text-gray-500">プロジェクト一覧</h3>
            <div id="projectList" class="flex-grow overflow-y-auto">
                <p class="text-gray-400">まだプロジェクトがありません。</p>
            </div>
        </aside>
        <div id="sidebarOverlay" class="sidebar-overlay"></div>

        <!-- Main Content -->
        <main id="mainContent">
            <header class="flex items-center justify-between mb-8">
                <button id="hamburgerButton" class="p-2 rounded-md md:hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
                <h1 id="projectTitle" class="text-3xl font-bold text-center flex-grow" style="color: var(--text-primary);">プロジェクトへようこそ</h1>
                <button id="projectSettingsButton" class="p-2 rounded-md invisible">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
            </header>

            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="screen active text-center p-8 bg-white dark:bg-gray-800 rounded-lg shadow-lg">
                <h2 class="text-4xl font-bold mb-4" style="color: var(--accent-primary);">Qubeへようこそ！</h2>
                <p class="text-xl mb-8 text-gray-600 dark:text-gray-300">AIの力で、あなたの学習を次のレベルへ。</p>
                <p class="mb-8">左のメニューから「新しいプロジェクトを作成」して、<br>あなただけのオリジナルクイズ作りを始めましょう。</p>
                <button id="getStartedButton" class="btn btn-primary text-lg px-8 py-3">さっそく始める</button>
            </div>
            
            <!-- Quiz Generation Screen -->
            <div id="generationScreen" class="screen">
                <div class="max-w-3xl mx-auto">
                    <div class="form-group">
                        <label for="promptText">クイズにしたい内容を入力または貼り付け</label>
                        <textarea id="promptText" placeholder="例: 日本の首都は東京です。徳川家康は江戸幕府を開きました..."></textarea>
                    </div>
                    <div class="form-group">
                         <label>または、ファイルをアップロード</label>
                         <div class="w-full p-8 border-2 border-dashed rounded-lg text-center cursor-pointer hover:border-sky-500" style="border-color: var(--border-color);">
                            <p class="text-gray-500">ここにファイルをドラッグ＆ドロップ<br>またはクリックして選択</p>
                            <input type="file" class="hidden" id="fileUpload">
                         </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="aiMode">AI生成モード</label>
                            <select id="aiMode">
                                <option value="generate_new">AIが問題を生成する</option>
                                <option value="from_text">入力内容からそのまま作る</option>
                                <option value="predictive">AIが予想問題を生成する</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="questionType">問題形式</label>
                            <select id="questionType">
                                <option value="multiple_choice">選択肢</option>
                                <option value="fill_in_the_blank" disabled>記述式 (開発中)</option>
                                <option value="sorting" disabled>並び替え (開発中)</option>
                                <option value="multiple_select" disabled>複数選択 (開発中)</option>
                            </select>
                        </div>
                    </div>
                    <button id="generateQuizButton" class="btn btn-primary w-full mt-4 py-3 text-lg flex items-center justify-center">
                        <span class="button-text">クイズを生成する</span>
                        <svg class="spinner hidden animate-spin ml-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                    <p id="generationError" class="text-red-500 text-sm mt-2 text-center hidden"></p>
                </div>
            </div>

            <!-- Quiz Screen -->
            <div id="quizScreen" class="screen">
                <!-- Quiz content will be rendered here -->
            </div>

            <!-- Settings Screen (Placeholder) -->
            <div id="settingsScreen" class="screen">
                 <p>設定画面はここに表示されます。</p>
            </div>
        </main>
    </div>

    <!-- New Project Modal -->
    <div id="newProjectModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">新しいプロジェクトの作成</h2>
            <div class="form-group">
                <label for="newProjectNameInput">プロジェクト名</label>
                <input type="text" id="newProjectNameInput" placeholder="例: 歴史クイズ">
            </div>
            <div class="modal-buttons">
                <button id="modalCancelProjectButton" class="modal-button cancel">キャンセル</button>
                <button id="modalCreateProjectButton" class="modal-button create">作成</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const sidebar = document.getElementById('sidebar');
            const hamburgerButton = document.getElementById('hamburgerButton');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const newProjectButton = document.getElementById('newProjectButton');
            const getStartedButton = document.getElementById('getStartedButton');
            const projectTitle = document.getElementById('projectTitle');
            const projectSettingsButton = document.getElementById('projectSettingsButton');
            
            const screens = {
                welcome: document.getElementById('welcomeScreen'),
                generate: document.getElementById('generationScreen'),
                quiz: document.getElementById('quizScreen'),
                settings: document.getElementById('settingsScreen'),
            };

            const generateQuizButton = document.getElementById('generateQuizButton');
            const promptText = document.getElementById('promptText');
            const aiMode = document.getElementById('aiMode');
            const questionType = document.getElementById('questionType');
            const generationError = document.getElementById('generationError');

            const newProjectModal = document.getElementById('newProjectModal');
            const newProjectNameInput = document.getElementById('newProjectNameInput');
            const modalCreateProjectButton = document.getElementById('modalCreateProjectButton');
            const modalCancelProjectButton = document.getElementById('modalCancelProjectButton');

            // --- App State ---
            let projects = [];
            let activeProjectId = null;
            let currentQuizState = {
                questions: [],
                currentIndex: 0,
                score: 0
            };

            // --- Functions ---
            const switchScreen = (screenName) => {
                Object.values(screens).forEach(s => s.classList.remove('active'));
                if (screens[screenName]) screens[screenName].classList.add('active');
            };

            const toggleSidebar = () => {
                sidebar.classList.toggle('open');
                sidebarOverlay.classList.toggle('active', sidebar.classList.contains('open'));
            };
            
            const showNewProjectModal = () => {
                newProjectNameInput.value = `プロジェクト ${projects.length + 1}`;
                newProjectModal.classList.add('show');
                newProjectNameInput.focus();
                newProjectNameInput.select();
            };

            const closeNewProjectModal = () => newProjectModal.classList.remove('show');
            
            const handleCreateProject = () => {
                const projectName = newProjectNameInput.value.trim();
                if (!projectName) {
                    newProjectNameInput.focus();
                    return;
                }
                const newProject = { id: `proj_${Date.now()}`, name: projectName, quizzes: [] };
                projects.push(newProject);
                activeProjectId = newProject.id;
                renderProjectList();
                setActiveProject(newProject.id);
                switchScreen('generate');
                closeNewProjectModal();
                if(window.innerWidth < 768 && sidebar.classList.contains('open')) toggleSidebar();
            };

            const renderProjectList = () => {
                const projectListEl = document.getElementById('projectList');
                projectListEl.innerHTML = '';
                if (projects.length === 0) {
                    projectListEl.innerHTML = '<p class="text-gray-400">まだプロジェクトがありません。</p>';
                    return;
                }
                projects.forEach(p => {
                    const projectEl = document.createElement('div');
                    projectEl.textContent = p.name;
                    projectEl.className = `p-2 rounded-md cursor-pointer hover:bg-sky-100 dark:hover:bg-sky-800 ${p.id === activeProjectId ? 'bg-sky-100 dark:bg-sky-800 font-bold' : ''}`;
                    projectEl.dataset.projectId = p.id;
                    projectEl.addEventListener('click', () => {
                        setActiveProject(p.id);
                        if(window.innerWidth < 768) toggleSidebar();
                    });
                    projectListEl.appendChild(projectEl);
                });
            };

            const setActiveProject = (projectId) => {
                activeProjectId = projectId;
                const project = projects.find(p => p.id === projectId);
                if (project) {
                    projectTitle.textContent = project.name;
                    projectSettingsButton.classList.remove('invisible');
                    if (project.quizzes.length === 0) {
                        switchScreen('generate');
                    } else {
                        renderQuiz(project.quizzes);
                        switchScreen('quiz');
                    }
                }
                renderProjectList();
            };
            
            const handleGenerateQuiz = async () => {
                const buttonText = generateQuizButton.querySelector('.button-text');
                const spinner = generateQuizButton.querySelector('.spinner');

                if (promptText.value.trim() === '') {
                    generationError.textContent = 'クイズにしたい内容を入力してください。';
                    generationError.classList.remove('hidden');
                    return;
                }
                generationError.classList.add('hidden');

                buttonText.textContent = '生成中...';
                spinner.classList.remove('hidden');
                generateQuizButton.disabled = true;

                try {
                    const modelPrompt = `以下のテキストに基づいて、高品質な4択クイズを5問作成してください。各問題には、質問、4つの選択肢、正解、そして正解の簡単な解説を必ず含めてください。出力は指定されたJSON形式に従ってください。\n\nテキスト:\n---\n${promptText.value}\n---`;
                    
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: modelPrompt }] }],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    "quizzes": {
                                        "type": "ARRAY",
                                        "items": {
                                            "type": "OBJECT",
                                            "properties": {
                                                "question": { "type": "STRING" },
                                                "options": { "type": "ARRAY", "items": { "type": "STRING" } },
                                                "answer": { "type": "STRING" },
                                                "explanation": { "type": "STRING" }
                                            },
                                            "required": ["question", "options", "answer", "explanation"]
                                        }
                                    }
                                }
                            }
                        }
                    };

                    const apiKey = ""; // Provided by the environment
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts[0].text) {
                        const generatedData = JSON.parse(result.candidates[0].content.parts[0].text);
                        const project = projects.find(p => p.id === activeProjectId);
                        if (project) {
                            project.quizzes = generatedData.quizzes;
                            renderQuiz(project.quizzes);
                            switchScreen('quiz');
                        }
                    } else {
                        throw new Error("AIからの応答が無効です。");
                    }
                } catch (error) {
                    console.error("Quiz generation failed:", error);
                    generationError.textContent = `クイズの生成に失敗しました: ${error.message}`;
                    generationError.classList.remove('hidden');
                } finally {
                    buttonText.textContent = 'クイズを生成する';
                    spinner.classList.add('hidden');
                    generateQuizButton.disabled = false;
                }
            };

            const renderQuiz = (questions) => {
                if (!questions || questions.length === 0) {
                    switchScreen('generate'); // or show a message
                    return;
                }
                currentQuizState = { questions, currentIndex: 0, score: 0 };
                renderCurrentQuestion();
            };

            const renderCurrentQuestion = () => {
                const quizScreen = document.getElementById('quizScreen');
                const question = currentQuizState.questions[currentQuizState.currentIndex];
                quizScreen.innerHTML = `
                    <div class="max-w-3xl mx-auto">
                        <div class="mb-4">
                            <p class="text-sm text-gray-500">問題 ${currentQuizState.currentIndex + 1} / ${currentQuizState.questions.length}</p>
                            <h2 class="text-2xl font-bold mt-2">${question.question}</h2>
                        </div>
                        <div id="optionsContainer">
                            ${question.options.map(opt => `<button class="quiz-option" data-option="${opt}">${opt}</button>`).join('')}
                        </div>
                        <div id="feedbackContainer" class="mt-4 p-4 rounded-lg hidden"></div>
                        <div class="mt-6 text-right">
                            <button id="nextQuestionButton" class="btn btn-primary hidden">次の問題へ</button>
                        </div>
                    </div>
                `;
                document.querySelectorAll('.quiz-option').forEach(btn => {
                    btn.addEventListener('click', handleOptionSelect);
                });
            };

            const handleOptionSelect = (e) => {
                const selectedButton = e.target;
                const selectedOption = selectedButton.dataset.option;
                const question = currentQuizState.questions[currentQuizState.currentIndex];
                const feedbackContainer = document.getElementById('feedbackContainer');
                
                document.querySelectorAll('.quiz-option').forEach(btn => btn.disabled = true);

                if (selectedOption === question.answer) {
                    selectedButton.classList.add('correct');
                    feedbackContainer.innerHTML = `<strong class="text-green-700 dark:text-green-300">正解！</strong><p class="mt-2">${question.explanation}</p>`;
                    feedbackContainer.className = 'mt-4 p-4 rounded-lg block bg-green-100 dark:bg-green-900';
                } else {
                    selectedButton.classList.add('incorrect');
                    feedbackContainer.innerHTML = `<strong class="text-red-700 dark:text-red-300">不正解...</strong><p class="mt-2">正解は「${question.answer}」でした。</p><p class="mt-2">${question.explanation}</p>`;
                    feedbackContainer.className = 'mt-4 p-4 rounded-lg block bg-red-100 dark:bg-red-900';
                    // Highlight the correct answer
                    document.querySelector(`.quiz-option[data-option="${question.answer}"]`).classList.add('correct');
                }
                
                const nextButton = document.getElementById('nextQuestionButton');
                nextButton.classList.remove('hidden');
                nextButton.addEventListener('click', () => {
                    currentQuizState.currentIndex++;
                    if (currentQuizState.currentIndex < currentQuizState.questions.length) {
                        renderCurrentQuestion();
                    } else {
                        // Show results screen (to be implemented)
                        document.getElementById('quizScreen').innerHTML = `<p class="text-center text-2xl">クイズ終了！お疲れ様でした。</p>`;
                    }
                });
            };

            // --- Event Listeners ---
            hamburgerButton.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);
            newProjectButton.addEventListener('click', showNewProjectModal);
            getStartedButton.addEventListener('click', showNewProjectModal);
            modalCreateProjectButton.addEventListener('click', handleCreateProject);
            modalCancelProjectButton.addEventListener('click', closeNewProjectModal);
            newProjectModal.addEventListener('click', (e) => { if (e.target === newProjectModal) closeNewProjectModal(); });
            newProjectNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleCreateProject(); });
            generateQuizButton.addEventListener('click', handleGenerateQuiz);

            // --- Initialization ---
            switchScreen('welcome');
            renderProjectList();
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) document.body.classList.add('dark-mode');
        });
    </script>
</body>
</html>
