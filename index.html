<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Qube</title>
    <link rel="icon" href="icons.png" sizes="any">
    <link rel="apple-touch-icon" href="icon.png">
    <!-- PWA settings -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Qube">
    <meta name="theme-color" content="#f0f9ff">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* --- Base Variables from Qube --- */
        :root {
            --bg-primary: #f0f9ff;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e0f2fe;
            --bg-welcome: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent-primary: #0ea5e9;
            --accent-primary-hover: #0284c7;
            --accent-primary-shadow: rgba(14, 165, 233, 0.3);
            --border-color: #cbd5e1;
            --modal-bg: rgba(0, 0, 0, 0.5);
            
            /* --- Integrated Variables from BEI --- */
            --button-bg-default: #f1f5f9;
            --button-text-default: #334155;
            --button-border-default: #cbd5e1;
            --progress-bar-bg: var(--accent-primary);
            --feedback-bg: #f8fafc;
            --feedback-border: #e2e8f0;
            --correct-feedback-text: #15803d;
            --correct-feedback-border: #22c55e;
            --incorrect-feedback-text: #b91c1c;
            --incorrect-feedback-border: #ef4444;
            --correct-option-bg: #dcfce7;
            --incorrect-option-bg: #fee2e2;
            --score-color: #0c4a6e;
            --score-comment-color: #0369a1;
            --themed-text-color: #0c4a6e;

            /* Safe Area Insets */
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 1rem);
        }

        body.dark-mode {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #0c4a6e;
            --bg-welcome: #1e293b;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --accent-primary: #38bdf8;
            --accent-primary-hover: #0ea5e9;
            --accent-primary-shadow: rgba(56, 189, 248, 0.3);
            --border-color: #475569;
            --modal-bg: rgba(0, 0, 0, 0.7);

            /* --- Integrated Dark Variables from BEI --- */
            --button-bg-default: #334155;
            --button-text-default: #e2e8f0;
            --button-border-default: #475569;
            --progress-bar-bg: var(--accent-primary);
            --feedback-bg: #334155;
            --feedback-border: #475569;
            --correct-feedback-text: #a7f3d0;
            --correct-feedback-border: #4ade80;
            --incorrect-feedback-text: #fecaca;
            --incorrect-feedback-border: #f87171;
            --correct-option-bg: #14532d;
            --incorrect-option-bg: #7f1d1d;
            --score-color: #e0f2fe;
            --score-comment-color: #7dd3fc;
            --themed-text-color: #e0f2fe;
        }
        
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow: hidden; /* Prevent body scroll */
        }

        /* --- Splash Screen --- */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.9s ease-out;
            will-change: opacity;
        }
        .splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .splash-screen img {
            width: 228px;
            height: 228px;
        }
        .splash-screen h1 {
            display: none; /* Hidden by default, shown on image error */
        }

        /* --- Qube Base Layout --- */
        .main-container { display: flex; height: 100vh; width: 100%; }
        #sidebar { width: 280px; background-color: var(--bg-secondary); border-right: 1px solid var(--border-color); padding: 20px; display: flex; flex-direction: column; transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease; transform: translateX(-100%); position: fixed; top: 0; left: 0; height: 100%; z-index: 1000; padding-top: var(--safe-area-inset-top); }
        #sidebar.open { transform: translateX(0); box-shadow: 0 0 40px rgba(0,0,0,0.2); }
        
        #mainContent { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; transition: margin-left 0.3s ease; }
        body.sidebar-open-desktop #mainContent { margin-left: 280px; }
        
        #mainContent > header { padding: 20px 20px 0 20px; padding-top: calc(20px + var(--safe-area-inset-top)); }
        #screenContainer { flex-grow: 1; overflow-y: auto; padding: 20px; padding-bottom: calc(20px + var(--safe-area-inset-bottom)); }

        @media (max-width: 767px) { 
            body.sidebar-open-desktop #mainContent { margin-left: 0; }
        }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
        .sidebar-overlay.active { display: block; }
        .screen { display: none; flex-direction: column; }
        .screen.active { display: flex; }

        /* --- Project List Enhancements --- */
        .project-item { position: relative; display: flex; align-items: center; justify-content: space-between; padding: 8px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        .project-item:hover { background-color: var(--bg-tertiary); }
        .project-item.active { background-color: var(--bg-tertiary); font-weight: bold; }
        .project-item.dragging { opacity: 0.7; background-color: var(--accent-primary); color: white; box-shadow: 0 8px 20px rgba(0,0,0,0.2); z-index: 10; }
        .project-name { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .project-menu-btn { padding: 4px; border-radius: 50%; flex-shrink: 0; }
        .project-menu-btn:hover { background-color: rgba(0,0,0,0.1); }
        .project-menu { position: absolute; top: 100%; right: 5px; background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 1100; display: none; min-width: 120px; margin-top: 4px;}
        .project-menu.show { display: block; }
        .project-menu-item { padding: 8px 16px; cursor: pointer; display: flex; align-items: center;}
        .project-menu-item:hover { background-color: var(--bg-tertiary); }
        .project-menu-item.delete { color: #ef4444; }


        /* --- Qube Buttons & Forms --- */
        .btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; border: none; }
        .btn-primary { background-color: var(--accent-primary); color: white; box-shadow: 0 4px 12px var(--accent-primary-shadow); }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-primary-hover); transform: translateY(-2px); }
        .btn-lg { padding: 15px 30px; font-size: 1.1rem; }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; }
        .form-group textarea { min-height: 120px; resize: vertical; }
        #fillInBlankInput {
            width: 100%;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1.2rem;
            text-align: center;
        }
        
        /* --- Qube Modal --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-bg); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--bg-secondary); padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); max-width: 400px; width: 90%; transform: translateY(-20px) scale(0.95); transition: transform 0.3s ease, background-color 0.3s ease; }
        .modal.show .modal-content { transform: translateY(0) scale(1); }
        .modal-title { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 20px; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
        .modal-button { padding: 10px 25px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; border: none; }
        .modal-button.create, .modal-button.save { background-color: var(--accent-primary); color: white; }
        .modal-button.create:hover, .modal-button.save:hover { background-color: var(--accent-primary-hover); }
        .modal-button.delete, .modal-button.reset { background-color: #ef4444; color: white; }
        .modal-button.delete:hover, .modal-button.reset:hover { background-color: #dc2626; }
        .modal-button.cancel { background-color: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); }
        .modal-button.cancel:hover { background-color: var(--border-color); }

        /* --- ToS Modal --- */
        #tosModal .modal-content { max-width: 500px; }
        #tosContent { max-height: 30vh; overflow-y: auto; background-color: var(--bg-primary); padding: 1rem; border-radius: 8px; font-size: 0.9rem; color: var(--text-secondary); border: 1px solid var(--border-color); }

        /* --- Add to Home Screen Popup --- */
        #addToHomeScreenPopup {
            display: none;
            position: fixed;
            bottom: calc(20px + var(--safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 4000;
            width: 90%;
            max-width: 400px;
        }
        #addToHomeScreenPopup::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid var(--bg-secondary);
        }
        #closeAddToHomeScreen {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 24px;
        }

        /* --- Project Start Screen --- */
        #welcomeScreen, #projectStartScreen .start-screen-container {
            background-color: var(--bg-welcome);
            transition: background-color 0.3s ease;
        }
        .start-screen-container { max-width: 600px; margin: auto; text-align: center; }
        .start-screen-container h2 { color: var(--themed-text-color); }
        .start-screen-container .form-group select {
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2020%2020%22%20fill%3D%22%2364748b%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20d%3D%22M5.293%207.293a1%201%200%20011.414%200L10%2010.586l3.293-3.293a1%201%200%20111.414%201.414l-4%204a1%201%200%2001-1.414%200l-4-4a1%201%200%20010-1.414z%22%20clip-rule%3D%22evenodd%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2em;
        }
        #fileDropArea { border-color: var(--border-color); }
        #fileDropArea.dragover { border-color: var(--accent-primary); background-color: var(--bg-tertiary); }
        #filePreviewContainer { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 1rem; }
        .file-preview-item { position: relative; display: flex; flex-direction: column; align-items: center; }
        .file-preview-item img, .file-preview-item canvas { max-height: 100px; border-radius: 8px; }
        .file-preview-item .file-name { font-size: 0.8rem; color: var(--text-secondary); max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .remove-file-btn { position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; border: 2px solid var(--bg-secondary); }
        .divider { text-align: center; margin: 1.5rem 0; color: var(--text-secondary); display: flex; align-items: center; gap: 1rem; }
        .divider::before, .divider::after { content: ''; height: 1px; background-color: var(--border-color); flex-grow: 1; }

        /* --- Integrated Quiz Screen Styles --- */
        .quiz-container { max-width: 800px; margin-left: auto; margin-right: auto; width: 100%; }
        .quiz-header { position: relative; display: flex; align-items: center; justify-content: center; padding-bottom: 1rem; gap: 1rem; }
        #quizTitle { font-size: 1.5rem; font-weight: 700; color: var(--themed-text-color); text-align: center; flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        #interruptButton { position: absolute; right: 0; padding: 8px 15px; font-size: 0.8rem; background-color: #ef4444; color:white; flex-shrink: 0; }
        .progress-container { width: 100%; background-color: #e2e8f0; border-radius: 10px; height: 15px; margin-top: 10px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        .progress-bar { height: 100%; width: 0%; background-color: var(--progress-bar-bg); border-radius: 10px; transition: width 0.4s ease-in-out; }
        .progress-text { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-top: 10px; transition: color 0.3s ease; text-align: center; }
        .question-area { min-height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: background-color 0.3s ease; text-align: left; margin-top: 1.5rem;}
        #questionImage { max-height: 200px; border-radius: 8px; margin-top: 1rem; }
        .question-text { font-size: 1.25rem; font-weight: 500; color: var(--themed-text-color); margin-bottom: 10px; transition: color 0.3s ease; width: 100%; text-align:center; }
        #longContentBox { display: none; width: 100%; max-height: 250px; overflow-y: auto; background-color: var(--button-bg-default); border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; white-space: pre-wrap; font-family: monospace; font-size: 0.9rem; }
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 15px; }
        .options-grid.options-grid-full-width { grid-template-columns: 1fr; }
        .option-button { background-color: var(--button-bg-default); color: var(--button-text-default); padding: 14px 20px; border-radius: 12px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; border: 2px solid var(--button-border-default); text-align: left; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08); line-height: 1.5; }
        .option-button:hover:not(:disabled) { background-color: var(--border-color); transform: translateY(-3px) scale(1.01); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.12); }
        .option-button.correct { background-color: var(--correct-option-bg); border-color: var(--correct-feedback-border); color: var(--correct-feedback-text); }
        .option-button.incorrect { background-color: var(--incorrect-option-bg); border-color: var(--incorrect-feedback-border); color: var(--incorrect-feedback-text); }
        .option-button.selected { border-color: var(--accent-primary); background-color: var(--bg-tertiary); }
        .option-button:disabled { cursor: not-allowed; }
        .sorting-item.dragging { opacity: 0.5; }
        .sorting-container { display: flex; flex-direction: column; gap: 1rem; }
        .sorting-box { display: flex; flex-wrap: wrap; gap: 10px; padding: 1rem; border-radius: 12px; border: 2px dashed var(--border-color); min-height: 70px; }
        .feedback-message { margin-top: 1.5rem; font-size: 1rem; text-align: left; padding: 1rem 1.5rem; border-radius: 12px; background-color: var(--feedback-bg); border: 1px solid var(--feedback-border); box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); line-height: 1.5; }
        .feedback-message.correct-feedback { color: var(--correct-feedback-text); border-color: var(--correct-feedback-border); }
        .feedback-message.incorrect-feedback { color: var(--incorrect-feedback-text); border-color: var(--incorrect-feedback-border); }
        .feedback-header { display: flex; justify-content: space-between; align-items: center; gap: 15px; min-height: 24px; flex-wrap: wrap; }
        .feedback-result strong { font-size: 1.1rem; }
        .explanation-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding-top 0.4s ease-out, margin-top 0.4s ease-out; padding-top: 0; margin-top: 0; }
        .explanation-content.show { max-height: 200px; padding-top: 10px; margin-top: 10px; border-top: 1px solid var(--border-color); }
        .explanation-text { font-weight: 400; font-size: 0.95rem; }
        .toggle-explanation-button { background-color: var(--accent-primary); color: white; padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease; flex-shrink: 0; border: none; }
        .navigation-buttons { display: flex; justify-content: flex-end; margin-top: 20px; flex-wrap: wrap; gap: 10px; }
        
        /* --- Integrated Result Screen Styles --- */
        .result-container { text-align: center; max-width: 600px; margin: 2rem auto; }
        .score-area { font-size: 1.8rem; font-weight: 800; color: var(--score-color); margin-top: 25px; }
        .score-comment { font-size: 1.3rem; font-weight: 700; color: var(--score-comment-color); margin-top: 10px; }
        .confetti-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; pointer-events: none; z-index: 0; }
        .confetti { position: absolute; width: 10px; height: 10px; background-color: #f06; opacity: 1; }

        /* --- Settings Screen (Modal) Styles --- */
        #settingsScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #settingsScreen.active {
            opacity: 1;
            visibility: visible;
        }
        #settingsScreen .settings-container, #editQuizzesModal .modal-content {
            background-color: var(--bg-secondary);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 700px;
            width: 90%;
            transform: translateY(-20px) scale(0.95);
            transition: transform 0.3s ease, background-color 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        #settingsScreen.active .settings-container, #editQuizzesModal.show .modal-content {
            transform: translateY(0) scale(1);
        }
        .settings-option { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--border-color); flex-wrap: nowrap; gap: 1rem;}
        .settings-option:last-child { border-bottom: none; }
        .settings-option-label { display: flex; flex-direction: column; align-items: flex-start; flex-grow: 1; min-width: 0; }
        .settings-option-label label { font-size: 1.1rem; color: var(--text-primary); font-weight: 600; }
        .settings-option-label p { font-size: 0.85rem; color: var(--text-secondary); margin: 4px 0 0 0; text-align: left; }
        .theme-colors { display: flex; gap: 10px; }
        .color-circle { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s ease; }
        .color-circle.selected { border-color: var(--accent-primary); }
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; flex-shrink: 0; margin-left: auto; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-primary); }
        input:checked + .slider:before { transform: translateX(26px); }
        
        #settingsScreen select, #soundVolumeSlider {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        #soundVolumeSlider {
            -webkit-appearance: none;
            appearance: none;
            width: 128px; /* w-32 */
            height: 8px;
            background: var(--border-color);
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        #soundVolumeSlider:hover { opacity: 1; }
        #soundVolumeSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent-primary);
            cursor: pointer;
            border-radius: 50%;
        }
        #soundVolumeSlider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--accent-primary);
            cursor: pointer;
            border-radius: 50%;
        }


        /* Edit Quiz Modal Styles */
        #editQuizzesModal .modal-content { max-width: 600px; }
        #editQuizList .project-item { padding-left: 0; } /* Remove indent */
        .drag-handle { touch-action: none; cursor: move; padding: 8px; }
        #editQuizList .project-item.dragging {
            opacity: 0.7;
            background: var(--bg-tertiary);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            z-index: 10;
        }

        @media (min-width: 640px) { 
            .options-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div id="splashScreen" class="splash-screen">
        <img src="iconsp.png" alt="Qube Logo" id="splashLogo">
        <h1 class="text-5xl font-bold" style="color: var(--accent-primary);">Qube</h1>
    </div>

    <div id="confettiContainer" class="confetti-container"></div>
    <div class="main-container">
        <!-- Sidebar -->
        <aside id="sidebar">
            <h2 class="text-2xl font-bold mb-6" style="color: var(--accent-primary);">Qube</h2>
            <button id="newProjectButton" class="btn btn-primary w-full mb-6">新しいプロジェクトを作成</button>
            <h3 class="text-lg font-semibold mb-3 text-gray-500">プロジェクト一覧</h3>
            <div id="projectList" class="flex-grow overflow-y-auto space-y-1 pr-2">
                <p class="text-gray-400">まだプロジェクトがありません。</p>
            </div>
        </aside>
        <div id="sidebarOverlay" class="sidebar-overlay"></div>

        <!-- Main Content -->
        <main id="mainContent">
            <header class="flex items-center justify-between mb-8">
                <button id="hamburgerButton" class="p-2 rounded-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
                <h1 id="projectTitle" class="text-3xl font-bold text-center flex-grow" style="color: var(--text-primary);">Qube</h1>
                <button id="projectSettingsButton" class="p-2 rounded-md invisible">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
            </header>
            
            <div id="screenContainer">
                <!-- Welcome Screen -->
                <div id="welcomeScreen" class="screen active flex-col justify-center items-center text-center p-8 rounded-lg">
                    <img src="iconsp.png" alt="Qube Logo" class="w-48 h-48 mb-6">
                    <p class="text-xl mb-8" style="color: var(--text-secondary);">AIの力で、あなたの学習を次のレベルへ。</p>
                    <button id="getStartedButton" class="btn btn-primary text-lg px-8 py-3">さっそく始める</button>
                </div>

                <!-- Project Start Screen (New) -->
                <div id="projectStartScreen" class="screen">
                    <div class="start-screen-container p-8 rounded-lg">
                        <h2 class="text-3xl font-bold mb-6">学習を開始</h2>
                        <div class="form-group">
                            <label for="quizSelect" class="text-left">作成済みクイズから選ぶ</label>
                            <select id="quizSelect"></select>
                        </div>
                        <button id="startSelectedQuizButton" class="btn btn-primary btn-lg w-full">選択したクイズを開始</button>
                        <div class="divider">または</div>
                        <button id="generateNewQuizBtn" class="btn btn-lg w-full" style="background-color: var(--button-bg-default); color: var(--button-text-default); border: 1px solid var(--border-color);">新しいクイズをAIで生成</button>
                    </div>
                </div>
                
                <!-- Quiz Generation Screen -->
                <div id="generationScreen" class="screen">
                    <div class="max-w-3xl mx-auto w-full">
                        <button id="backToProjectStartBtn" class="btn mb-4 text-sm" style="background-color: transparent; color: var(--text-secondary); padding: 4px 8px;">← プロジェクトに戻る</button>
                        
                        <div class="form-group">
                             <label>ファイルをアップロード</label>
                             <div id="fileDropArea" class="w-full p-8 border-2 border-dashed rounded-lg text-center cursor-pointer hover:border-sky-500">
                                 <p class="text-gray-500">ここにファイルをドラッグ＆ドロップ<br>またはクリックして選択</p>
                                 <input type="file" class="hidden" id="fileUpload" multiple>
                             </div>
                             <div id="filePreviewContainer"></div>
                        </div>

                        <div class="divider">または</div>

                        <div class="form-group">
                            <label id="promptLabel" for="promptText">クイズにしたい内容を入力または貼り付け</label>
                            <textarea id="promptText" placeholder="例: 日本の首都は東京です。徳川家康は江戸幕府を開きました..."></textarea>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4 mt-8">
                            <div class="form-group">
                                <label for="genQuestionCount">問題数</label>
                                <select id="genQuestionCount">
                                    <option value="5">5問</option>
                                    <option value="10">10問</option>
                                    <option value="all">全て</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="questionType">問題形式</label>
                                <select id="questionType">
                                    <option value="auto_select">適切なものを選ぶ</option>
                                    <option value="multiple_choice">選択肢</option>
                                    <option value="fill_in_the_blank">記述式</option>
                                    <option value="sorting">並び替え</option>
                                    <option value="multiple_select">複数選択</option>
                                </select>
                            </div>
                        </div>
                         <div class="form-group mt-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="autoGenreCheckbox" class="w-4 h-4 accent-sky-500">
                                <span class="select-none">AIによる自動ジャンル分け</span>
                            </label>
                        </div>
                        <button id="generateQuizButton" class="btn btn-primary w-full mt-4 py-3 text-lg flex items-center justify-center">
                            <span class="button-text">クイズを生成する</span>
                            <svg class="spinner hidden animate-spin ml-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        </button>
                        <p id="generationWarning" class="text-red-500 text-sm mt-2 text-center hidden"></p>
                        <p id="generationError" class="text-red-500 text-sm mt-2 text-center hidden"></p>
                    </div>
                </div>

                <!-- Quiz Screen (New UI) -->
                <div id="quizScreen" class="screen">
                    <div class="quiz-container">
                        <div class="quiz-header">
                            <h1 id="quizTitle" class="main-title">クイズ</h1>
                            <button id="interruptButton" class="btn">中断</button>
                        </div>
                        <div class="progress-container">
                            <div id="progressBar" class="progress-bar"></div>
                        </div>
                        <div id="progressText" class="progress-text"></div>
                        <div class="question-area">
                            <div id="questionText" class="question-text"></div>
                            <img id="questionImage" class="hidden"/>
                            <div id="longContentBox"></div>
                        </div>
                        <div id="optionsGrid" class="options-grid"></div>
                        <div id="submissionArea" class="mt-4 text-right"></div>
                        <div id="feedbackMessage" class="feedback-message" style="visibility: hidden;">
                            <div class="feedback-header">
                                <div id="feedbackResult"></div>
                                <button id="toggleExplanationButton" class="toggle-explanation-button hidden">解説▼</button>
                            </div>
                            <div id="explanationContent" class="explanation-content">
                                <div class="explanation-text"></div>
                            </div>
                        </div>
                        <div class="navigation-buttons">
                            <button id="nextButton" class="btn btn-primary">次の問題</button>
                        </div>
                    </div>
                </div>

                <!-- Result Screen (New UI) -->
                <div id="resultScreen" class="screen">
                    <div class="result-container">
                        <h2 class="text-2xl font-bold mb-4" style="color: var(--score-color);">クイズ結果</h2>
                        <div id="finalScore" class="score-area"></div>
                        <div id="scoreComment" class="score-comment"></div>
                        <div class="mt-6 flex flex-col items-center gap-3">
                            <button id="restartQuizButton" class="btn btn-primary w-full max-w-xs">もう一度挑戦</button>
                            <button id="backToProjectButton" class="btn w-full max-w-xs" style="background-color: var(--button-bg-default); color: var(--button-text-default); border: 1px solid var(--border-color);">プロジェクトに戻る</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Settings Screen (Now a Modal) -->
    <div id="settingsScreen" class="screen">
         <div class="settings-container">
            <h2 class="text-2xl font-bold mb-4 text-center">設定</h2>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label for="darkModeToggle">ダークモード</label>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label>テーマカラー</label>
                </div>
                <div class="theme-colors">
                    <div class="color-circle" data-theme="default" style="background-color: #0ea5e9;"></div>
                    <div class="color-circle" data-theme="red" style="background-color: #ef4444;"></div>
                    <div class="color-circle" data-theme="green" style="background-color: #10b981;"></div>
                    <div class="color-circle" data-theme="indigo" style="background-color: #6366f1;"></div>
                </div>
            </div>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label for="soundVolumeSlider">効果音</label>
                </div>
                <input type="range" id="soundVolumeSlider" min="0" max="100">
            </div>
             <div class="settings-option">
                <div class="settings-option-label">
                    <label for="questionCountSelect">問題数</label>
                </div>
                <select id="questionCountSelect" class="w-24 p-2 border rounded">
                    <option value="5">5問</option>
                    <option value="10">10問</option>
                    <option value="15">15問</option>
                    <option value="20">20問</option>
                </select>
            </div>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label for="shuffleQuestionsToggle">シャッフル出題</label>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="shuffleQuestionsToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label for="showProgressToggle">進捗状況を表示</label>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="showProgressToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label for="masteryModeToggle">特訓モード</label>
                    <p>2回連続で正解するまで「習得済み」になりません。</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="masteryModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
             <div class="settings-option">
                <button id="editQuizzesButton" class="btn w-full">作成済みクイズを編集する</button>
            </div>
             <button id="backToProjectFromSettings" class="btn btn-primary mt-8 w-full">閉じる</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="newProjectModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">新しいプロジェクトの作成</h2>
            <div class="form-group">
                <label for="newProjectNameInput">プロジェクト名</label>
                <input type="text" id="newProjectNameInput" placeholder="例: 歴史クイズ">
            </div>
            <div class="modal-buttons">
                <button id="modalCancelProjectButton" class="modal-button cancel">キャンセル</button>
                <button id="modalCreateProjectButton" class="modal-button create">作成</button>
            </div>
        </div>
    </div>
    <div id="renameProjectModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">プロジェクト名を変更</h2>
            <div class="form-group">
                <label for="renameProjectNameInput">新しいプロジェクト名</label>
                <input type="text" id="renameProjectNameInput">
            </div>
            <div class="modal-buttons">
                <button id="modalCancelRenameButton" class="modal-button cancel">キャンセル</button>
                <button id="modalSaveRenameButton" class="modal-button save">保存</button>
            </div>
        </div>
    </div>
    <div id="nameQuizModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">クイズに名前を付ける</h2>
            <div class="form-group">
                <label for="newQuizNameInput">クイズ名</label>
                <input type="text" id="newQuizNameInput" placeholder="例: 江戸時代クイズ">
            </div>
            <div class="modal-buttons">
                <button id="modalCancelQuizButton" class="modal-button cancel">キャンセル</button>
                <button id="modalCreateQuizButton" class="modal-button create">保存</button>
            </div>
        </div>
    </div>
     <div id="interruptModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">クイズを中断</h2>
            <p>本当にクイズを中断しますか？現在の進捗は保存されません。</p>
            <div class="modal-buttons">
                <button id="modalCancelInterrupt" class="modal-button cancel">キャンセル</button>
                <button id="modalConfirmInterrupt" class="modal-button delete">中断する</button>
            </div>
        </div>
    </div>
    <div id="deleteProjectModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">プロジェクトを削除</h2>
            <p>本当に「<span id="deleteProjectName"></span>」を削除しますか？この操作は元に戻せません。</p>
            <div class="modal-buttons">
                <button id="modalCancelDelete" class="modal-button cancel">キャンセル</button>
                <button id="modalConfirmDelete" class="modal-button delete">削除する</button>
            </div>
        </div>
    </div>
    
    <!-- New Modals for Quiz Editing -->
    <div id="editQuizzesModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">クイズの編集</h2>
            <div id="editQuizList" class="space-y-2">
                <!-- Quiz items will be dynamically inserted here -->
            </div>
            <div class="modal-buttons">
                <button id="closeEditQuizModalButton" class="modal-button cancel">閉じる</button>
            </div>
        </div>
    </div>
    <div id="renameQuizInstanceModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">クイズ名を変更</h2>
            <div class="form-group">
                <label for="renameQuizNameInstanceInput">新しいクイズ名</label>
                <input type="text" id="renameQuizNameInstanceInput">
            </div>
            <div class="modal-buttons">
                <button class="modal-button cancel">キャンセル</button>
                <button class="modal-button save">保存</button>
            </div>
        </div>
    </div>
    <div id="deleteQuizInstanceModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">クイズを削除</h2>
            <p>本当に「<span id="deleteQuizNameInstance"></span>」を削除しますか？この操作は元に戻せません。</p>
            <div class="modal-buttons">
                <button class="modal-button cancel">キャンセル</button>
                <button class="modal-button delete">削除する</button>
            </div>
        </div>
    </div>
    <div id="resetMasteryModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">学習完了！</h2>
            <p>このクイズのすべての問題を習得しました。進捗をリセットして、もう一度挑戦しますか？</p>
            <div class="modal-buttons">
                <button class="modal-button cancel">キャンセル</button>
                <button class="modal-button reset">リセット</button>
            </div>
        </div>
    </div>

    <!-- Terms of Service Modal -->
    <div id="tosModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">利用規約</h2>
            <div id="tosContent">
                <p class="mb-2">このサービスはAI（人工知能）を利用しています。</p>
                <p class="mb-2">Google社のGemini APIを利用しています。</p>
                <p class="mb-2">AIによる回答結果には、誤った情報が含まれる可能性があり、その正確性を保証するものではありません。</p>
                <p>当サービスのご利用により生じた、いかなる損害についても、当方は一切の責任を負いません。</p>
            </div>
            <div class="modal-buttons">
                <button id="tosAgreeButton" class="modal-button create">同意して利用を開始</button>
            </div>
        </div>
    </div>

    <!-- Add to Home Screen Popup for iOS -->
    <div id="addToHomeScreenPopup" class="text-sm">
        <button id="closeAddToHomeScreen">&times;</button>
        <p class="font-bold mb-2">ホーム画面に追加してアプリとして使おう！</p>
        <p>下の共有ボタン <span id="iosShareIconContainer" class="inline-block align-middle h-5 w-5 -mt-1"></span> から「ホーム画面に追加」を選択してください。</p>
        <p class="text-xs mt-2 text-gray-500">アプリ版とブラウザ版で生成したクイズが同期しないため、生成する前にアプリ版を使用することをおすすめします。</p>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const sidebar = document.getElementById('sidebar');
            const hamburgerButton = document.getElementById('hamburgerButton');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const newProjectButton = document.getElementById('newProjectButton');
            const getStartedButton = document.getElementById('getStartedButton');
            const projectTitle = document.getElementById('projectTitle');
            const projectSettingsButton = document.getElementById('projectSettingsButton');
            const projectListEl = document.getElementById('projectList');
            
            const screens = {
                welcome: document.getElementById('welcomeScreen'),
                projectStart: document.getElementById('projectStartScreen'),
                generate: document.getElementById('generationScreen'),
                quiz: document.getElementById('quizScreen'),
                result: document.getElementById('resultScreen'),
            };
            const settingsScreen = document.getElementById('settingsScreen');

            const generateQuizButton = document.getElementById('generateQuizButton');
            const generateNewQuizBtn = document.getElementById('generateNewQuizBtn');
            const backToProjectStartBtn = document.getElementById('backToProjectStartBtn');
            const promptText = document.getElementById('promptText');
            const promptLabel = document.getElementById('promptLabel');
            const questionType = document.getElementById('questionType');
            const genQuestionCount = document.getElementById('genQuestionCount');
            const autoGenreCheckbox = document.getElementById('autoGenreCheckbox');
            const generationError = document.getElementById('generationError');
            const generationWarning = document.getElementById('generationWarning');
            const quizSelect = document.getElementById('quizSelect');
            const startSelectedQuizButton = document.getElementById('startSelectedQuizButton');
            const fileDropArea = document.getElementById('fileDropArea');
            const fileUpload = document.getElementById('fileUpload');
            const filePreviewContainer = document.getElementById('filePreviewContainer');

            const newProjectModal = document.getElementById('newProjectModal');
            const newProjectNameInput = document.getElementById('newProjectNameInput');
            const modalCreateProjectButton = document.getElementById('modalCreateProjectButton');
            const modalCancelProjectButton = document.getElementById('modalCancelProjectButton');

            const renameProjectModal = document.getElementById('renameProjectModal');
            const renameProjectNameInput = document.getElementById('renameProjectNameInput');
            const modalSaveRenameButton = document.getElementById('modalSaveRenameButton');
            const modalCancelRenameButton = document.getElementById('modalCancelRenameButton');
            
            const nameQuizModal = document.getElementById('nameQuizModal');
            const newQuizNameInput = document.getElementById('newQuizNameInput');
            const modalCreateQuizButton = document.getElementById('modalCreateQuizButton');
            const modalCancelQuizButton = document.getElementById('modalCancelQuizButton');

            const interruptModal = document.getElementById('interruptModal');
            const modalConfirmInterrupt = document.getElementById('modalConfirmInterrupt');
            const modalCancelInterrupt = document.getElementById('modalCancelInterrupt');

            const deleteProjectModal = document.getElementById('deleteProjectModal');
            const deleteProjectName = document.getElementById('deleteProjectName');
            const modalConfirmDelete = document.getElementById('modalConfirmDelete');
            const modalCancelDelete = document.getElementById('modalCancelDelete');

            let questionTextElement = document.getElementById('questionText');
            let optionsGridElement = document.getElementById('optionsGrid');
            const quizTitleEl = document.getElementById('quizTitle');
            const questionImage = document.getElementById('questionImage');
            const longContentBox = document.getElementById('longContentBox');
            const submissionArea = document.getElementById('submissionArea');
            const feedbackMessageElement = document.getElementById('feedbackMessage');
            const feedbackResultElement = document.getElementById('feedbackResult');
            const explanationContentElement = document.getElementById('explanationContent');
            const explanationTextElement = explanationContentElement.querySelector('.explanation-text');
            const toggleExplanationButton = document.getElementById('toggleExplanationButton');
            const nextButton = document.getElementById('nextButton');
            const interruptButton = document.getElementById('interruptButton');
            const progressBarContainer = document.querySelector('.progress-container');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const finalScore = document.getElementById('finalScore');
            const scoreComment = document.getElementById('scoreComment');
            const confettiContainer = document.getElementById('confettiContainer');
            const restartQuizButton = document.getElementById('restartQuizButton');
            const backToProjectButton = document.getElementById('backToProjectButton');
            
            // Settings DOM
            const darkModeToggle = document.getElementById('darkModeToggle');
            const themeColorCircles = document.querySelectorAll('.color-circle');
            const soundVolumeSlider = document.getElementById('soundVolumeSlider');
            const questionCountSelect = document.getElementById('questionCountSelect');
            const shuffleQuestionsToggle = document.getElementById('shuffleQuestionsToggle');
            const showProgressToggle = document.getElementById('showProgressToggle');
            const masteryModeToggle = document.getElementById('masteryModeToggle');
            const backToProjectFromSettings = document.getElementById('backToProjectFromSettings');
            const editQuizzesButton = document.getElementById('editQuizzesButton');

            // Edit Quiz Modal DOM
            const editQuizzesModal = document.getElementById('editQuizzesModal');
            const editQuizList = document.getElementById('editQuizList');
            const closeEditQuizModalButton = document.getElementById('closeEditQuizModalButton');
            
            const renameQuizInstanceModal = document.getElementById('renameQuizInstanceModal');
            const renameQuizNameInstanceInput = document.getElementById('renameQuizNameInstanceInput');

            const deleteQuizInstanceModal = document.getElementById('deleteQuizInstanceModal');
            const deleteQuizNameInstance = document.getElementById('deleteQuizNameInstance');
            const resetMasteryModal = document.getElementById('resetMasteryModal');

            // ToS & PWA Prompt DOM
            const tosModal = document.getElementById('tosModal');
            const tosAgreeButton = document.getElementById('tosAgreeButton');
            const addToHomeScreenPopup = document.getElementById('addToHomeScreenPopup');
            const closeAddToHomeScreen = document.getElementById('closeAddToHomeScreen');


            // --- App State ---
            let appState = {
                projects: [],
                settings: {
                    darkMode: false,
                    themeColor: 'default',
                    soundVolume: 75,
                    questionCount: 5,
                    shuffleQuestions: true,
                    showProgress: true,
                    masteryMode: false,
                }
            };
            let activeProjectId = null;
            let currentQuiz = null; 
            let confettiAnimationId;
            let tempGeneratedQuestions = null;
            let uploadedFiles = []; // Array of { name, content: <base64_data_url>, mimeType: <string> }
            let projectToEditId = null;
            let quizToEditId = null; // For renaming/deleting specific quizzes
            
            // --- Sound Effects ---
            const sounds = {
                correct: new Tone.Synth({ volume: -6, oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination(),
                incorrect: new Tone.FMSynth({ volume: 0, harmonicity: 1.5, modulationIndex: 10, oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.01, release: 0.1 } }).toDestination(),
                click: new Tone.Synth({ volume: -9, oscillator: { type: 'triangle' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.1 } }).toDestination(),
                fanfare: new Tone.PolySynth(Tone.Synth, { volume: -4 }).toDestination(),
            };
            
            const updateVolume = (level) => {
                const numberLevel = Number(level);
                let db;
                if (numberLevel === 0) {
                    db = -Infinity; // Mute
                } else {
                    // Map 1-100 to a decibel range of -30dB to 0dB for a better perceived volume scale
                    db = (numberLevel / 100) * 30 - 30;
                }
                Object.values(sounds).forEach((sound, index) => {
                    // Make 'incorrect' sound relatively louder
                    const isIncorrect = Object.keys(sounds)[index] === 'incorrect';
                    sound.volume.value = db + (isIncorrect ? 6 : 0);
                });
                appState.settings.soundVolume = numberLevel;
            };

            async function playSound(type) {
                if (appState.settings.soundVolume === 0) return;
                if (Tone.context.state !== 'running') await Tone.start();
                const now = Tone.now();
                try {
                    switch (type) {
                        case 'correct': sounds.correct.triggerAttackRelease("C5", "8n", now); break;
                        case 'incorrect': sounds.incorrect.triggerAttackRelease("A2", "8n", now); break;
                        case 'click': sounds.click.triggerAttackRelease("C6", "16n", now); break;
                        case 'fanfare':
                            ["C5", "E5", "G5", "C6"].forEach((note, i) => {
                                sounds.fanfare.triggerAttackRelease(note, "8n", now + i * 0.15);
                            });
                            break;
                    }
                } catch (error) { console.error("Sound playback failed:", error); }
            }
            
            // --- Data Persistence ---
            const saveState = () => {
                localStorage.setItem('qube_app_data', JSON.stringify(appState));
            };
            const loadState = () => {
                const savedData = localStorage.getItem('qube_app_data');
                if (savedData) {
                    const loadedState = JSON.parse(savedData);
                    // Merge loaded settings with defaults to prevent errors if new settings are added
                    appState.settings = { ...appState.settings, ...loadedState.settings };
                    appState.projects = loadedState.projects || [];

                    if (appState.projects) {
                        appState.projects.forEach(p => {
                            if (!p.mastery) p.mastery = {};
                            if (p.isPinned === undefined) p.isPinned = false;
                        });
                    }
                }
            };

            // --- UI & State Management Functions ---
            const switchScreen = (screenName) => {
                Object.values(screens).forEach(s => s.classList.remove('active'));
                if (screens[screenName]) screens[screenName].classList.add('active');
                projectSettingsButton.classList.toggle('invisible', screenName !== 'projectStart');
                hamburgerButton.classList.toggle('invisible', screenName === 'quiz');
            };

            const toggleSidebar = () => {
                const isOpen = sidebar.classList.toggle('open');
                if (window.innerWidth < 768) {
                    sidebarOverlay.classList.toggle('active', isOpen);
                } else {
                    document.body.classList.toggle('sidebar-open-desktop', isOpen);
                }
            };
            
            const showNewProjectModal = () => {
                newProjectNameInput.value = `プロジェクト ${appState.projects.length + 1}`;
                newProjectModal.classList.add('show');
                newProjectNameInput.focus();
                newProjectNameInput.select();
            };

            const closeNewProjectModal = () => newProjectModal.classList.remove('show');
            
            const handleCreateProject = () => {
                const projectName = newProjectNameInput.value.trim();
                if (!projectName) {
                    newProjectNameInput.focus();
                    return;
                }
                const newProject = { 
                    id: `proj_${Date.now()}`, 
                    name: projectName, 
                    quizzes: [],
                    mastery: {},
                    lastPlayedQuizId: null,
                    isPinned: false
                };
                appState.projects.unshift(newProject);
                saveState();
                renderProjectList();
                setActiveProject(newProject.id);
                closeNewProjectModal();
                if(window.innerWidth < 768 && sidebar.classList.contains('open')) toggleSidebar();
            };

            const renderProjectList = () => {
                projectListEl.innerHTML = '';
                if (appState.projects.length === 0) {
                    projectListEl.innerHTML = '<p class="text-gray-400 p-2">まだプロジェクトがありません。</p>';
                    return;
                }
                
                // Sort projects: pinned first, then by their original order
                const sortedProjects = [...appState.projects].sort((a, b) => (b.isPinned ? 1 : 0) - (a.isPinned ? 1 : 0));

                sortedProjects.forEach(p => {
                    const projectEl = document.createElement('div');
                    projectEl.className = `project-item ${p.id === activeProjectId ? 'active' : ''}`;
                    projectEl.dataset.projectId = p.id;
                    projectEl.draggable = true;

                    let pinIcon = '';
                    if (p.isPinned) {
                        pinIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 flex-shrink-0" style="color: var(--accent-primary);" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M13.477 2.523a.75.75 0 01.023 1.06L10 7.15l-3.5-3.571a.75.75 0 011.037-1.08l3.5 3.571 3.5-3.571a.75.75 0 011.08.023zM4.5 5.5a.5.5 0 00-.5.5v9a.5.5 0 001 0v-9a.5.5 0 00-.5-.5z" clip-rule="evenodd" /></svg>`;
                    }

                    const nameEl = document.createElement('div');
                    nameEl.innerHTML = pinIcon + p.name;
                    nameEl.className = 'project-name flex items-center';
                    
                    const menuBtn = document.createElement('button');
                    menuBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" /></svg>`;
                    menuBtn.className = 'project-menu-btn';
                    
                    projectEl.appendChild(nameEl);
                    projectEl.appendChild(menuBtn);
                    projectListEl.appendChild(projectEl);

                    nameEl.addEventListener('click', () => {
                        setActiveProject(p.id);
                        if(window.innerWidth < 768) toggleSidebar();
                    });

                    menuBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showProjectMenu(p.id, e.currentTarget.parentElement);
                    });
                });
                addProjectDragDropListeners();
            };
            
            const showProjectMenu = (projectId, projectItemElement) => {
                document.querySelectorAll('.project-menu').forEach(m => m.remove());
                const project = appState.projects.find(p => p.id === projectId);
                if (!project) return;

                const pinActionText = project.isPinned ? 'ピンを外す' : 'ピン留めする';

                const menu = document.createElement('div');
                menu.className = 'project-menu';
                menu.innerHTML = `
                    <div class="project-menu-item" data-action="pin" data-project-id="${projectId}">${pinActionText}</div>
                    <div class="project-menu-item" data-action="rename" data-project-id="${projectId}">名前を変更</div>
                    <div class="project-menu-item delete" data-action="delete" data-project-id="${projectId}">削除</div>
                `;
                projectItemElement.appendChild(menu);
                
                menu.classList.add('show');
                
                const closeMenu = (e) => {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.body.removeEventListener('click', closeMenu, true);
                    }
                };

                menu.addEventListener('click', (e) => {
                    const action = e.target.dataset.action;
                    if (action === 'rename') showRenameProjectModal(projectId);
                    else if (action === 'delete') showDeleteProjectModal(projectId);
                    else if (action === 'pin') toggleProjectPin(projectId);
                    menu.remove();
                    document.body.removeEventListener('click', closeMenu, true);
                });

                setTimeout(() => document.body.addEventListener('click', closeMenu, true), 0);
            };

            const toggleProjectPin = (projectId) => {
                const project = appState.projects.find(p => p.id === projectId);
                if (project) {
                    project.isPinned = !project.isPinned;
                    saveState();
                    renderProjectList();
                }
            };

            const showRenameProjectModal = (projectId) => {
                projectToEditId = projectId;
                const project = appState.projects.find(p => p.id === projectId);
                if (project) {
                    renameProjectNameInput.value = project.name;
                    renameProjectModal.classList.add('show');
                    renameProjectNameInput.focus();
                    renameProjectNameInput.select();
                }
            };

            const closeRenameProjectModal = () => {
                renameProjectModal.classList.remove('show');
                projectToEditId = null;
            };

            const handleRenameProject = () => {
                const newName = renameProjectNameInput.value.trim();
                if (!newName || !projectToEditId) return;
                const project = appState.projects.find(p => p.id === projectToEditId);
                if (project) {
                    project.name = newName;
                    saveState();
                    renderProjectList();
                    if (activeProjectId === projectToEditId) projectTitle.textContent = newName;
                }
                closeRenameProjectModal();
            };

            const showDeleteProjectModal = (projectId) => {
                projectToEditId = projectId;
                const project = appState.projects.find(p => p.id === projectId);
                if(project) {
                    deleteProjectName.textContent = project.name;
                    deleteProjectModal.classList.add('show');
                }
            };
            
            const closeDeleteProjectModal = () => {
                deleteProjectModal.classList.remove('show');
                projectToEditId = null;
            };

            const handleDeleteProject = () => {
                if(!projectToEditId) return;
                appState.projects = appState.projects.filter(p => p.id !== projectToEditId);
                if(activeProjectId === projectToEditId) {
                    activeProjectId = null;
                    localStorage.removeItem('qube_lastActiveProjectId');
                    projectTitle.textContent = 'Qube';
                    switchScreen('welcome');
                }
                saveState();
                renderProjectList();
                closeDeleteProjectModal();
            };

            const addProjectDragDropListeners = () => {
                let draggedItem = null;
                projectListEl.querySelectorAll('.project-item').forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        draggedItem = item;
                        setTimeout(() => item.classList.add('dragging'), 0);
                    });
                    item.addEventListener('dragend', () => {
                        setTimeout(() => {
                            if (draggedItem) draggedItem.classList.remove('dragging');
                            draggedItem = null;
                        }, 0);
                    });
                });
                projectListEl.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(projectListEl, e.clientY);
                    if (draggedItem) {
                        if (afterElement == null) projectListEl.appendChild(draggedItem);
                        else projectListEl.insertBefore(draggedItem, afterElement);
                    }
                });
                projectListEl.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const newOrderIds = Array.from(projectListEl.querySelectorAll('.project-item')).map(item => item.dataset.projectId);
                    // This reorders the original array based on the new DOM order
                    appState.projects.sort((a, b) => newOrderIds.indexOf(a.id) - newOrderIds.indexOf(b.id));
                    saveState();
                    renderProjectList(); // Re-render to enforce pinning sort visually
                });
            };

            const getDragAfterElement = (container, y) => {
                const draggableElements = [...container.querySelectorAll('.project-item:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                    else return closest;
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            };

            const setActiveProject = (projectId) => {
                activeProjectId = projectId;
                localStorage.setItem('qube_lastActiveProjectId', projectId);
                resetUploadUI();
                promptText.value = '';
                const project = appState.projects.find(p => p.id === projectId);
                if (project) {
                    projectTitle.textContent = project.name;
                    if (project.quizzes.length === 0) {
                        switchScreen('generate'); 
                    } else {
                        populateQuizSelect(project);
                        switchScreen('projectStart');
                    }
                }
                renderProjectList();
            };

            const populateQuizSelect = (project) => {
                quizSelect.innerHTML = '';
                if (project.quizzes.length === 0) {
                    const option = document.createElement('option');
                    option.textContent = '利用可能なクイズがありません';
                    option.disabled = true;
                    quizSelect.appendChild(option);
                    startSelectedQuizButton.disabled = true;
                } else {
                    const requiredMasteryCount = appState.settings.masteryMode ? 2 : 1;
                    project.quizzes.forEach(quiz => {
                        const masteryData = (project.mastery && project.mastery[quiz.id]) ? project.mastery[quiz.id] : {};
                        const masteredCount = Object.values(masteryData).filter(count => count >= requiredMasteryCount).length;
                        const isFullyMastered = masteredCount === quiz.questions.length && quiz.questions.length > 0;
                        
                        const option = document.createElement('option');
                        option.value = quiz.id;
                        option.textContent = (isFullyMastered ? '✅ ' : '') + quiz.name;
                        quizSelect.appendChild(option);
                    });
                    startSelectedQuizButton.disabled = false;
                    if (project.lastPlayedQuizId) {
                        quizSelect.value = project.lastPlayedQuizId;
                    }
                }
            };

            const shuffleArray = (array) => {
                const newArr = [...array];
                for (let i = newArr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
                }
                return newArr;
            };
            
            // --- Quiz Generation (Qube Core) ---
            const handleGenerateQuiz = async () => {
                const buttonText = generateQuizButton.querySelector('.button-text');
                const spinner = generateQuizButton.querySelector('.spinner');
                generationError.classList.add('hidden');
                generationWarning.classList.add('hidden');

                if (promptText.value.trim() === '' && uploadedFiles.length === 0) {
                    generationError.textContent = 'クイズの元になる内容を入力またはアップロードしてください。';
                    generationError.classList.remove('hidden');
                    return;
                }

                const warningTimeout = setTimeout(() => {
                    generationWarning.textContent = '生成に時間がかかる可能性があります...';
                    generationWarning.classList.remove('hidden');
                }, 15000); // Increased timeout

                buttonText.textContent = '生成中...';
                spinner.classList.remove('hidden');
                generateQuizButton.disabled = true;
                
                let payload;

                try {
                    const apiKey = "AIzaSyAmL3qPv1Zr0URta9hE0a4QCveWOfonBHc"; // API Key is managed by the environment

                    const isAutoGenre = autoGenreCheckbox.checked;
                    const selectedType = questionType.value;
                    const numQuestions = genQuestionCount.value === 'all' ? '可能な限り多く' : `${genQuestionCount.value}問`;
                    
                    // Simplified, unified prompt for better performance and reliability
                    let basePrompt = `提供されたテキストとファイルの内容を分析し、質の高いクイズを${numQuestions}作成してください。`;
                    if (isAutoGenre) {
                         basePrompt += `内容を複数のジャンルに分け、各ジャンルごとに問題を作成してください。`;
                    }
                     basePrompt += `各問題には、内容に最適な形式("multiple_choice", "multiple_select", "fill_in_the_blank", "sorting")をAIが判断して指定し、必ず詳細な解説を付けてください。`;
                    if (selectedType !== 'auto_select') {
                        basePrompt += `問題形式は「${questionType.options[questionType.selectedIndex].text}」に統一してください。`
                    }
                     basePrompt += `生成される問題は、提供された情報源と完全に一致し、事実として正確でなければなりません。`;
                    
                    payload = {
                        contents: [{ role: "user", parts: [] }],
                        generationConfig: { responseMimeType: "application/json" }
                    };
                    
                    const parts = [{ text: basePrompt }];
                    if (promptText.value.trim()) {
                        parts.push({ text: `\n\n--- テキスト内容 ---\n${promptText.value}` });
                    }
                     uploadedFiles.forEach(file => {
                        parts.push({
                            inlineData: {
                                mimeType: file.mimeType,
                                data: file.content.split(',')[1] // Extract base64 data
                            }
                        });
                    });
                    payload.contents[0].parts = parts;
                    
                    let itemSchema = {
                        type: "OBJECT",
                        properties: {
                            question: { type: "STRING" },
                            type: { type: "STRING" },
                            options: { type: "ARRAY", items: { type: "STRING" } },
                            items: { type: "ARRAY", items: { type: "STRING" } },
                            answer: { type: "ARRAY", items: { type: "STRING" } },
                            explanation: { type: "STRING" },
                            long_content: { type: "STRING" },
                            image_source: { type: "BOOLEAN" }
                        },
                        required: ["question", "type", "answer", "explanation"]
                    };

                    if (isAutoGenre) {
                        payload.generationConfig.responseSchema = {
                            type: "OBJECT",
                            properties: {
                                "genres": {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            "genre_name": { type: "STRING" },
                                            "quizzes": { type: "ARRAY", items: itemSchema }
                                        },
                                        required: ["genre_name", "quizzes"]
                                    }
                                }
                            }
                        };
                    } else {
                        payload.generationConfig.responseSchema = {
                            type: "OBJECT",
                            properties: { "quizzes": { "type": "ARRAY", "items": itemSchema } }
                        };
                    }
                    
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                         const errorBody = await response.text();
                         console.error("API Error Response:", errorBody);
                         throw new Error(`APIリクエストに失敗しました (ステータス: ${response.status})`);
                    }
                    const result = await response.json();
                    
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const generatedData = JSON.parse(result.candidates[0].content.parts[0].text);
                        
                        const processQuestions = (questions) => {
                            return questions.map(q => {
                                let processed = {...q};
                                if (!Array.isArray(processed.answer)) {
                                     processed.answer = [String(processed.answer)];
                                }
                                return processed;
                            });
                        };

                        if (isAutoGenre && generatedData.genres) {
                            const processedGenres = generatedData.genres.map(genre => ({
                                ...genre,
                                quizzes: processQuestions(genre.quizzes || [])
                            }));
                            handleAutoGenreResponse(processedGenres);
                        } else if (generatedData.quizzes) {
                            tempGeneratedQuestions = processQuestions(generatedData.quizzes);
                            showNameQuizModal();
                        } else {
                            throw new Error("AIからの応答が期待された形式ではありません。");
                        }
                    } else {
                         console.error("Invalid API response structure:", result);
                         throw new Error("AIからの応答が無効、または空です。");
                    }
                } catch (error) {
                    console.error("Quiz generation failed:", error);
                    if(payload) {
                        console.error("Failed Payload:", JSON.stringify(payload, null, 2));
                    }
                    generationError.textContent = `クイズの生成に失敗しました: ${error.message}`;
                    generationError.classList.remove('hidden');
                } finally {
                    clearTimeout(warningTimeout);
                    generationWarning.classList.add('hidden');
                    buttonText.textContent = 'クイズを生成する';
                    spinner.classList.add('hidden');
                    generateQuizButton.disabled = false;
                }
            };
            
            const handleAutoGenreResponse = (genres) => {
                const project = appState.projects.find(p => p.id === activeProjectId);
                if (!project || !genres) return;

                genres.forEach(genre => {
                    if (genre.quizzes && genre.quizzes.length > 0) {
                        const newQuiz = {
                            id: `quiz_${Date.now()}_${Math.random()}`,
                            name: genre.genre_name,
                            createdAt: new Date().toISOString(),
                            questions: genre.quizzes,
                            images: uploadedFiles.filter(f => f.mimeType.startsWith('image/'))
                        };
                        project.quizzes.push(newQuiz);
                        project.mastery[newQuiz.id] = {};
                    }
                });
                saveState();
                setActiveProject(activeProjectId);
            };

            const showNameQuizModal = () => {
                const project = appState.projects.find(p => p.id === activeProjectId);
                if (!project) return;
                newQuizNameInput.value = `クイズ ${project.quizzes.length + 1}`;
                nameQuizModal.classList.add('show');
                newQuizNameInput.focus();
                newQuizNameInput.select();
            };
            
            const closeNameQuizModal = () => nameQuizModal.classList.remove('show');

            const handleCreateQuiz = () => {
                const quizName = newQuizNameInput.value.trim();
                if (!quizName) {
                    newQuizNameInput.focus();
                    return;
                }
                const project = appState.projects.find(p => p.id === activeProjectId);
                if (project && tempGeneratedQuestions) {
                    const newQuiz = {
                        id: `quiz_${Date.now()}`,
                        name: quizName,
                        createdAt: new Date().toISOString(),
                        questions: tempGeneratedQuestions,
                        images: uploadedFiles.filter(f => f.mimeType.startsWith('image/'))
                    };
                    project.quizzes.push(newQuiz);
                    project.mastery[newQuiz.id] = {};
                    saveState();
                    tempGeneratedQuestions = null;
                    closeNameQuizModal();
                    setActiveProject(activeProjectId); 
                }
            };

            // --- Quiz Gameplay ---
            const startQuiz = (quiz) => {
                document.querySelectorAll('.project-menu').forEach(m => m.remove());
                if (!quiz || !quiz.questions || quiz.questions.length === 0) return;

                const project = appState.projects.find(p => p.id === activeProjectId);
                project.lastPlayedQuizId = quiz.id;
                saveState();
                
                const requiredMasteryCount = appState.settings.masteryMode ? 2 : 1;
                const masteryData = (project.mastery && project.mastery[quiz.id]) ? project.mastery[quiz.id] : {};
                
                let unmasteredIndices = quiz.questions
                    .map((_, index) => index)
                    .filter(index => (masteryData[index] || 0) < requiredMasteryCount);

                if (unmasteredIndices.length === 0) {
                     resetMasteryModal.classList.add('show');
                     resetMasteryModal.querySelector('.reset').onclick = () => {
                         project.mastery[quiz.id] = {};
                         saveState();
                         resetMasteryModal.classList.remove('show');
                         startQuiz(quiz);
                     };
                     resetMasteryModal.querySelector('.cancel').onclick = () => {
                         resetMasteryModal.classList.remove('show');
                     };
                     return;
                }
                
                const finalIndices = appState.settings.shuffleQuestions 
                    ? shuffleArray([...unmasteredIndices]) 
                    : unmasteredIndices;

                const questionLimit = appState.settings.questionCount;
                const questionsToAskIndices = finalIndices.slice(0, questionLimit);

                const questionsToAsk = questionsToAskIndices.map(index => quiz.questions[index]);
                
                currentQuiz = { 
                    ...quiz, 
                    questions: questionsToAsk,
                    originalIndices: questionsToAskIndices,
                    currentIndex: 0, 
                    score: 0, 
                    answeredQuestions: new Set() 
                };

                quizTitleEl.textContent = quiz.name;
                switchScreen('quiz');
                loadQuestion();
            };

            const loadQuestion = () => {
                feedbackMessageElement.style.visibility = 'hidden';
                feedbackMessageElement.classList.remove('correct-feedback', 'incorrect-feedback');
                feedbackResultElement.innerHTML = '';

                if (currentQuiz.currentIndex >= currentQuiz.questions.length) {
                    showQuizResult();
                    return;
                }

                const parent = optionsGridElement.parentNode;
                const newGrid = optionsGridElement.cloneNode(false);
                parent.replaceChild(newGrid, optionsGridElement);
                optionsGridElement = newGrid;

                const question = currentQuiz.questions[currentQuiz.currentIndex];
                questionTextElement.innerHTML = question.question;
                submissionArea.innerHTML = '';
                questionImage.classList.add('hidden');
                longContentBox.style.display = 'none';
                
                explanationContentElement.classList.remove('show');
                toggleExplanationButton.classList.add('hidden');
                toggleExplanationButton.textContent = '解説▼';


                if(question.image_source && currentQuiz.images && currentQuiz.images.length > 0) {
                    const imageForQuestion = currentQuiz.images.find(img => question.question.includes(img.name.split('.')[0]));
                    if(imageForQuestion) {
                        questionImage.src = imageForQuestion.content;
                        questionImage.classList.remove('hidden');
                    }
                }

                if (question.long_content) {
                    longContentBox.textContent = question.long_content;
                    longContentBox.style.display = 'block';
                }

                switch(question.type) {
                    case 'multiple_choice':
                        (appState.settings.shuffleQuestions ? shuffleArray([...question.options]) : [...question.options]).forEach(option => {
                            const button = document.createElement('button');
                            button.innerHTML = option;
                            button.classList.add('option-button');
                            button.dataset.option = option;
                            button.addEventListener('click', () => submitAnswer([option]));
                            optionsGridElement.appendChild(button);
                        });
                        break;
                    case 'multiple_select':
                        (appState.settings.shuffleQuestions ? shuffleArray([...question.options]) : [...question.options]).forEach(option => {
                            const button = document.createElement('button');
                            button.innerHTML = option;
                            button.classList.add('option-button');
                            button.dataset.option = option;
                            button.addEventListener('click', () => button.classList.toggle('selected'));
                            optionsGridElement.appendChild(button);
                        });
                        createSubmitButton();
                        break;
                    case 'fill_in_the_blank':
                        optionsGridElement.innerHTML = `<input type="text" id="fillInBlankInput" placeholder="答えを入力...">`;
                        createSubmitButton();
                        break;
                    case 'sorting':
                        optionsGridElement.classList.add('options-grid-full-width');
                        optionsGridElement.innerHTML = `
                            <div class="sorting-container">
                                <div>
                                    <h4 class="font-semibold mb-2 text-center">解答欄</h4>
                                    <div id="sortingTarget" class="sorting-box"></div>
                                </div>
                                <div>
                                    <h4 class="font-semibold mb-2 text-center">選択肢</h4>
                                    <div id="sortingSource" class="sorting-box"></div>
                                </div>
                            </div>`;
                        const sourceContainer = document.getElementById('sortingSource');
                        const shuffledItems = shuffleArray([...question.items]);
                        shuffledItems.forEach(itemText => {
                            const div = document.createElement('div');
                            div.innerHTML = itemText;
                            div.classList.add('option-button', 'sorting-item');
                            div.draggable = true;
                            sourceContainer.appendChild(div);
                        });
                        setupSortingInteractions();
                        createSubmitButton();
                        break;
                    default: 
                         optionsGridElement.innerHTML = `<p class="text-red-500">不明な問題形式です。</p>`;
                         currentQuiz.answeredQuestions.add(question.question);
                        break;
                }
                if(question.type !== 'sorting') {
                    optionsGridElement.classList.remove('options-grid-full-width');
                }

                updateProgressBar();
                updateNavigationButtons();
            };
            
            const createSubmitButton = () => {
                const submitBtn = document.createElement('button');
                submitBtn.textContent = '回答';
                submitBtn.classList.add('btn', 'btn-primary');
                submitBtn.addEventListener('click', () => {
                    const question = currentQuiz.questions[currentQuiz.currentIndex];
                    let answer;
                    switch(question.type) {
                        case 'multiple_select':
                            answer = Array.from(optionsGridElement.querySelectorAll('.option-button.selected')).map(btn => btn.dataset.option);
                            break;
                        case 'fill_in_the_blank':
                            answer = [document.getElementById('fillInBlankInput').value];
                            break;
                        case 'sorting':
                             answer = Array.from(document.getElementById('sortingTarget').querySelectorAll('.sorting-item')).map(item => item.textContent);
                             break;
                    }
                    submitAnswer(answer);
                });
                submissionArea.appendChild(submitBtn);
            }

            const submitAnswer = (userAnswer) => {
                const question = currentQuiz.questions[currentQuiz.currentIndex];
                if (currentQuiz.answeredQuestions.has(question.question)) return;

                let isCorrect = false;

                switch(question.type) {
                    case 'multiple_choice':
                    case 'fill_in_the_blank':
                        isCorrect = userAnswer[0].toLowerCase().trim() === question.answer[0].toLowerCase().trim();
                        break;
                    case 'multiple_select':
                        const sortedUserAnswer = [...userAnswer].sort();
                        const sortedCorrectAnswer = [...question.answer].sort();
                        isCorrect = JSON.stringify(sortedUserAnswer) === JSON.stringify(sortedCorrectAnswer);
                        break;
                    case 'sorting':
                        isCorrect = JSON.stringify(userAnswer) === JSON.stringify(question.items);
                        break;
                }
                
                showFeedback(isCorrect, question, userAnswer);
            };

            const showFeedback = (isCorrect, question, userAnswer) => {
                optionsGridElement.querySelectorAll('button, input, .sorting-item').forEach(el => {
                    el.disabled = true;
                });
                submissionArea.innerHTML = '';
                feedbackMessageElement.style.visibility = 'visible';
                const project = appState.projects.find(p => p.id === activeProjectId);
                const originalIndex = currentQuiz.originalIndices[currentQuiz.currentIndex];
                if (!project.mastery[currentQuiz.id]) {
                    project.mastery[currentQuiz.id] = {};
                }
                const currentMasteryCount = project.mastery[currentQuiz.id][originalIndex] || 0;


                if (isCorrect) {
                    playSound('correct');
                    feedbackResultElement.innerHTML = `<strong>正解！</strong>`;
                    feedbackMessageElement.classList.add('correct-feedback');
                    currentQuiz.score++;
                    project.mastery[currentQuiz.id][originalIndex] = currentMasteryCount + 1;

                } else {
                    playSound('incorrect');
                    let correctAnswerText;
                    if (question.type === 'sorting') {
                        correctAnswerText = question.items.join(' → ');
                    } else {
                        correctAnswerText = Array.isArray(question.answer) ? question.answer.join(', ') : question.answer;
                    }
                    feedbackResultElement.innerHTML = `<strong>不正解...</strong> 正解は「${correctAnswerText}」でした。`;
                    feedbackMessageElement.classList.add('incorrect-feedback');
                    project.mastery[currentQuiz.id][originalIndex] = 0; // Reset consecutive count on incorrect
                }
                saveState();
                
                currentQuiz.answeredQuestions.add(question.question);

                if (question.type === 'multiple_choice') {
                    optionsGridElement.querySelectorAll('.option-button').forEach(button => {
                        if (button.dataset.option === question.answer[0]) {
                            button.classList.add('correct');
                        } else if (button.dataset.option === userAnswer[0]) {
                            button.classList.add('incorrect');
                        }
                    });
                } else if (question.type === 'multiple_select') {
                    optionsGridElement.querySelectorAll('.option-button').forEach(button => {
                        const isCorrectAnswer = question.answer.includes(button.dataset.option);
                        const wasSelected = userAnswer.includes(button.dataset.option);
                        if (isCorrectAnswer) {
                            button.classList.add('correct');
                        } else if (wasSelected && !isCorrectAnswer) {
                            button.classList.add('incorrect');
                        }
                    });
                } else if(question.type === 'fill_in_the_blank') {
                    document.getElementById('fillInBlankInput').classList.add(isCorrect ? 'correct' : 'incorrect');
                }

                if (question.explanation) {
                    explanationTextElement.textContent = question.explanation;
                    toggleExplanationButton.classList.remove('hidden');
                }
                updateNavigationButtons();
            };
            
            const setupSortingInteractions = () => {
                const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
                const sourceContainer = document.getElementById('sortingSource');
                const targetContainer = document.getElementById('sortingTarget');

                const moveItem = (item) => {
                    if (item.parentElement === sourceContainer) {
                        targetContainer.appendChild(item);
                    } else {
                        sourceContainer.appendChild(item);
                    }
                };
                
                if (isTouchDevice) {
                    optionsGridElement.addEventListener('click', (e) => {
                        if (e.target.classList.contains('sorting-item')) {
                            moveItem(e.target);
                        }
                    });
                } else {
                    let draggedItem = null;
                    optionsGridElement.addEventListener('dragstart', (e) => {
                        if (e.target.classList.contains('sorting-item')) {
                            draggedItem = e.target;
                            setTimeout(() => e.target.classList.add('dragging'), 0);
                        }
                    });
                    optionsGridElement.addEventListener('dragend', (e) => {
                        if (draggedItem) {
                            draggedItem.classList.remove('dragging');
                            draggedItem = null;
                        }
                    });
                    [sourceContainer, targetContainer].forEach(container => {
                        container.addEventListener('dragover', e => {
                            e.preventDefault();
                            const afterElement = getDragAfterElement(container, e.clientY);
                            if (draggedItem) {
                                if (afterElement == null) {
                                    container.appendChild(draggedItem);
                                } else {
                                    container.insertBefore(draggedItem, afterElement);
                                }
                            }
                        });
                    });
                }
            };


            const updateNavigationButtons = () => {
                const question = currentQuiz.questions[currentQuiz.currentIndex];
                if (!question) {
                    nextButton.style.display = 'none';
                    return;
                }
                const isAnswered = currentQuiz.answeredQuestions.has(question.question);
                nextButton.style.display = isAnswered ? 'block' : 'none';
                nextButton.textContent = (currentQuiz.currentIndex === currentQuiz.questions.length - 1) ? '結果を見る' : '次の問題';
            };

            const updateProgressBar = () => {
                if (!appState.settings.showProgress) {
                    progressBarContainer.style.display = 'none';
                    progressText.style.display = 'none';
                    return;
                }
                progressBarContainer.style.display = 'block';
                progressText.style.display = 'block';
                const total = currentQuiz.questions.length;
                const current = currentQuiz.currentIndex + 1;
                const progress = total > 0 ? current / total : 0;
                progressBar.style.width = `${progress * 100}%`;
                progressText.textContent = `${Math.min(current, total)} / ${total} 問目`;
            };

            const showQuizResult = () => {
                switchScreen('result');
                const total = currentQuiz.questions.length;
                finalScore.textContent = `あなたのスコア: ${currentQuiz.score} / ${total}`;
                const percentage = total === 0 ? 0 : (currentQuiz.score / total) * 100;
                let comment = '';
                if (currentQuiz.score === total && total > 0) {
                    comment = '素晴らしい！全問正解です！🎉';
                    playSound('fanfare');
                    setTimeout(launchConfetti, 100);
                } else if (percentage >= 80) {
                    comment = 'よくできました！この調子で頑張りましょう！✨';
                } else if (percentage >= 50) {
                    comment = 'もう少しです！復習して、さらに上を目指しましょう！👍';
                } else {
                    comment = '頑張ろう！基礎をしっかり固めていきましょう！💪';
                }
                scoreComment.textContent = comment;
            };

            const launchConfetti = () => {
                if (confettiAnimationId) cancelAnimationFrame(confettiAnimationId);
                confettiContainer.innerHTML = '';
                const confettiPieces = [];
                const numConfetti = 100;
                const colors = ['#f43f5e', '#38bdf8', '#fbbf24', '#34d399', '#8b5cf6'];
                for (let i = 0; i < numConfetti; i++) {
                    const confetti = document.createElement('div');
                    confetti.classList.add('confetti');
                    confetti.style.backgroundColor = colors[i % colors.length];
                    confettiContainer.appendChild(confetti);
                    const piece = { element: confetti, x: confettiContainer.clientWidth / 2, y: confettiContainer.clientHeight, vx: (Math.random() - 0.5) * 10, vy: -Math.random() * 15 - 5, rotation: Math.random() * 360, rotationSpeed: (Math.random() - 0.5) * 20 };
                    confettiPieces.push(piece);
                }
                let startTime = null;
                function animate(timestamp) {
                    if (!startTime) startTime = timestamp;
                    let allOffScreen = true;
                    confettiPieces.forEach(p => {
                        p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.vx *= 0.99; p.rotation += p.rotationSpeed;
                        if (p.y < confettiContainer.clientHeight + 20) allOffScreen = false;
                        p.element.style.transform = `translate(${p.x}px, ${p.y}px) rotate(${p.rotation}deg)`;
                    });
                    if (allOffScreen && (timestamp - startTime) > 1000) {
                        cancelAnimationFrame(confettiAnimationId);
                    } else {
                        confettiAnimationId = requestAnimationFrame(animate);
                    }
                }
                confettiAnimationId = requestAnimationFrame(animate);
            };
            
            // --- Helper function to convert hex to RGB ---
            const hexToRgb = (hex) => {
                let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            }

            // --- Settings Functions ---
            const applyColors = (themeName, isDark) => {
                const root = document.documentElement;
                const themes = {
                     'default': { base: '#0ea5e9', hover: '#0284c7', darkBase: '#38bdf8', darkHover: '#0ea5e9' },
                     'red': { base: '#ef4444', hover: '#dc2626', darkBase: '#f87171', darkHover: '#ef4444' },
                     'green': { base: '#10b981', hover: '#059669', darkBase: '#4ade80', darkHover: '#10b981' },
                     'indigo': { base: '#6366f1', hover: '#4f46e5', darkBase: '#818cf8', darkHover: '#6366f1' }
                };
                const theme = themes[themeName] || themes.default;
                const accentColor = isDark ? theme.darkBase : theme.base;
                const accentHover = isDark ? theme.darkHover : theme.hover;
                const rgb = hexToRgb(accentColor);

                root.style.setProperty('--accent-primary', accentColor);
                root.style.setProperty('--accent-primary-hover', accentHover);
                root.style.setProperty('--accent-primary-shadow', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.3)`);
                root.style.setProperty('--progress-bar-bg', accentColor);
                
                // Set theme-derived backgrounds
                if (isDark) {
                    root.style.setProperty('--themed-text-color', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.9)`);
                    root.style.setProperty('--bg-tertiary', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.2)`);
                    root.style.setProperty('--bg-welcome', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.15)`);
                } else {
                    root.style.setProperty('--themed-text-color', theme.hover);
                    root.style.setProperty('--bg-tertiary', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.1)`);
                    root.style.setProperty('--bg-welcome', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.05)`);
                }
            };
            
            const setDarkMode = (isDark) => {
                appState.settings.darkMode = isDark;
                document.body.classList.toggle('dark-mode', isDark);
                applyColors(appState.settings.themeColor, isDark);
                // Update status bar color on toggle
                document.querySelector('meta[name="theme-color"]').content = isDark ? '#0f172a' : '#f0f9ff';
                saveState();
            };

            const setThemeColor = (themeName) => {
                appState.settings.themeColor = themeName;
                applyColors(themeName, appState.settings.darkMode);
                saveState();
            };

            // --- File Upload Logic ---
            const handleFileSelect = async (files) => {
                fileUpload.disabled = true;
                const filePromises = Array.from(files).map(file => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve({ 
                            name: file.name, 
                            content: e.target.result, // This is a data URL (e.g., "data:image/png;base64,iVBOR...")
                            mimeType: file.type 
                        });
                        reader.onerror = (err) => reject(err);
                        reader.readAsDataURL(file); // Read ANY file as a data URL
                    });
                });

                try {
                    const results = await Promise.all(filePromises);
                    uploadedFiles.push(...results);
                    await updateUIAfterFileUpload();
                } catch (err) {
                    generationError.textContent = `ファイルの読み込みに失敗しました: ${err.message}`;
                    generationError.classList.remove('hidden');
                } finally {
                    fileUpload.value = '';
                    fileUpload.disabled = false;
                }
            };

            const updateUIAfterFileUpload = async () => {
                filePreviewContainer.innerHTML = '';
                for (const [index, file] of uploadedFiles.entries()) {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'file-preview-item';

                    if (file.mimeType.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.src = file.content;
                        itemDiv.appendChild(img);
                    } else { // For PDF, PPTX, and any other file, show a generic icon
                        const icon = document.createElement('div');
                        icon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>`;
                        itemDiv.appendChild(icon);
                    }

                    const p = document.createElement('p');
                    p.className = 'file-name';
                    p.textContent = file.name;
                    itemDiv.appendChild(p);
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-file-btn';
                    removeBtn.innerHTML = '&times;';
                    removeBtn.onclick = (e) => {
                        e.stopPropagation();
                        uploadedFiles.splice(index, 1);
                        updateUIAfterFileUpload();
                    };
                    itemDiv.appendChild(removeBtn);
                    filePreviewContainer.appendChild(itemDiv);
                }

                if (uploadedFiles.length > 0) {
                    promptLabel.textContent = 'アップロードしたファイルへの追加指示 (任意)';
                    promptText.placeholder = '例: この内容について5問作成してください。';
                } else {
                    resetUploadUI();
                }
            };

            const resetUploadUI = () => {
                uploadedFiles = [];
                filePreviewContainer.innerHTML = '';
                fileUpload.value = ''; 
                promptLabel.textContent = 'クイズにしたい内容を入力または貼り付け';
                promptText.placeholder = '例: 日本の首都は東京です。徳川家康は江戸幕府を開きました...';
            };
            
            // --- Edit Quiz Functions ---
            const showEditQuizzesModal = () => {
                const project = appState.projects.find(p => p.id === activeProjectId);
                if (!project) return;

                editQuizList.innerHTML = '';
                if (project.quizzes.length === 0) {
                    editQuizList.innerHTML = '<p class="text-gray-400 p-2">このプロジェクトにはまだクイズがありません。</p>';
                } else {
                    project.quizzes.forEach(quiz => {
                        const quizEl = document.createElement('div');
                        quizEl.className = 'project-item';
                        quizEl.draggable = true;
                        quizEl.dataset.quizId = quiz.id;
                        quizEl.innerHTML = `
                            <span class="drag-handle">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                            </span>
                            <div class="project-name">${quiz.name}</div>
                            <button class="project-menu-btn" data-action="rename" data-quiz-id="${quiz.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-11.212 11.212-3.536.354.354-3.536L13.586 3.586z" /></svg>
                            </button>
                            <button class="project-menu-btn text-red-500" data-action="delete" data-quiz-id="${quiz.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                        `;
                        editQuizList.appendChild(quizEl);
                    });
                    addQuizDragDropListeners();
                }
                editQuizzesModal.classList.add('show');
            };

            const updateQuizOrder = () => {
                const project = appState.projects.find(p => p.id === activeProjectId);
                if (!project) return;
                const newOrderIds = Array.from(editQuizList.querySelectorAll('.project-item')).map(item => item.dataset.quizId);
                project.quizzes.sort((a, b) => newOrderIds.indexOf(a.id) - newOrderIds.indexOf(b.id));
                saveState();
                populateQuizSelect(project);
            };

            const addQuizDragDropListeners = () => {
                let draggedItem = null;

                // --- MOUSE DRAG & DROP ---
                editQuizList.querySelectorAll('.project-item').forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        draggedItem = item;
                        setTimeout(() => item.classList.add('dragging'), 0);
                    });
                    item.addEventListener('dragend', () => {
                        if (draggedItem) draggedItem.classList.remove('dragging');
                        draggedItem = null;
                    });
                });
                editQuizList.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(editQuizList, e.clientY);
                    if (draggedItem) {
                        if (afterElement == null) editQuizList.appendChild(draggedItem);
                        else editQuizList.insertBefore(draggedItem, afterElement);
                    }
                });
                editQuizList.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (!draggedItem) return;
                    updateQuizOrder();
                });

                // --- TOUCH DRAG & DROP ---
                let touchDraggedItem = null;
                const touchStart = (e) => {
                    if (!e.target.classList.contains('drag-handle') && !e.target.closest('.drag-handle')) return;
                    e.preventDefault();
                    touchDraggedItem = e.target.closest('.project-item');
                    touchDraggedItem.classList.add('dragging');
                    document.addEventListener('touchmove', touchMove, { passive: false });
                    document.addEventListener('touchend', touchEnd, { once: true });
                };
                const touchMove = (e) => {
                    if (!touchDraggedItem) return;
                    e.preventDefault();
                    const y = e.touches[0].clientY;
                    const afterElement = getDragAfterElement(editQuizList, y);
                    if (afterElement == null) editQuizList.appendChild(touchDraggedItem);
                    else editQuizList.insertBefore(touchDraggedItem, afterElement);
                };
                const touchEnd = () => {
                    if (!touchDraggedItem) return;
                    touchDraggedItem.classList.remove('dragging');
                    touchDraggedItem = null;
                    updateQuizOrder();
                    document.removeEventListener('touchmove', touchMove);
                };
                
                editQuizList.removeEventListener('touchstart', touchStart); // Clean up previous listeners
                editQuizList.addEventListener('touchstart', touchStart, { passive: false });
            };

            const handleQuizEditActions = (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                
                const action = button.dataset.action;
                const id = button.dataset.quizId;
                if (!action || !id) return;

                quizToEditId = id;
                const project = appState.projects.find(p => p.id === activeProjectId);
                const quiz = project?.quizzes.find(q => q.id === quizToEditId);
                if (!quiz) return;

                if (action === 'rename') {
                    renameQuizNameInstanceInput.value = quiz.name;
                    renameQuizInstanceModal.classList.add('show');
                    renameQuizNameInstanceInput.focus();
                    renameQuizNameInstanceInput.select();
                } else if (action === 'delete') {
                    deleteQuizNameInstance.textContent = quiz.name;
                    deleteQuizInstanceModal.classList.add('show');
                }
            };

            const handleRenameQuiz = () => {
                const newName = renameQuizNameInstanceInput.value.trim();
                const project = appState.projects.find(p => p.id === activeProjectId);
                const quiz = project?.quizzes.find(q => q.id === quizToEditId);
                if (newName && quiz) {
                    quiz.name = newName;
                    saveState();
                    showEditQuizzesModal(); // Refresh the list
                    populateQuizSelect(project); // Refresh the main dropdown
                }
                renameQuizInstanceModal.classList.remove('show');
                quizToEditId = null;
            };

            const handleDeleteQuiz = () => {
                const project = appState.projects.find(p => p.id === activeProjectId);
                if (project && quizToEditId) {
                    project.quizzes = project.quizzes.filter(q => q.id !== quizToEditId);
                    delete project.mastery[quizToEditId];
                    saveState();
                    showEditQuizzesModal(); // Refresh the list
                    populateQuizSelect(project); // Refresh the main dropdown
                }
                deleteQuizInstanceModal.classList.remove('show');
                quizToEditId = null;
            };


            // --- Event Listeners ---
            hamburgerButton.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);
            newProjectButton.addEventListener('click', showNewProjectModal);
            getStartedButton.addEventListener('click', showNewProjectModal);
            modalCreateProjectButton.addEventListener('click', handleCreateProject);
            modalCancelProjectButton.addEventListener('click', closeNewProjectModal);
            newProjectModal.addEventListener('click', (e) => { if (e.target === newProjectModal) closeNewProjectModal(); });
            newProjectNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleCreateProject(); });

            modalSaveRenameButton.addEventListener('click', handleRenameProject);
            modalCancelRenameButton.addEventListener('click', closeRenameProjectModal);
            renameProjectModal.addEventListener('click', (e) => { if (e.target === renameProjectModal) closeRenameProjectModal(); });
            renameProjectNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleRenameProject(); });
            
            generateNewQuizBtn.addEventListener('click', () => {
                resetUploadUI();
                promptText.value = '';
                switchScreen('generate');
            });
            backToProjectStartBtn.addEventListener('click', () => setActiveProject(activeProjectId));
            generateQuizButton.addEventListener('click', handleGenerateQuiz);

            startSelectedQuizButton.addEventListener('click', () => {
                const selectedQuizId = quizSelect.value;
                const project = appState.projects.find(p => p.id === activeProjectId);
                if (project) {
                    const quizToStart = project.quizzes.find(q => q.id === selectedQuizId);
                    if (quizToStart) startQuiz(quizToStart);
                }
            });

            fileDropArea.addEventListener('click', () => fileUpload.click());
            fileUpload.addEventListener('change', (e) => handleFileSelect(e.target.files));
            fileDropArea.addEventListener('dragover', (e) => { e.preventDefault(); fileDropArea.classList.add('dragover'); });
            fileDropArea.addEventListener('dragleave', () => fileDropArea.classList.remove('dragover'));
            fileDropArea.addEventListener('drop', (e) => { e.preventDefault(); fileDropArea.classList.remove('dragover'); handleFileSelect(e.dataTransfer.files); });

            modalCreateQuizButton.addEventListener('click', handleCreateQuiz);
            modalCancelQuizButton.addEventListener('click', closeNameQuizModal);
            nameQuizModal.addEventListener('click', (e) => { if (e.target === nameQuizModal) closeNameQuizModal(); });
            newQuizNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleCreateQuiz(); });

            interruptButton.addEventListener('click', () => interruptModal.classList.add('show'));
            modalCancelInterrupt.addEventListener('click', () => interruptModal.classList.remove('show'));
            modalConfirmInterrupt.addEventListener('click', () => {
                interruptModal.classList.remove('show');
                setActiveProject(activeProjectId);
            });

            modalConfirmDelete.addEventListener('click', handleDeleteProject);
            modalCancelDelete.addEventListener('click', closeDeleteProjectModal);

            nextButton.addEventListener('click', () => { playSound('click'); currentQuiz.currentIndex++; loadQuestion(); });
            toggleExplanationButton.addEventListener('click', () => { 
                explanationContentElement.classList.toggle('show'); 
                toggleExplanationButton.textContent = explanationContentElement.classList.contains('show') ? '解説▲' : '解説▼'; 
            });
            
            restartQuizButton.addEventListener('click', () => {
                const project = appState.projects.find(p => p.id === activeProjectId);
                if (project && currentQuiz) {
                    const originalQuiz = project.quizzes.find(q => q.id === currentQuiz.id);
                    if (originalQuiz) {
                        startQuiz(originalQuiz);
                    }
                }
            });

            backToProjectButton.addEventListener('click', () => setActiveProject(activeProjectId));
            
            projectSettingsButton.addEventListener('click', () => settingsScreen.classList.add('active'));
            backToProjectFromSettings.addEventListener('click', () => settingsScreen.classList.remove('active'));
            settingsScreen.addEventListener('click', (e) => {
                if (e.target === settingsScreen) {
                    settingsScreen.classList.remove('active');
                }
            });
            
            // --- Settings Listeners ---
            darkModeToggle.addEventListener('change', (e) => setDarkMode(e.target.checked));
            
            themeColorCircles.forEach(circle => {
                circle.addEventListener('click', () => {
                    themeColorCircles.forEach(c => c.classList.remove('selected'));
                    circle.classList.add('selected');
                    setThemeColor(circle.dataset.theme);
                });
            });
            
            soundVolumeSlider.addEventListener('input', (e) => updateVolume(e.target.value));
            soundVolumeSlider.addEventListener('change', saveState);
            
            questionCountSelect.addEventListener('change', (e) => {
                appState.settings.questionCount = parseInt(e.target.value, 10);
                saveState();
            });

            shuffleQuestionsToggle.addEventListener('change', (e) => {
                appState.settings.shuffleQuestions = e.target.checked;
                saveState();
            });

            showProgressToggle.addEventListener('change', (e) => {
                appState.settings.showProgress = e.target.checked;
                saveState();
            });

            masteryModeToggle.addEventListener('change', (e) => {
                appState.settings.masteryMode = e.target.checked;
                saveState();
            });

            // --- Edit Quiz Listeners ---
            editQuizzesButton.addEventListener('click', () => {
                settingsScreen.classList.remove('active');
                showEditQuizzesModal();
            });
            closeEditQuizModalButton.addEventListener('click', () => editQuizzesModal.classList.remove('show'));
            editQuizList.addEventListener('click', handleQuizEditActions);

            renameQuizInstanceModal.querySelector('.save').addEventListener('click', handleRenameQuiz);
            renameQuizInstanceModal.querySelector('.cancel').addEventListener('click', () => renameQuizInstanceModal.classList.remove('show'));
            renameQuizNameInstanceInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleRenameQuiz(); });

            deleteQuizInstanceModal.querySelector('.delete').addEventListener('click', handleDeleteQuiz);
            deleteQuizInstanceModal.querySelector('.cancel').addEventListener('click', () => deleteQuizInstanceModal.classList.remove('show'));

            // --- ToS & PWA Listeners ---
            tosAgreeButton.addEventListener('click', () => {
                localStorage.setItem('qube_tos_agreed', 'true');
                tosModal.classList.remove('show');
            });

            closeAddToHomeScreen.addEventListener('click', () => {
                localStorage.setItem('qube_add_to_home_screen_dismissed', 'true');
                addToHomeScreenPopup.style.display = 'none';
            });
            
            // --- Initialization ---
            const init = () => {
                const splashScreen = document.getElementById('splashScreen');
                const splashLogo = document.getElementById('splashLogo');
                splashLogo.onerror = () => {
                    splashLogo.style.display = 'none';
                    splashLogo.nextElementSibling.style.display = 'block';
                };

                loadState();
                
                // Apply loaded settings to UI
                const { settings } = appState;
                setDarkMode(settings.darkMode);
                darkModeToggle.checked = settings.darkMode;
                
                themeColorCircles.forEach(c => c.classList.remove('selected'));
                document.querySelector(`.color-circle[data-theme="${settings.themeColor}"]`)?.classList.add('selected');
                
                soundVolumeSlider.value = settings.soundVolume;
                updateVolume(settings.soundVolume); // Set initial volume for Tone.js

                questionCountSelect.value = settings.questionCount;
                shuffleQuestionsToggle.checked = settings.shuffleQuestions;
                showProgressToggle.checked = settings.showProgress;
                masteryModeToggle.checked = settings.masteryMode;

                // Restore last session
                const lastActiveProjectId = localStorage.getItem('qube_lastActiveProjectId');
                const projectExists = appState.projects.some(p => p.id === lastActiveProjectId);
                if (lastActiveProjectId && projectExists) {
                    setActiveProject(lastActiveProjectId);
                } else if (appState.projects.length > 0) {
                    setActiveProject(appState.projects[0].id);
                }
                else {
                    switchScreen('welcome');
                }
                renderProjectList();
                
                // Hide splash screen after a delay
                setTimeout(() => {
                    splashScreen.classList.add('hidden');
                    splashScreen.addEventListener('transitionend', () => {
                        splashScreen.style.display = 'none';
                    }, { once: true });
                }, 1500);

                // Check for ToS agreement
                if (!localStorage.getItem('qube_tos_agreed')) {
                    tosModal.classList.add('show');
                }

                // Check for PWA prompt on iOS
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                const isInStandaloneMode = window.matchMedia('(display-mode: standalone)').matches;
                if (isIOS && !isInStandaloneMode && !localStorage.getItem('qube_add_to_home_screen_dismissed')) {
                    const iosShareIconContainer = document.getElementById('iosShareIconContainer');
                    // Correct SVG for iOS Share Icon (Upload arrow from a box)
                    iosShareIconContainer.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L11 6.414V13a1 1 0 11-2 0V6.414L7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zM4 14a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1z" /></svg>`;
                    setTimeout(() => {
                        addToHomeScreenPopup.style.display = 'block';
                    }, 5000);
                }
            };

            init();
        });
    </script>
</body>
</html>
