<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qube - AI Quiz Generator</title>
    <!-- PWA settings -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Qube">
    <meta name="theme-color" content="#f0f9ff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- PDF.js for PDF processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <style>
        /* --- Base Variables from Qube --- */
        :root {
            --bg-primary: #f0f9ff;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e0f2fe;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent-primary: #0ea5e9;
            --accent-primary-hover: #0284c7;
            --accent-primary-shadow: rgba(14, 165, 233, 0.3);
            --border-color: #cbd5e1;
            --modal-bg: rgba(0, 0, 0, 0.5);
            
            /* --- Integrated Variables from BEI --- */
            --button-bg-default: #f1f5f9;
            --button-text-default: #334155;
            --button-border-default: #cbd5e1;
            --progress-bar-bg: var(--accent-primary);
            --feedback-bg: #f8fafc;
            --feedback-border: #e2e8f0;
            --correct-feedback-text: #15803d;
            --correct-feedback-border: #22c55e;
            --incorrect-feedback-text: #b91c1c;
            --incorrect-feedback-border: #ef4444;
            --correct-option-bg: #dcfce7;
            --incorrect-option-bg: #fee2e2;
            --score-color: #0c4a6e;
            --score-comment-color: #0369a1;
            --themed-text-color: #0c4a6e;
        }

        body.dark-mode {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #0c4a6e;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --accent-primary: #38bdf8;
            --accent-primary-hover: #0ea5e9;
            --accent-primary-shadow: rgba(56, 189, 248, 0.3);
            --border-color: #475569;
            --modal-bg: rgba(0, 0, 0, 0.7);

            /* --- Integrated Dark Variables from BEI --- */
            --button-bg-default: #334155;
            --button-text-default: #e2e8f0;
            --button-border-default: #475569;
            --progress-bar-bg: var(--accent-primary);
            --feedback-bg: #334155;
            --feedback-border: #475569;
            --correct-feedback-text: #a7f3d0;
            --correct-feedback-border: #4ade80;
            --incorrect-feedback-text: #fecaca;
            --incorrect-feedback-border: #f87171;
            --correct-option-bg: #14532d;
            --incorrect-option-bg: #7f1d1d;
            --score-color: #e0f2fe;
            --score-comment-color: #7dd3fc;
            --themed-text-color: #e0f2fe;
        }
        
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- Qube Base Layout --- */
        .main-container { display: flex; height: 100vh; width: 100%; overflow: hidden; }
        #sidebar { width: 280px; background-color: var(--bg-secondary); border-right: 1px solid var(--border-color); padding: 20px; display: flex; flex-direction: column; transition: transform 0.3s ease, box-shadow 0.3s ease; transform: translateX(-100%); position: fixed; top: 0; left: 0; height: 100%; z-index: 1000; }
        #sidebar.open { transform: translateX(0); box-shadow: 0 0 40px rgba(0,0,0,0.2); }
        body.sidebar-open-desktop #mainContent { margin-left: 280px; }
        #mainContent { flex-grow: 1; padding: 20px; overflow-y: auto; transition: margin-left 0.3s ease; }
        @media (max-width: 767px) { 
            body.sidebar-open-desktop #mainContent { margin-left: 0; }
        }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
        .sidebar-overlay.active { display: block; }
        .screen { display: none; flex-direction: column; }
        .screen.active { display: flex; }

        /* --- Qube Buttons & Forms --- */
        .btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; border: none; }
        .btn-primary { background-color: var(--accent-primary); color: white; box-shadow: 0 4px 12px var(--accent-primary-shadow); }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-primary-hover); transform: translateY(-2px); }
        .btn-lg { padding: 15px 30px; font-size: 1.1rem; }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; }
        .form-group textarea { min-height: 120px; resize: vertical; }
        #fillInBlankInput { font-size: 1.2rem; padding: 16px; text-align: center; }
        
        /* --- Qube Modal --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-bg); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--bg-secondary); padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); max-width: 400px; width: 90%; transform: translateY(-20px) scale(0.95); transition: transform 0.3s ease, background-color 0.3s ease; }
        .modal.show .modal-content { transform: translateY(0) scale(1); }
        .modal-title { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 20px; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
        .modal-button { padding: 10px 25px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; border: none; }
        .modal-button.create { background-color: var(--accent-primary); color: white; }
        .modal-button.create:hover { background-color: var(--accent-primary-hover); }
        .modal-button.cancel { background-color: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); }
        .modal-button.cancel:hover { background-color: var(--border-color); }

        /* --- Project Start Screen --- */
        .start-screen-container { max-width: 600px; margin: auto; text-align: center; }
        .start-screen-container h2 { color: var(--themed-text-color); }
        .start-screen-container .form-group select {
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2020%2020%22%20fill%3D%22%2364748b%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20d%3D%22M5.293%207.293a1%201%200%20011.414%200L10%2010.586l3.293-3.293a1%201%200%20111.414%201.414l-4%204a1%201%200%2001-1.414%200l-4-4a1%201%200%20010-1.414z%22%20clip-rule%3D%22evenodd%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2em;
        }
        #fileDropArea { border-color: var(--border-color); }
        #fileDropArea.dragover { border-color: var(--accent-primary); background-color: var(--bg-tertiary); }
        #filePreviewContainer { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 1rem; }
        .file-preview-item { position: relative; }
        .file-preview-item img { max-height: 100px; border-radius: 8px; }
        .file-preview-item .file-name { font-size: 0.8rem; color: var(--text-secondary); max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .remove-file-btn { position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; border: 2px solid var(--bg-secondary); }
        .divider { text-align: center; margin: 1.5rem 0; color: var(--text-secondary); display: flex; align-items: center; gap: 1rem; }
        .divider::before, .divider::after { content: ''; height: 1px; background-color: var(--border-color); flex-grow: 1; }

        /* --- Integrated Quiz Screen Styles --- */
        .quiz-container { max-width: 800px; margin-left: auto; margin-right: auto; }
        .quiz-header { position: relative; display: flex; align-items: center; justify-content: center; padding-bottom: 1rem; gap: 1rem; }
        .quiz-header .main-title { font-size: 1.5rem; font-weight: 700; margin: 0; color: var(--themed-text-color); }
        #interruptButton { position: absolute; top: 50%; right: 0; transform: translateY(-50%); padding: 8px 15px; font-size: 0.8rem; background-color: #ef4444; color:white; }
        .progress-container { width: 100%; background-color: #e2e8f0; border-radius: 10px; height: 15px; margin-top: 10px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        .progress-bar { height: 100%; width: 0%; background-color: var(--progress-bar-bg); border-radius: 10px; transition: width 0.3s ease-in-out, background-color 0.3s ease; }
        .progress-text { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-top: 10px; transition: color 0.3s ease; text-align: center; }
        .question-area { min-height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: background-color 0.3s ease; text-align: left; margin-top: 1.5rem;}
        #questionImage { max-height: 200px; border-radius: 8px; margin-bottom: 1rem; }
        .question-text { font-size: 1.25rem; font-weight: 500; color: var(--themed-text-color); margin-bottom: 10px; transition: color 0.3s ease; width: 100%; text-align:center; }
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 15px; }
        .option-button { background-color: var(--button-bg-default); color: var(--button-text-default); padding: 14px 20px; border-radius: 12px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; border: 2px solid var(--button-border-default); text-align: left; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08); line-height: 1.5; }
        .option-button:hover:not(:disabled) { background-color: var(--border-color); transform: translateY(-3px) scale(1.01); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.12); }
        .option-button.correct { background-color: var(--correct-option-bg); border-color: var(--correct-feedback-border); color: var(--correct-feedback-text); }
        .option-button.incorrect { background-color: var(--incorrect-option-bg); border-color: var(--incorrect-feedback-border); color: var(--incorrect-feedback-text); }
        .option-button.selected { border-color: var(--accent-primary); background-color: var(--bg-tertiary); }
        .option-button:disabled { cursor: not-allowed; }
        .sorting-item.dragging { opacity: 0.5; }
        .sorting-container { display: flex; flex-direction: column; gap: 1rem; }
        .sorting-box { display: flex; flex-wrap: wrap; gap: 10px; padding: 1rem; border-radius: 12px; border: 2px dashed var(--border-color); min-height: 70px; }
        .feedback-message { margin-top: 1.5rem; font-size: 1rem; text-align: left; padding: 1rem 1.5rem; border-radius: 12px; background-color: var(--feedback-bg); border: 1px solid var(--feedback-border); box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); line-height: 1.5; transition: all 0.3s ease; }
        .feedback-message.correct-feedback { color: var(--correct-feedback-text); border-color: var(--correct-feedback-border); }
        .feedback-message.incorrect-feedback { color: var(--incorrect-feedback-text); border-color: var(--incorrect-feedback-border); }
        .feedback-header { display: flex; justify-content: space-between; align-items: center; gap: 15px; min-height: 24px; flex-wrap: wrap; }
        .feedback-result strong { font-size: 1.1rem; }
        .explanation-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding-top 0.4s ease-out, margin-top 0.4s ease-out; padding-top: 0; margin-top: 0; }
        .explanation-content.show { max-height: 200px; padding-top: 10px; margin-top: 10px; border-top: 1px solid var(--border-color); }
        .explanation-text { font-weight: 400; font-size: 0.95rem; }
        .toggle-explanation-button { background-color: var(--accent-primary); color: white; padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease; flex-shrink: 0; border: none; }
        .navigation-buttons { display: flex; justify-content: flex-end; margin-top: 20px; flex-wrap: wrap; gap: 10px; }
        
        /* --- Integrated Result Screen Styles --- */
        .result-container { text-align: center; max-width: 600px; margin: 2rem auto; }
        .score-area { font-size: 1.8rem; font-weight: 800; color: var(--score-color); margin-top: 25px; }
        .score-comment { font-size: 1.3rem; font-weight: 700; color: var(--score-comment-color); margin-top: 10px; }
        .confetti-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; pointer-events: none; z-index: 0; }
        .confetti { position: absolute; width: 10px; height: 10px; background-color: #f06; opacity: 1; }

        /* --- Integrated Settings Screen Styles --- */
        .settings-container { max-width: 700px; margin: 0 auto; }
        .settings-option { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--border-color); flex-wrap: nowrap; gap: 1rem;}
        .settings-option:last-child { border-bottom: none; }
        .settings-option-label { display: flex; flex-direction: column; align-items: flex-start; flex-grow: 1; min-width: 0; }
        .settings-option-label label { font-size: 1.1rem; color: var(--text-primary); font-weight: 600; }
        .settings-option-label p { font-size: 0.85rem; color: var(--text-secondary); margin: 4px 0 0 0; text-align: left; }
        .theme-colors { display: flex; gap: 10px; }
        .color-circle { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s ease; }
        .color-circle.selected { border-color: var(--accent-primary); }
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; flex-shrink: 0; margin-left: auto; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-primary); }
        input:checked + .slider:before { transform: translateX(26px); }

        @media (min-width: 640px) { 
            .options-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div id="confettiContainer" class="confetti-container"></div>
    <div class="main-container">
        <!-- Sidebar -->
        <aside id="sidebar">
            <h2 class="text-2xl font-bold mb-6" style="color: var(--accent-primary);">Qube</h2>
            <button id="newProjectButton" class="btn btn-primary w-full mb-6">新しいプロジェクトを作成</button>
            <h3 class="text-lg font-semibold mb-3 text-gray-500">プロジェクト一覧</h3>
            <div id="projectList" class="flex-grow overflow-y-auto">
                <p class="text-gray-400">まだプロジェクトがありません。</p>
            </div>
        </aside>
        <div id="sidebarOverlay" class="sidebar-overlay"></div>

        <!-- Main Content -->
        <main id="mainContent">
            <header class="flex items-center justify-between mb-8">
                <button id="hamburgerButton" class="p-2 rounded-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
                <h1 id="projectTitle" class="text-3xl font-bold text-center flex-grow" style="color: var(--text-primary);">プロジェクトへようこそ</h1>
                <button id="projectSettingsButton" class="p-2 rounded-md invisible">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
            </header>

            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="screen active text-center p-8 bg-white dark:bg-gray-800 rounded-lg shadow-lg">
                <h2 class="text-4xl font-bold mb-4" style="color: var(--accent-primary);">Qubeへようこそ！</h2>
                <p class="text-xl mb-8" style="color: var(--text-secondary);">AIの力で、あなたの学習を次のレベルへ。</p>
                <p class="mb-8" style="color: var(--text-primary);">左のメニューから「新しいプロジェクトを作成」して、<br>あなただけのオリジナルクイズ作りを始めましょう。</p>
                <button id="getStartedButton" class="btn btn-primary text-lg px-8 py-3">さっそく始める</button>
            </div>

            <!-- Project Start Screen (New) -->
            <div id="projectStartScreen" class="screen">
                <div class="start-screen-container">
                    <h2 class="text-3xl font-bold mb-6">学習を開始</h2>
                    <div class="form-group">
                        <label for="quizSelect" class="text-left">作成済みクイズから選ぶ</label>
                        <select id="quizSelect"></select>
                    </div>
                    <button id="startSelectedQuizButton" class="btn btn-primary btn-lg w-full">選択したクイズを開始</button>
                    <div class="divider">または</div>
                    <button id="generateNewQuizBtn" class="btn btn-lg w-full" style="background-color: var(--button-bg-default); color: var(--button-text-default); border: 1px solid var(--border-color);">新しいクイズをAIで生成</button>
                </div>
            </div>
            
            <!-- Quiz Generation Screen -->
            <div id="generationScreen" class="screen">
                <div class="max-w-3xl mx-auto w-full">
                    <button id="backToProjectStartBtn" class="btn mb-4 text-sm" style="background-color: transparent; color: var(--text-secondary); padding: 4px 8px;">← プロジェクトに戻る</button>
                    
                    <div class="form-group">
                         <label>ファイルをアップロード</label>
                         <div id="fileDropArea" class="w-full p-8 border-2 border-dashed rounded-lg text-center cursor-pointer hover:border-sky-500">
                             <p class="text-gray-500">ここにファイルをドラッグ＆ドロップ<br>またはクリックして選択</p>
                             <input type="file" class="hidden" id="fileUpload" accept=".txt,.md,.text,.pdf,image/*" multiple>
                         </div>
                         <div id="filePreviewContainer"></div>
                    </div>

                    <div class="divider">または</div>

                    <div class="form-group">
                        <label id="promptLabel" for="promptText">クイズにしたい内容を入力または貼り付け</label>
                        <textarea id="promptText" placeholder="例: 日本の首都は東京です。徳川家康は江戸幕府を開きました..."></textarea>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4 mt-8">
                        <div class="form-group">
                            <label for="genQuestionCount">生成する問題数</label>
                            <select id="genQuestionCount">
                                <option value="5">5問</option>
                                <option value="10">10問</option>
                                <option value="all">全て</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="questionType">問題形式</label>
                            <select id="questionType">
                                <option value="multiple_choice">選択肢</option>
                                <option value="fill_in_the_blank">記述式</option>
                                <option value="sorting">並び替え</option>
                                <option value="multiple_select">複数選択</option>
                            </select>
                        </div>
                    </div>
                     <div class="form-group flex items-center gap-2">
                        <input type="checkbox" id="autoGenreCheckbox" class="w-4 h-4">
                        <label for="autoGenreCheckbox" class="mb-0">AIによる自動ジャンル分け</label>
                    </div>
                    <button id="generateQuizButton" class="btn btn-primary w-full mt-4 py-3 text-lg flex items-center justify-center">
                        <span class="button-text">クイズを生成する</span>
                        <svg class="spinner hidden animate-spin ml-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                    <p id="generationError" class="text-red-500 text-sm mt-2 text-center hidden"></p>
                </div>
            </div>

            <!-- Quiz Screen (New UI) -->
            <div id="quizScreen" class="screen">
                <div class="quiz-container">
                    <div class="quiz-header">
                        <h1 id="quizTitle" class="main-title">クイズ</h1>
                        <button id="interruptButton" class="btn">中断</button>
                    </div>
                    <div class="progress-container">
                        <div id="progressBar" class="progress-bar"></div>
                    </div>
                    <div id="progressText" class="progress-text"></div>
                    <div class="question-area">
                        <img id="questionImage" class="hidden"/>
                        <div id="questionText" class="question-text"></div>
                    </div>
                    <div id="optionsGrid" class="options-grid"></div>
                    <div id="submissionArea" class="mt-4 text-right"></div>
                    <div id="feedbackMessage" class="feedback-message" style="display: none;">
                        <div class="feedback-header">
                            <div id="feedbackResult"></div>
                            <button id="toggleExplanationButton" class="toggle-explanation-button hidden">解説▼</button>
                        </div>
                        <div id="explanationContent" class="explanation-content">
                            <div class="explanation-text"></div>
                        </div>
                    </div>
                    <div class="navigation-buttons">
                        <button id="nextButton" class="btn btn-primary">次の問題</button>
                    </div>
                </div>
            </div>

            <!-- Result Screen (New UI) -->
            <div id="resultScreen" class="screen">
                <div class="result-container">
                    <h2 class="text-2xl font-bold mb-4" style="color: var(--score-color);">クイズ結果</h2>
                    <div id="finalScore" class="score-area"></div>
                    <div id="scoreComment" class="score-comment"></div>
                    <div class="mt-6 flex flex-col items-center gap-3">
                        <button id="restartQuizButton" class="btn btn-primary w-full max-w-xs">もう一度挑戦</button>
                        <button id="backToProjectButton" class="btn w-full max-w-xs" style="background-color: var(--button-bg-default); color: var(--button-text-default); border: 1px solid var(--border-color);">プロジェクトに戻る</button>
                    </div>
                </div>
            </div>

            <!-- Settings Screen (New UI) -->
            <div id="settingsScreen" class="screen">
                 <div class="settings-container">
                    <h2 class="text-2xl font-bold mb-4 text-center">設定</h2>
                    <div class="settings-option">
                        <div class="settings-option-label">
                            <label for="darkModeToggle">ダークモード</label>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="darkModeToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="settings-option">
                        <div class="settings-option-label">
                            <label>テーマカラー</label>
                        </div>
                        <div class="theme-colors">
                            <div class="color-circle" data-theme="default" style="background-color: #0ea5e9;"></div>
                            <div class="color-circle" data-theme="red" style="background-color: #ef4444;"></div>
                            <div class="color-circle" data-theme="green" style="background-color: #10b981;"></div>
                            <div class="color-circle" data-theme="indigo" style="background-color: #6366f1;"></div>
                        </div>
                    </div>
                    <div class="settings-option">
                        <div class="settings-option-label">
                            <label for="enableSoundToggle">効果音</label>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="enableSoundToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                     <div class="settings-option">
                        <div class="settings-option-label">
                            <label for="questionCountSelect">問題数</label>
                        </div>
                        <select id="questionCountSelect" class="w-24 p-2 border rounded">
                            <option value="5">5問</option>
                            <option value="10">10問</option>
                            <option value="15">15問</option>
                            <option value="20">20問</option>
                        </select>
                    </div>
                    <div class="settings-option">
                        <div class="settings-option-label">
                            <label for="showProgressToggle">進捗状況を表示</label>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="showProgressToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="settings-option">
                        <div class="settings-option-label">
                            <label for="masteryModeToggle">習得モード</label>
                            <p>2回連続で正解するまで「習得済み」になりません。</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="masteryModeToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                     <button id="backToProjectFromSettings" class="btn btn-primary mt-8 w-full">プロジェクトに戻る</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="newProjectModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">新しいプロジェクトの作成</h2>
            <div class="form-group">
                <label for="newProjectNameInput">プロジェクト名</label>
                <input type="text" id="newProjectNameInput" placeholder="例: 歴史クイズ">
            </div>
            <div class="modal-buttons">
                <button id="modalCancelProjectButton" class="modal-button cancel">キャンセル</button>
                <button id="modalCreateProjectButton" class="modal-button create">作成</button>
            </div>
        </div>
    </div>
    <div id="nameQuizModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">クイズに名前を付ける</h2>
            <div class="form-group">
                <label for="newQuizNameInput">クイズ名</label>
                <input type="text" id="newQuizNameInput" placeholder="例: 江戸時代クイズ">
            </div>
            <div class="modal-buttons">
                <button id="modalCancelQuizButton" class="modal-button cancel">キャンセル</button>
                <button id="modalCreateQuizButton" class="modal-button create">保存</button>
            </div>
        </div>
    </div>
     <div id="interruptModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">クイズを中断</h2>
            <p>本当にクイズを中断しますか？現在の進捗は保存されません。</p>
            <div class="modal-buttons">
                <button id="modalCancelInterrupt" class="modal-button cancel">キャンセル</button>
                <button id="modalConfirmInterrupt" class="modal-button create" style="background-color: #ef4444;">中断する</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const sidebar = document.getElementById('sidebar');
            const hamburgerButton = document.getElementById('hamburgerButton');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const newProjectButton = document.getElementById('newProjectButton');
            const getStartedButton = document.getElementById('getStartedButton');
            const projectTitle = document.getElementById('projectTitle');
            const projectSettingsButton = document.getElementById('projectSettingsButton');
            const projectListEl = document.getElementById('projectList');
            
            const screens = {
                welcome: document.getElementById('welcomeScreen'),
                projectStart: document.getElementById('projectStartScreen'),
                generate: document.getElementById('generationScreen'),
                quiz: document.getElementById('quizScreen'),
                result: document.getElementById('resultScreen'),
                settings: document.getElementById('settingsScreen'),
            };

            const generateQuizButton = document.getElementById('generateQuizButton');
            const generateNewQuizBtn = document.getElementById('generateNewQuizBtn');
            const backToProjectStartBtn = document.getElementById('backToProjectStartBtn');
            const promptText = document.getElementById('promptText');
            const promptLabel = document.getElementById('promptLabel');
            const aiMode = document.getElementById('aiMode');
            const questionType = document.getElementById('questionType');
            const genQuestionCount = document.getElementById('genQuestionCount');
            const autoGenreCheckbox = document.getElementById('autoGenreCheckbox');
            const generationError = document.getElementById('generationError');
            const quizSelect = document.getElementById('quizSelect');
            const startSelectedQuizButton = document.getElementById('startSelectedQuizButton');
            const fileDropArea = document.getElementById('fileDropArea');
            const fileUpload = document.getElementById('fileUpload');
            const filePreviewContainer = document.getElementById('filePreviewContainer');

            const newProjectModal = document.getElementById('newProjectModal');
            const newProjectNameInput = document.getElementById('newProjectNameInput');
            const modalCreateProjectButton = document.getElementById('modalCreateProjectButton');
            const modalCancelProjectButton = document.getElementById('modalCancelProjectButton');
            
            const nameQuizModal = document.getElementById('nameQuizModal');
            const newQuizNameInput = document.getElementById('newQuizNameInput');
            const modalCreateQuizButton = document.getElementById('modalCreateQuizButton');
            const modalCancelQuizButton = document.getElementById('modalCancelQuizButton');

            const interruptModal = document.getElementById('interruptModal');
            const modalConfirmInterrupt = document.getElementById('modalConfirmInterrupt');
            const modalCancelInterrupt = document.getElementById('modalCancelInterrupt');

            const quizTitle = document.getElementById('quizTitle');
            const questionImage = document.getElementById('questionImage');
            const questionTextElement = document.getElementById('questionText');
            const optionsGridElement = document.getElementById('optionsGrid');
            const submissionArea = document.getElementById('submissionArea');
            const feedbackMessageElement = document.getElementById('feedbackMessage');
            const feedbackResultElement = document.getElementById('feedbackResult');
            const explanationContentElement = document.getElementById('explanationContent');
            const explanationTextElement = explanationContentElement.querySelector('.explanation-text');
            const toggleExplanationButton = document.getElementById('toggleExplanationButton');
            const nextButton = document.getElementById('nextButton');
            const interruptButton = document.getElementById('interruptButton');
            const progressBarContainer = document.querySelector('.progress-container');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const finalScore = document.getElementById('finalScore');
            const scoreComment = document.getElementById('scoreComment');
            const confettiContainer = document.getElementById('confettiContainer');
            const restartQuizButton = document.getElementById('restartQuizButton');
            const backToProjectButton = document.getElementById('backToProjectButton');
            
            // Settings DOM
            const darkModeToggle = document.getElementById('darkModeToggle');
            const themeColorCircles = document.querySelectorAll('.color-circle');
            const enableSoundToggle = document.getElementById('enableSoundToggle');
            const questionCountSelect = document.getElementById('questionCountSelect');
            const showProgressToggle = document.getElementById('showProgressToggle');
            const masteryModeToggle = document.getElementById('masteryModeToggle');
            const backToProjectFromSettings = document.getElementById('backToProjectFromSettings');

            // --- App State ---
            let projects = [];
            let activeProjectId = null;
            let currentQuiz = null; 
            let confettiAnimationId;
            let tempGeneratedQuestions = null;
            let uploadedFiles = []; // Array of {name, type, content}
            
            // Settings State
            let enableSound = true;
            let questionCount = 5;
            let showProgress = true;
            let masteryMode = false;


            // --- Sound Effects ---
            const sounds = {
                correct: new Tone.Synth({ volume: -12, oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination(),
                incorrect: new Tone.FMSynth({ volume: -8, harmonicity: 1.5, modulationIndex: 10, oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.01, release: 0.1 } }).toDestination(),
                click: new Tone.Synth({ volume: -15, oscillator: { type: 'triangle' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.1 } }).toDestination(),
                fanfare: new Tone.PolySynth(Tone.Synth, { volume: -10 }).toDestination(),
            };
            async function playSound(type) {
                if (!enableSound) return;
                if (Tone.context.state !== 'running') await Tone.start();
                const now = Tone.now();
                try {
                    switch (type) {
                        case 'correct': sounds.correct.triggerAttackRelease("C5", "8n", now); break;
                        case 'incorrect': sounds.incorrect.triggerAttackRelease("A2", "8n", now); break;
                        case 'click': sounds.click.triggerAttackRelease("C6", "16n", now); break;
                        case 'fanfare':
                            ["C5", "E5", "G5", "C6"].forEach((note, i) => {
                                sounds.fanfare.triggerAttackRelease(note, "8n", now + i * 0.15);
                            });
                            break;
                    }
                } catch (error) { console.error("Sound playback failed:", error); }
            }
            
            // --- Data Persistence ---
            const saveProjects = () => {
                localStorage.setItem('qube_projects', JSON.stringify(projects));
            };
            const loadProjects = () => {
                projects = JSON.parse(localStorage.getItem('qube_projects')) || [];
            };

            // --- UI & State Management Functions ---
            const switchScreen = (screenName) => {
                Object.values(screens).forEach(s => s.classList.remove('active'));
                if (screens[screenName]) screens[screenName].classList.add('active');
            };

            const toggleSidebar = () => {
                const isOpen = sidebar.classList.toggle('open');
                if (window.innerWidth < 768) {
                    sidebarOverlay.classList.toggle('active', isOpen);
                } else {
                    document.body.classList.toggle('sidebar-open-desktop', isOpen);
                }
            };
            
            const showNewProjectModal = () => {
                newProjectNameInput.value = `プロジェクト ${projects.length + 1}`;
                newProjectModal.classList.add('show');
                newProjectNameInput.focus();
                newProjectNameInput.select();
            };

            const closeNewProjectModal = () => newProjectModal.classList.remove('show');
            
            const handleCreateProject = () => {
                const projectName = newProjectNameInput.value.trim();
                if (!projectName) {
                    newProjectNameInput.focus();
                    return;
                }
                const newProject = { 
                    id: `proj_${Date.now()}`, 
                    name: projectName, 
                    quizzes: []
                };
                projects.unshift(newProject); // Add to the top
                saveProjects();
                renderProjectList();
                activeProjectId = newProject.id;
                projectTitle.textContent = newProject.name;
                projectSettingsButton.classList.remove('invisible');
                closeNewProjectModal();
                resetUploadUI();
                promptText.value = '';
                switchScreen('generate'); 
                if(window.innerWidth < 768 && sidebar.classList.contains('open')) toggleSidebar();
            };

            const renderProjectList = () => {
                projectListEl.innerHTML = '';
                if (projects.length === 0) {
                    projectListEl.innerHTML = '<p class="text-gray-400">まだプロジェクトがありません。</p>';
                    return;
                }
                projects.forEach(p => {
                    const projectEl = document.createElement('div');
                    projectEl.textContent = p.name;
                    projectEl.className = `p-2 rounded-md cursor-pointer hover:bg-sky-100 dark:hover:bg-sky-800 ${p.id === activeProjectId ? 'bg-sky-100 dark:bg-sky-800 font-bold' : ''}`;
                    projectEl.dataset.projectId = p.id;
                    projectEl.addEventListener('click', () => {
                        setActiveProject(p.id);
                        if(window.innerWidth < 768) toggleSidebar();
                    });
                    projectListEl.appendChild(projectEl);
                });
            };

            const setActiveProject = (projectId) => {
                activeProjectId = projectId;
                resetUploadUI();
                promptText.value = '';
                const project = projects.find(p => p.id === projectId);
                if (project) {
                    projectTitle.textContent = project.name;
                    projectSettingsButton.classList.remove('invisible');
                    if (project.quizzes.length === 0) {
                        switchScreen('generate'); 
                    } else {
                        populateQuizSelect(project);
                        switchScreen('projectStart');
                    }
                }
                renderProjectList();
            };

            const populateQuizSelect = (project) => {
                quizSelect.innerHTML = '';
                if (project.quizzes.length === 0) {
                    const option = document.createElement('option');
                    option.textContent = '利用可能なクイズがありません';
                    option.disabled = true;
                    quizSelect.appendChild(option);
                    startSelectedQuizButton.disabled = true;
                } else {
                    project.quizzes.forEach(quiz => {
                        const option = document.createElement('option');
                        option.value = quiz.id;
                        option.textContent = quiz.name;
                        quizSelect.appendChild(option);
                    });
                    startSelectedQuizButton.disabled = false;
                }
            };
            
            // --- Quiz Generation (Qube Core) ---
            const handleGenerateQuiz = async () => {
                const buttonText = generateQuizButton.querySelector('.button-text');
                const spinner = generateQuizButton.querySelector('.spinner');

                if (promptText.value.trim() === '' && uploadedFiles.length === 0) {
                    generationError.textContent = 'クイズの元になる内容を入力またはアップロードしてください。';
                    generationError.classList.remove('hidden');
                    return;
                }
                generationError.classList.add('hidden');

                buttonText.textContent = '生成中...';
                spinner.classList.remove('hidden');
                generateQuizButton.disabled = true;

                try {
                    const isAutoGenre = autoGenreCheckbox.checked;
                    const selectedType = questionType.value;
                    const numQuestions = genQuestionCount.value === 'all' ? '可能な限り多く' : `${genQuestionCount.value}問`;
                    let modelPrompt = `以下の情報に基づいて、高品質な${questionType.options[questionType.selectedIndex].text}形式のクイズを${numQuestions}作成してください。`;
                    
                    if (selectedType === 'fill_in_the_blank') {
                        modelPrompt += `答え(answer)は、単語や短い語句だけにしてください。文末の句点(。)や「です」「ます」を含めないでください。`;
                    }
                    if (uploadedFiles.some(f => f.type === 'image')) {
                        modelPrompt += `アップロードされた画像に直接関連する問題を作成する場合、その問題オブジェクトに "image_source": true というプロパティを追加してください。`;
                    }

                    if (promptText.value.trim()) {
                        modelPrompt += `\nユーザーからの追加指示: 「${promptText.value}」`;
                    }
                    
                    const payload = {
                        contents: [{ role: "user", parts: [] }],
                        generationConfig: { responseMimeType: "application/json" }
                    };
                    
                    let itemSchema = {
                        type: "OBJECT",
                        properties: {
                            question: { type: "STRING" },
                            explanation: { type: "STRING" },
                            image_source: { type: "BOOLEAN", optional: true }
                        },
                        required: ["question", "explanation"]
                    };

                    switch(selectedType) {
                        case 'fill_in_the_blank': itemSchema.properties.answer = { type: "STRING" }; itemSchema.required.push("answer"); break;
                        case 'sorting': itemSchema.properties.items = { type: "ARRAY", items: { type: "STRING" } }; itemSchema.required.push("items"); break;
                        case 'multiple_select':
                            itemSchema.properties.options = { type: "ARRAY", items: { type: "STRING" } };
                            itemSchema.properties.answer = { type: "ARRAY", items: { type: "STRING" } };
                            itemSchema.required.push("options", "answer");
                            break;
                        default:
                            itemSchema.properties.options = { type: "ARRAY", items: { type: "STRING" } };
                            itemSchema.properties.answer = { type: "STRING" };
                            itemSchema.required.push("options", "answer");
                            break;
                    }

                    if (isAutoGenre) {
                        modelPrompt = `提供された情報を分析し、内容を複数のジャンルやトピックに分類してください。その後、各ジャンルごとに、指定された形式（${questionType.options[questionType.selectedIndex].text}）でクイズを${numQuestions}作成してください。` + modelPrompt;
                        payload.generationConfig.responseSchema = {
                            type: "OBJECT",
                            properties: {
                                "genres": {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            "genre_name": { type: "STRING" },
                                            "quizzes": { type: "ARRAY", items: itemSchema }
                                        },
                                        required: ["genre_name", "quizzes"]
                                    }
                                }
                            }
                        };
                    } else {
                        payload.generationConfig.responseSchema = {
                            type: "OBJECT",
                            properties: { "quizzes": { "type": "ARRAY", "items": itemSchema } }
                        };
                    }


                    payload.contents[0].parts.push({ text: modelPrompt });
                    
                    let textContent = '';
                    uploadedFiles.forEach(file => {
                        if (file.type === 'image') {
                            const mimeType = file.content.substring(5, file.content.indexOf(';'));
                            const base64Data = file.content.split(',')[1];
                            payload.contents[0].parts.push({ inlineData: { mimeType, data: base64Data } });
                        } else { // text or pdf
                            textContent += file.content + '\n\n';
                        }
                    });

                    if (textContent) {
                        payload.contents[0].parts[0].text += `\n\nクイズ生成の元になるテキスト:\n---\n${textContent}\n---`;
                    }
                    
                    const apiKey = ""; // Provided by the environment
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                    const result = await response.json();
                    
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const generatedData = JSON.parse(result.candidates[0].content.parts[0].text);
                        if (isAutoGenre) {
                            handleAutoGenreResponse(generatedData.genres, selectedType);
                        } else {
                            tempGeneratedQuestions = generatedData.quizzes.map(q => ({ ...q, type: selectedType }));
                            showNameQuizModal();
                        }
                    } else {
                        throw new Error("AIからの応答が無効です。");
                    }
                } catch (error) {
                    console.error("Quiz generation failed:", error);
                    generationError.textContent = `クイズの生成に失敗しました: ${error.message}`;
                    generationError.classList.remove('hidden');
                } finally {
                    buttonText.textContent = 'クイズを生成する';
                    spinner.classList.add('hidden');
                    generateQuizButton.disabled = false;
                }
            };
            
            const handleAutoGenreResponse = (genres, questionType) => {
                const project = projects.find(p => p.id === activeProjectId);
                if (!project || !genres) return;

                genres.forEach(genre => {
                    if (genre.quizzes && genre.quizzes.length > 0) {
                        const newQuiz = {
                            id: `quiz_${Date.now()}_${Math.random()}`,
                            name: genre.genre_name,
                            createdAt: new Date().toISOString(),
                            questions: genre.quizzes.map(q => ({ ...q, type: questionType })),
                            images: uploadedFiles.filter(f => f.type === 'image')
                        };
                        project.quizzes.push(newQuiz);
                    }
                });
                saveProjects();
                setActiveProject(activeProjectId);
            };

            const showNameQuizModal = () => {
                const project = projects.find(p => p.id === activeProjectId);
                if (!project) return;
                newQuizNameInput.value = `クイズ ${project.quizzes.length + 1}`;
                nameQuizModal.classList.add('show');
                newQuizNameInput.focus();
                newQuizNameInput.select();
            };
            
            const closeNameQuizModal = () => nameQuizModal.classList.remove('show');

            const handleCreateQuiz = () => {
                const quizName = newQuizNameInput.value.trim();
                if (!quizName) {
                    newQuizNameInput.focus();
                    return;
                }
                const project = projects.find(p => p.id === activeProjectId);
                if (project && tempGeneratedQuestions) {
                    const newQuiz = {
                        id: `quiz_${Date.now()}`,
                        name: quizName,
                        createdAt: new Date().toISOString(),
                        questions: tempGeneratedQuestions,
                        images: uploadedFiles.filter(f => f.type === 'image')
                    };
                    project.quizzes.push(newQuiz);
                    saveProjects();
                    tempGeneratedQuestions = null;
                    closeNameQuizModal();
                    setActiveProject(activeProjectId); 
                }
            };

            // --- Quiz Gameplay ---
            const startQuiz = (quiz) => {
                if (!quiz || !quiz.questions || quiz.questions.length === 0) return;
                currentQuiz = { ...quiz, currentIndex: 0, score: 0, answeredQuestions: new Set() };
                quizTitle.textContent = quiz.name;
                switchScreen('quiz');
                loadQuestion();
            };

            const loadQuestion = () => {
                if (currentQuiz.currentIndex >= currentQuiz.questions.length) {
                    showQuizResult();
                    return;
                }
                const question = currentQuiz.questions[currentQuiz.currentIndex];
                questionTextElement.innerHTML = question.question;
                optionsGridElement.innerHTML = '';
                submissionArea.innerHTML = '';
                questionImage.classList.add('hidden');

                if(question.image_source && currentQuiz.images && currentQuiz.images.length > 0) {
                    questionImage.src = currentQuiz.images[0].content; // Display the first image
                    questionImage.classList.remove('hidden');
                }

                switch(question.type) {
                    case 'multiple_choice':
                        question.options.forEach(option => {
                            const button = document.createElement('button');
                            button.innerHTML = option;
                            button.classList.add('option-button');
                            button.dataset.option = option;
                            button.addEventListener('click', () => submitAnswer(option));
                            optionsGridElement.appendChild(button);
                        });
                        break;
                    case 'multiple_select':
                        question.options.forEach(option => {
                            const button = document.createElement('button');
                            button.innerHTML = option;
                            button.classList.add('option-button');
                            button.dataset.option = option;
                            button.addEventListener('click', () => button.classList.toggle('selected'));
                            optionsGridElement.appendChild(button);
                        });
                        createSubmitButton();
                        break;
                    case 'fill_in_the_blank':
                        optionsGridElement.innerHTML = `<input type="text" id="fillInBlankInput" class="form-group" placeholder="答えを入力...">`;
                        createSubmitButton();
                        break;
                    case 'sorting':
                        optionsGridElement.innerHTML = `
                            <div class="sorting-container">
                                <div>
                                    <h4 class="font-semibold mb-2 text-center">解答欄</h4>
                                    <div id="sortingTarget" class="sorting-box"></div>
                                </div>
                                <div>
                                    <h4 class="font-semibold mb-2 text-center">選択肢</h4>
                                    <div id="sortingSource" class="sorting-box"></div>
                                </div>
                            </div>`;
                        const sourceContainer = document.getElementById('sortingSource');
                        const shuffledItems = [...question.items].sort(() => Math.random() - 0.5);
                        shuffledItems.forEach(item => {
                            const div = document.createElement('div');
                            div.innerHTML = item;
                            div.classList.add('option-button', 'sorting-item');
                            div.draggable = true;
                            sourceContainer.appendChild(div);
                        });
                        addDragAndDropListeners();
                        createSubmitButton();
                        break;
                    default: 
                         optionsGridElement.innerHTML = `<p class="text-red-500">不明な問題形式です。</p>`;
                         currentQuiz.answeredQuestions.add(question.question);
                        break;
                }

                feedbackMessageElement.style.display = 'none';
                updateProgressBar();
                updateNavigationButtons();
            };
            
            const createSubmitButton = () => {
                const submitBtn = document.createElement('button');
                submitBtn.textContent = '回答';
                submitBtn.classList.add('btn', 'btn-primary');
                submitBtn.addEventListener('click', () => submitAnswer());
                submissionArea.appendChild(submitBtn);
            }

            const submitAnswer = (selectedOption = null) => {
                const question = currentQuiz.questions[currentQuiz.currentIndex];
                if (currentQuiz.answeredQuestions.has(question.question)) return;

                let userAnswer;
                let isCorrect = false;

                switch(question.type) {
                    case 'multiple_choice':
                        userAnswer = selectedOption;
                        isCorrect = userAnswer.toLowerCase().trim() === question.answer.toLowerCase().trim();
                        break;
                    case 'multiple_select':
                        userAnswer = Array.from(optionsGridElement.querySelectorAll('.option-button.selected')).map(btn => btn.dataset.option);
                        isCorrect = userAnswer.length === question.answer.length && userAnswer.every(val => question.answer.includes(val)) && question.answer.every(val => userAnswer.includes(val));
                        break;
                    case 'fill_in_the_blank':
                        userAnswer = document.getElementById('fillInBlankInput').value;
                        isCorrect = userAnswer.toLowerCase().trim() === question.answer.toLowerCase().trim();
                        break;
                    case 'sorting':
                        userAnswer = Array.from(document.getElementById('sortingTarget').querySelectorAll('.sorting-item')).map(item => item.textContent);
                        isCorrect = JSON.stringify(userAnswer) === JSON.stringify(question.items);
                        break;
                }
                
                showFeedback(isCorrect, question);
            };

            const showFeedback = (isCorrect, question) => {
                optionsGridElement.querySelectorAll('button, input, .sorting-item').forEach(el => {
                    el.disabled = true;
                    if (el.classList.contains('sorting-item')) el.draggable = false;
                });
                submissionArea.innerHTML = '';
                feedbackMessageElement.style.display = 'block';

                if (isCorrect) {
                    playSound('correct');
                    feedbackResultElement.innerHTML = `<strong>正解！</strong>`;
                    feedbackMessageElement.classList.add('correct-feedback');
                    currentQuiz.score++;
                } else {
                    playSound('incorrect');
                    let correctAnswerText = question.answer;
                    if (Array.isArray(question.answer)) correctAnswerText = question.answer.join(', ');
                    if (question.type === 'sorting') correctAnswerText = question.items.join(' → ');
                    
                    feedbackResultElement.innerHTML = `<strong>不正解...</strong> 正解は「${correctAnswerText}」でした。`;
                    feedbackMessageElement.classList.add('incorrect-feedback');
                }
                
                currentQuiz.answeredQuestions.add(question.question);

                if (question.type === 'multiple_choice' || question.type === 'multiple_select') {
                    optionsGridElement.querySelectorAll('.option-button').forEach(button => {
                        const isAnswer = Array.isArray(question.answer) ? question.answer.includes(button.dataset.option) : button.dataset.option === question.answer;
                        if (isAnswer) button.classList.add('correct');
                        if (button.classList.contains('selected') && !isAnswer) button.classList.add('incorrect');
                    });
                } else if(question.type === 'fill_in_the_blank') {
                    document.getElementById('fillInBlankInput').classList.add(isCorrect ? 'correct' : 'incorrect');
                }

                if (question.explanation) {
                    explanationTextElement.textContent = question.explanation;
                    toggleExplanationButton.classList.remove('hidden');
                }
                updateNavigationButtons();
            };
            
            const addDragAndDropListeners = () => {
                const items = document.querySelectorAll('.sorting-item');
                const containers = [document.getElementById('sortingSource'), document.getElementById('sortingTarget')];
                let draggedItem = null;

                items.forEach(item => {
                    item.addEventListener('dragstart', () => {
                        draggedItem = item;
                        setTimeout(() => item.classList.add('dragging'), 0);
                    });
                    item.addEventListener('dragend', () => {
                        draggedItem.classList.remove('dragging');
                    });
                });

                containers.forEach(container => {
                    container.addEventListener('dragover', e => {
                        e.preventDefault();
                        const afterElement = getDragAfterElement(container, e.clientY);
                        if (afterElement == null) {
                            container.appendChild(draggedItem);
                        } else {
                            container.insertBefore(draggedItem, afterElement);
                        }
                    });
                });
            };

            const getDragAfterElement = (container, y) => {
                const draggableElements = [...container.querySelectorAll('.sorting-item:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            };


            const updateNavigationButtons = () => {
                const question = currentQuiz.questions[currentQuiz.currentIndex];
                if (!question) {
                    nextButton.disabled = true;
                    return;
                }
                nextButton.disabled = !currentQuiz.answeredQuestions.has(question.question);
                nextButton.textContent = (currentQuiz.currentIndex === currentQuiz.questions.length - 1 && !nextButton.disabled) ? '結果を見る' : '次の問題';
            };

            const updateProgressBar = () => {
                if (!showProgress) {
                    progressBarContainer.style.display = 'none';
                    progressText.style.display = 'none';
                    return;
                }
                progressBarContainer.style.display = 'block';
                progressText.style.display = 'block';
                const total = currentQuiz.questions.length;
                const progress = total > 0 ? (currentQuiz.currentIndex + 1) / total : 0;
                progressBar.style.width = `${progress * 100}%`;
                progressText.textContent = `${currentQuiz.currentIndex + 1} / ${total} 問目`;
            };

            const showQuizResult = () => {
                switchScreen('result');
                const total = currentQuiz.questions.length;
                finalScore.textContent = `あなたのスコア: ${currentQuiz.score} / ${total}`;
                const percentage = total === 0 ? 0 : (currentQuiz.score / total) * 100;
                let comment = '';
                if (currentQuiz.score === total && total > 0) {
                    comment = '素晴らしい！全問正解です！🎉';
                    playSound('fanfare');
                    setTimeout(launchConfetti, 100);
                } else if (percentage >= 80) {
                    comment = 'よくできました！この調子で頑張りましょう！✨';
                } else if (percentage >= 50) {
                    comment = 'もう少しです！復習して、さらに上を目指しましょう！👍';
                } else {
                    comment = '頑張ろう！基礎をしっかり固めていきましょう！💪';
                }
                scoreComment.textContent = comment;
            };

            const launchConfetti = () => {
                if (confettiAnimationId) cancelAnimationFrame(confettiAnimationId);
                confettiContainer.innerHTML = '';
                const confettiPieces = [];
                const numConfetti = 100;
                const colors = ['#f43f5e', '#38bdf8', '#fbbf24', '#34d399', '#8b5cf6'];
                for (let i = 0; i < numConfetti; i++) {
                    const confetti = document.createElement('div');
                    confetti.classList.add('confetti');
                    confetti.style.backgroundColor = colors[i % colors.length];
                    confettiContainer.appendChild(confetti);
                    const piece = { element: confetti, x: confettiContainer.clientWidth / 2, y: confettiContainer.clientHeight, vx: (Math.random() - 0.5) * 10, vy: -Math.random() * 15 - 5, rotation: Math.random() * 360, rotationSpeed: (Math.random() - 0.5) * 20 };
                    confettiPieces.push(piece);
                }
                let startTime = null;
                function animate(timestamp) {
                    if (!startTime) startTime = timestamp;
                    let allOffScreen = true;
                    confettiPieces.forEach(p => {
                        p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.vx *= 0.99; p.rotation += p.rotationSpeed;
                        if (p.y < confettiContainer.clientHeight + 20) allOffScreen = false;
                        p.element.style.transform = `translate(${p.x}px, ${p.y}px) rotate(${p.rotation}deg)`;
                    });
                    if (allOffScreen && (timestamp - startTime) > 1000) {
                        cancelAnimationFrame(confettiAnimationId);
                    } else {
                        confettiAnimationId = requestAnimationFrame(animate);
                    }
                }
                confettiAnimationId = requestAnimationFrame(animate);
            };

            // --- Settings Functions ---
            const applyColors = (themeName, isDark) => {
                 const root = document.documentElement;
                 const themes = {
                    'default': { '--accent-primary': '#0ea5e9', '--accent-primary-hover': '#0284c7', '--accent-primary-shadow': 'rgba(14, 165, 233, 0.3)', '--themed-text-color': isDark ? '#e0f2fe' : '#0c4a6e' },
                    'red': { '--accent-primary': '#ef4444', '--accent-primary-hover': '#dc2626', '--accent-primary-shadow': 'rgba(239, 68, 68, 0.3)', '--themed-text-color': isDark ? '#fca5a5' : '#991b1b' },
                    'green': { '--accent-primary': '#10b981', '--accent-primary-hover': '#059669', '--accent-primary-shadow': 'rgba(16, 185, 129, 0.3)', '--themed-text-color': isDark ? '#a7f3d0' : '#065f46' },
                    'indigo': { '--accent-primary': '#6366f1', '--accent-primary-hover': '#4f46e5', '--accent-primary-shadow': 'rgba(99, 102, 241, 0.3)', '--themed-text-color': isDark ? '#c7d2fe' : '#4338ca' }
                 };
                 const theme = themes[themeName] || themes.default;
                 Object.entries(theme).forEach(([prop, value]) => root.style.setProperty(prop, value));
                 root.style.setProperty('--progress-bar-bg', root.style.getPropertyValue('--accent-primary'));
            };
            
            const setDarkMode = (isDark) => {
                document.body.classList.toggle('dark-mode', isDark);
                localStorage.setItem('qube_darkMode', isDark);
                applyColors(localStorage.getItem('qube_themeColor') || 'default', isDark);
            };

            const setThemeColor = (themeName) => {
                localStorage.setItem('qube_themeColor', themeName);
                applyColors(themeName, document.body.classList.contains('dark-mode'));
            };

            // --- File Upload Logic ---
            const handleFileSelect = async (files) => {
                if (!files || files.length === 0) return;

                const filePromises = Array.from(files).map(file => {
                    return new Promise((resolve, reject) => {
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve({ name: file.name, type: 'image', content: e.target.result });
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        } else if (file.type === 'application/pdf') {
                            const loadingTask = pdfjsLib.getDocument(URL.createObjectURL(file));
                            loadingTask.promise.then(async (pdf) => {
                                let text = '';
                                for (let i = 1; i <= pdf.numPages; i++) {
                                    const page = await pdf.getPage(i);
                                    const textContent = await page.getTextContent();
                                    text += textContent.items.map(item => item.str).join(' ');
                                }
                                resolve({ name: file.name, type: 'pdf', content: text });
                            }).catch(reject);
                        } else if (file.type.startsWith('text/')) {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve({ name: file.name, type: 'text', content: e.target.result });
                            reader.onerror = reject;
                            reader.readAsText(file);
                        } else {
                            resolve(null); // Ignore unsupported files
                        }
                    });
                });

                try {
                    const results = await Promise.all(filePromises);
                    uploadedFiles.push(...results.filter(r => r !== null));
                    updateUIAfterFileUpload();
                } catch (err) {
                    alert('ファイルの読み込みに失敗しました: ' + err.message);
                    resetUploadUI();
                }
            };

            const updateUIAfterFileUpload = () => {
                filePreviewContainer.innerHTML = '';
                uploadedFiles.forEach((file, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'file-preview-item';

                    if (file.type === 'image') {
                        const img = document.createElement('img');
                        img.src = file.content;
                        itemDiv.appendChild(img);
                    }
                    const p = document.createElement('p');
                    p.className = 'file-name';
                    p.textContent = file.name;
                    itemDiv.appendChild(p);
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-file-btn';
                    removeBtn.innerHTML = '&times;';
                    removeBtn.onclick = () => {
                        uploadedFiles.splice(index, 1);
                        updateUIAfterFileUpload();
                    };
                    itemDiv.appendChild(removeBtn);
                    filePreviewContainer.appendChild(itemDiv);
                });

                if (uploadedFiles.length > 0) {
                    promptLabel.textContent = 'アップロードしたファイルへの追加指示 (任意)';
                    promptText.placeholder = '例: この内容について5問作成してください。';
                } else {
                    resetUploadUI();
                }
            };

            const resetUploadUI = () => {
                uploadedFiles = [];
                filePreviewContainer.innerHTML = '';
                fileUpload.value = ''; // Reset file input
                promptLabel.textContent = 'クイズにしたい内容を入力または貼り付け';
                promptText.placeholder = '例: 日本の首都は東京です。徳川家康は江戸幕府を開きました...';
            };

            // --- Event Listeners ---
            hamburgerButton.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);
            newProjectButton.addEventListener('click', showNewProjectModal);
            getStartedButton.addEventListener('click', showNewProjectModal);
            modalCreateProjectButton.addEventListener('click', handleCreateProject);
            modalCancelProjectButton.addEventListener('click', closeNewProjectModal);
            newProjectModal.addEventListener('click', (e) => { if (e.target === newProjectModal) closeNewProjectModal(); });
            newProjectNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleCreateProject(); });
            
            generateNewQuizBtn.addEventListener('click', () => {
                resetUploadUI();
                promptText.value = '';
                switchScreen('generate');
            });
            backToProjectStartBtn.addEventListener('click', () => setActiveProject(activeProjectId));
            generateQuizButton.addEventListener('click', handleGenerateQuiz);

            startSelectedQuizButton.addEventListener('click', () => {
                const selectedQuizId = quizSelect.value;
                const project = projects.find(p => p.id === activeProjectId);
                if (project) {
                    const quizToStart = project.quizzes.find(q => q.id === selectedQuizId);
                    if (quizToStart) startQuiz(quizToStart);
                }
            });

            // File Drop Area Listeners
            fileDropArea.addEventListener('click', () => fileUpload.click());
            fileUpload.addEventListener('change', (e) => handleFileSelect(e.target.files));
            fileDropArea.addEventListener('dragover', (e) => { e.preventDefault(); fileDropArea.classList.add('dragover'); });
            fileDropArea.addEventListener('dragleave', () => fileDropArea.classList.remove('dragover'));
            fileDropArea.addEventListener('drop', (e) => { e.preventDefault(); fileDropArea.classList.remove('dragover'); handleFileSelect(e.dataTransfer.files); });

            modalCreateQuizButton.addEventListener('click', handleCreateQuiz);
            modalCancelQuizButton.addEventListener('click', closeNameQuizModal);
            nameQuizModal.addEventListener('click', (e) => { if (e.target === nameQuizModal) closeNameQuizModal(); });
            newQuizNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleCreateQuiz(); });

            interruptButton.addEventListener('click', () => interruptModal.classList.add('show'));
            modalCancelInterrupt.addEventListener('click', () => interruptModal.classList.remove('show'));
            modalConfirmInterrupt.addEventListener('click', () => {
                interruptModal.classList.remove('show');
                setActiveProject(activeProjectId);
            });

            nextButton.addEventListener('click', () => { playSound('click'); currentQuiz.currentIndex++; loadQuestion(); });
            toggleExplanationButton.addEventListener('click', () => { explanationContentElement.classList.toggle('show'); toggleExplanationButton.textContent = explanationContentElement.classList.contains('show') ? '解説▲' : '解説▼'; });
            restartQuizButton.addEventListener('click', () => startQuiz(currentQuiz));
            backToProjectButton.addEventListener('click', () => setActiveProject(activeProjectId));
            projectSettingsButton.addEventListener('click', () => switchScreen('settings'));
            backToProjectFromSettings.addEventListener('click', () => setActiveProject(activeProjectId));
            
            // Settings Listeners
            darkModeToggle.addEventListener('change', (e) => setDarkMode(e.target.checked));
            themeColorCircles.forEach(circle => {
                circle.addEventListener('click', () => {
                    themeColorCircles.forEach(c => c.classList.remove('selected'));
                    circle.classList.add('selected');
                    setThemeColor(circle.dataset.theme);
                });
            });
            enableSoundToggle.addEventListener('change', (e) => {
                enableSound = e.target.checked;
                localStorage.setItem('qube_enableSound', String(enableSound));
            });
             questionCountSelect.addEventListener('change', (e) => {
                questionCount = parseInt(e.target.value, 10);
                localStorage.setItem('qube_questionCount', questionCount);
            });
            showProgressToggle.addEventListener('change', (e) => {
                showProgress = e.target.checked;
                localStorage.setItem('qube_showProgress', String(showProgress));
            });
            masteryModeToggle.addEventListener('change', (e) => {
                masteryMode = e.target.checked;
                localStorage.setItem('qube_masteryMode', String(masteryMode));
            });

            // --- Initialization ---
            const init = () => {
                pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
                loadProjects();
                switchScreen('welcome');
                renderProjectList();
                
                // Load Settings
                const isDark = localStorage.getItem('qube_darkMode') === 'true';
                darkModeToggle.checked = isDark;
                const savedTheme = localStorage.getItem('qube_themeColor') || 'default';
                document.querySelector(`.color-circle[data-theme="${savedTheme}"]`)?.classList.add('selected');
                setDarkMode(isDark);

                enableSound = localStorage.getItem('qube_enableSound') !== 'false';
                enableSoundToggle.checked = enableSound;
                questionCount = parseInt(localStorage.getItem('qube_questionCount'), 10) || 5;
                questionCountSelect.value = questionCount;
                showProgress = localStorage.getItem('qube_showProgress') !== 'false';
                showProgressToggle.checked = showProgress;
                masteryMode = localStorage.getItem('qube_masteryMode') === 'true';
                masteryModeToggle.checked = masteryMode;
            };

            init();
        });
    </script>
</body>
</html>
